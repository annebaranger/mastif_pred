---
title: "02_fecundity-hyp"
author: "Anne Baranger"
date: "2023-07-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE,message=FALSE)
library(targets)
lapply(c("stringr","tidyr","dplyr","tibble","data.table", # data analysis
         "ggplot2","viridis", # plot
         "factoextra", "modi", "nlme","rstatix","multcomp","emmeans",# stat & models
         "rworldmap" # geographic data #terre, sf
         ),require,character.only=TRUE)
theme_set(theme_minimal()) # ggplot theme


# load necessary data #

## mastif data ##
# tar_load(mastif.eu,store="target_data")
# tar_load(mastif.am,store="target_data")

## gbif data ##
#tar_load(meanClimate_species,store="target_gbif")


## results from selection ##
# to be nuanced 
tar_load(species_selection,store="target_nfi")

## species selection ##
tar_load(phylo.select,store="target_nfi")

tar_load(sp.select.eu,store="target_nfi")
tar_load(sp.select.am,store="target_nfi")
tar_load(species_class,store="target_nfi")
phylo.select<-phylo.select |> left_join(species_class)


# small format of gbif
df.gbif.short <- species_selection$df.gbif |>
  separate(clim,into = c("clim","range")) |> 
  pivot_wider(names_from = range,
                values_from = clim_niche)

#compute climate range
df.range<-species_selection$df.gbif |> 
    dplyr::select(species,clim,clim_niche) |> 
    filter(grepl("range",clim)) |> 
    separate(clim,into=c("var","drop")) |> 
    dplyr::select(-drop) |> 
    rename(range="clim_niche")

## fecundity data ##
tar_load(fecundity.eu_clim,store="target_nfi")
tar_load(fecundity.am_clim,store="target_nfi")

bolker_ci <- function(model, newdat, pred_int = FALSE, conf_level = 0.95) {
  if(class(model) != "lme") {
    stop("works for lme-models only")
  }
  z <- round(qnorm((1-conf_level)/2, lower.tail = FALSE), 2)
  newdat$pred <- predict(model, newdat, level = 0)
  Designmat <- model.matrix(formula(model)[-2], newdat)
  predvar <- diag(Designmat %*% vcov(model) %*% t(Designmat))
  newdat$se <- sqrt(predvar)
  newdat$ci_l <- newdat$pred - z*newdat$se
  newdat$ci_h <- newdat$pred + z*newdat$se
  if(pred_int == TRUE) {
    newdat$se2 <- sqrt(predvar+model$sigma^2)
    newdat$predint_l <- newdat$pred - z*newdat$se2
    newdat$predint_h <- newdat$pred + z*newdat$se2
  }
  newdat
}

worldmap <- sf::st_as_sf(getMap(resolution = "high"))

```

# Data description
mastif.am/eu
- df.alltree : raw obs of mastif, not filtered, but reformated and with climate extraction
- df.allplot : plot IDs from df.alltree
- df.species.select : filtering of species based on a minimum of observations
- df.tree: raw obs only for selected species

species_selection 
 - df.gbif - niche by species, reformated for use with mastif
 - df.tree_w all tree (in df.tree) with computed weight
 - mastif.range - niche according to mastif plots with the use of weight
 - sp.select.am
 - sp.select.eu

df.nfi.eu/am -  plot of nfi, with size, climate

nfi.eu/am_clim
 - acp of climate variables
 - plots of nfi + etc + predictions of pca first axis

fec.eu/am
 - for each nfi plot, ba/ISP/fecmu/sd and weight of each plot -> scaled to the hectare, long format. all species represented on each plots even if absent

sp.margin.eu/am
 - for each species of the nfi, compute the quantile of pca first axis

fecundity.eu_clim
 - fecundity coupled with climate of plots, and condition of margin

-> fecundity datasets are long formats of nfi plots crossed by species list. It includes non-occurence of species.

# Map of data

## Plots sample

```{r plots10}
# plots of selected species
rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  mutate(dh=12*pet-map) |> 
  filter(BA!=0) |> 
  dplyr::select(plot,lat,lon,sgdd,wai,dh,mat,map) |> 
  unique() |> 
  sample_frac(0.1) |> 
  ggplot() +
  geom_sf(data=worldmap,fill=NA) +
  geom_point(aes(x=lon,y=lat,color=mat))+
  xlim(-135,24) + 
  ylim(27,73)+
  theme_minimal()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        legend.position = "none")+
  ggtitle("10 % of NFI plots")

```


## Check repartition of species climate in their continent

```{r nfi_check}
fecundity.eu_clim |> 
  group_by(plot) |> 
  mutate(occ=(sum(BA>0)!=0)) |> 
  dplyr::select(plot,occ,PC1,PC2) |> unique() |> 
  ungroup() |> 
  # sample_n(50000) |> 
  ggplot(aes(PC1,PC2,color=occ))+
  geom_point()+
  facet_wrap(~occ)

fecundity.am_clim |> 
  group_by(plot) |> 
  mutate(occ=(sum(BA>0)!=0)) |> 
  dplyr::select(plot,occ,PC1,PC2) |> unique() |> 
  ungroup() |> 
  # sample_n(50000) |> 
  ggplot(aes(PC1,PC2,color=occ))+
  geom_point()+
  facet_wrap(~occ)
```
## Climate pattern among continents

```{r climcont}
clim.acp=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  left_join(phylo.select) |> 
  group_by(zone) |> 
  sample_n(size = 10000) |> 
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  dplyr::select(plot,zone,taxa,species,lon,lat,mat,tmin,map,pmax,sgdd,pet,cmi_min,cmi_mean,cmi_max,wai) |> 
  mutate(dh=12*pet-map) |> 
  unique() |> 
  drop_na()
acp=prcomp(clim.acp[,7:17],scale=TRUE)
# fviz_pca_ind(acp)
# fviz_pca_var(acp,axes=c(1,3))

pca.plot=fviz_pca(acp,
         axes=c(1,2),
         geom.ind="point",
         geom.var=c("arrow","text"),
         palette=c("firebrick1","slateblue","firebrick4"),
         habillage=clim.acp$zone,
         col.var="black",
         alpha.ind=0.05,
         addEllipses=TRUE,
         title="")
pca.plot

clim.acp |> 
  ggplot(aes(dh,color=zone))+
  geom_density()+
  scale_color_manual(values=c("firebrick1","slateblue","firebrick4"))
# cbind(clim.acp,
#       acp$x[,1:2]) |> 
#   filter(PC1<(-5)) |> 
#   filter(zone=="west") |> 
#   ggplot()+
#   geom_point(aes(x=lon,y=lat))+
#   geom_sf(data=worldmap,fill=NA)

rm(clim.acp,acp,pca.plot)
```



## Comparison of margins between variables


```{r marginvar}
sp.sgddwai=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  dplyr::select(plot,lon,lat,species,BA,fecGmMu,fecGmSd,sgdd,wai,block,zone) |> 
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.1)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.6)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.4)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.9)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.1)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.6)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.4)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.9)[[1]]~"humid"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("midtemp","cold","hot")),
         margin.wai=factor(margin.wai,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.sgdd)&!is.na(margin.wai)) |> 
  filter(zone=="europe")


sp.dhmat=rbind(fecundity.eu_clim |> mutate(block="europe"),
               fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  dplyr::select(plot,lon,lat,species,BA,fecGmMu,fecGmSd,sgdd,wai,pet,map,mat,block,zone) |> 
  filter(BA!=0) |> #rm absences
  mutate(dh=12*pet-map) |> 
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.temp=case_when(mat<weighted.quantile(mat,w=BA, prob=0.1)[[1]]~"cold",
                               mat<weighted.quantile(mat,w=BA, prob=0.6)[[1]]&
                                 mat>weighted.quantile(mat,w=BA, prob=0.4)[[1]]~"midtemp",
                               mat>weighted.quantile(mat,w=BA, prob=0.9)[[1]]~"hot"),
         margin.deficit=case_when(dh>weighted.quantile(dh,w=BA, prob=0.1)[[1]]~"arid",
                              dh<weighted.quantile(dh,w=BA, prob=0.6)[[1]]&
                                 dh>weighted.quantile(dh,w=BA, prob=0.4)[[1]]~"midhum",
                               dh<weighted.quantile(dh,w=BA, prob=0.9)[[1]]~"humid"),
         cor.mat.dh=cor(dh,mat,use="complete.obs")) |>
  mutate(margin.temp=factor(margin.temp,levels=c("midtemp","cold","hot")),
         margin.deficit=factor(margin.deficit,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.temp)&!is.na(margin.deficit)) |> 
  ungroup()  |> 
  filter(zone=="europe")

a<-sp.dhmat |> 
  filter(margin.deficit=="humid") |> #margin.temp=="hot"&
  ggplot()+
  geom_point(aes(x=lon,y=lat,color=species))+
  geom_sf(data=worldmap,fill=NA)+
  xlim(c(-10,35))+
  ylim(lim.eu.y)
b<-sp.sgddwai |> 
  filter(margin.wai=="humid") |> #margin.sgdd=="hot"&
  ggplot()+
  geom_point(aes(x=lon,y=lat,color=species))+
  geom_sf(data=worldmap,fill=NA)+
  xlim(c(-10,35))+
  ylim(lim.eu.y)
cowplot::plot_grid(a,b)

# rbind(fecundity.eu_clim |> mutate(block="europe"),
#                  fecundity.am_clim|> mutate(block="america")) |>
#   mutate(dh=12*pet-map) |> 
#   left_join(phylo.select) |> 
#   filter(BA!=0) |> 
#   ggplot(aes(wai,dh))+
#   geom_point()

rm(sp.sgddwai,sp.dhmat,a,b)
```

## Effect of different clim variables on fecundity
```{r marginvar2, eval=FALSE, include=FALSE}
var.target="dh"
var.comp=data.frame(var=c("mat","tmin","map","pmax","sgdd",
                          "cmi_min","cmi_mean","cmi_max","wai","dh"),
                    ef.low=NA,
                    pval.low=NA,
                    ef.up=NA,
                    pval.up=NA,
                    AIC=NA)
for(var.target in var.comp$var){
  tryCatch({
    print(var.target)
    var.effect=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
      filter(BA!=0) |> #rm absences
      # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
      mutate(dh=pet-map) |> 
      mutate(var:=!!sym(var.target)) |> 
      dplyr::select(species,BA,ISP,var) |> 
      mutate(margin=case_when(var<weighted.quantile(var,w=BA, prob=0.05)[[1]]~"low",
                              var<weighted.quantile(var,w=BA, prob=0.525)[[1]]&
                                var>weighted.quantile(var,w=BA, prob=0.475)[[1]]~"mid",
                              var>weighted.quantile(var,w=BA, prob=0.95)[[1]]~"up")) |> 
      filter(!is.na(margin)) |> 
      mutate(ISP=scale(log(ISP)),
             margin=factor(margin,levels=c("mid","low","up")))
    ggplot(var.effect,aes(margin,ISP))+geom_boxplot()+ggtitle(label = var.target)->a
    print(a)
    mod=lme(ISP~margin,random=~1|species,data=var.effect)
    summary(mod)$tTable->a
    a<-as.data.frame(a) |> rownames_to_column(var="coef")
    var.comp[var.comp$var==var.target,2:6]= 
      c(a[a$coef=="marginlow","Value"],
        a[a$coef=="marginlow","p-value"],
        a[a$coef=="marginup","Value"],
        a[a$coef=="marginup","p-value"],
        summary(mod)$AIC)},
    error=function(e){print("error")}
    )
}


```



# H1 : fecundity is higher in humid and hot margins

_Formatting data_ 
Fecundity datasets of Europe and North america are bound. For each species I computed the 10th, 45th, 55th and 90th percentiles, to delimit marginal and core zones over, MAT, DH, WAI and SGDD variables. Percentiles were computed using as a weight the inverse of the basal area.
Correlation between WAI and SGDD were computed for each species distribution.


Analysis are performed on ISP (but maybe try on absolute fec). When all species together, ISP is scaled and logged only over observations in margins (and center).
Because of extreme values, species ISP distributions are very different.

```{r data_lmer}
sp.dataset=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  mutate(dh=12*pet-map) |> 
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.temp=case_when(mat<weighted.quantile(mat,w=BA, prob=0.1)[[1]]~"cold",
                               mat<weighted.quantile(mat,w=BA, prob=0.6)[[1]]&
                                 mat>weighted.quantile(mat,w=BA, prob=0.4)[[1]]~"midtemp",
                               mat>weighted.quantile(mat,w=BA, prob=0.9)[[1]]~"hot"),
         margin.deficit=case_when(dh<weighted.quantile(dh,w=BA, prob=0.1)[[1]]~"humid",
                              dh<weighted.quantile(dh,w=BA, prob=0.6)[[1]]&
                                 dh>weighted.quantile(dh,w=BA, prob=0.4)[[1]]~"midhum",
                               dh>weighted.quantile(dh,w=BA, prob=0.9)[[1]]~"arid"),
         margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.1)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.6)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.4)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.9)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.1)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.6)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.4)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.9)[[1]]~"humid"),
         cor.mat.dh=cor(dh,mat,use="complete.obs"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  pivot_longer(cols=c("margin.deficit","margin.temp","margin.sgdd","margin.wai"),
               names_to="margin.type",
               values_to="margin.val") |> 
  mutate(margin.val=factor(margin.val,levels=c("midtemp","cold","hot","midhum","arid","humid")),
         block=factor(block,levels=c("america","europe"))) |> 
         # ISP=(ISP-weighted.mean(ISP,w=1/cv_plot))/sqrt(weighted.var(ISP,w=1/cv_plot))) |>
  filter(margin.type %in% c("margin.deficit","margin.temp")) |> 
  # filter(margin.type %in% c("margin.sgdd","margin.wai")) |> 
  filter(!is.na(margin.val)) |> # position importante pour le scaling!!
  ungroup() |> 
  mutate(ISP=scale(log(ISP))) |> 
  as.data.table()

```



_Hypothesis_

Fecundity has been shown to be higher in the southeastern part of North America (Sharma 2022). We want to generalize this trend to the scale of American and European tree species. We test therefore that fecundity is higher in the hot margin and in the humid margin of tree species niche.

Test: with ISP logged and scaled/centered over all species, we test independently the effect of both margin types, with a random effect on species. We expect that coefficient associated with hot margin and humid margin would be significantly positive. Note that observations are weigthed by the coefficient of variation of the fecundity model predictions.



## Preliminary figures

Prior to testing the model, we plotted few observations of the data.


In the following is plotted the distribution of ISP in margin and core area of each species. ISP has been logged and scaled/centered.

```{r IspDistrib, fig.cap="Distribution of ISP, logged and scaled all species together"}
sp.dataset |> 
  ggplot()+
  geom_density(aes(ISP,color=species))+
  theme(legend.position = "none")
  # scale_x_log10()
```

The comparison of fecundity between both continent shows higher ISP in Europe then America. This could be caused by the species sampling.

```{r continent.distrib, fig.cap="Boxplots of ISP scaled over all species, depending on continent"}
stat.data<-rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  ungroup() |>
  mutate(ISP=scale(log(ISP))) |>
  dplyr::select(ISP,block,cv_plot)

stat.test<-stat.data |> 
  t_test(ISP~block) |> 
  add_significance() |> 
  add_xy_position(x = "block")

stat.data |> 
  ggplot()+ #,weight=1/cv_plot
  geom_boxplot(aes(block,ISP,fill=block),outlier.colour = NA)+ # not working if aes is directly in ggplot
  ggpubr::stat_pvalue_manual(stat.test,label="t-test {p.signif}",tip.length = 0)+
  theme(legend.position = "none",
        axis.title.x = element_blank())+
  scale_fill_manual(values=c("firebrick3","cornflowerblue"))->p
p
# ggsave("continent_comp.pdf",plot=p)
rm(stat.data,stat.test)
```


Then, the boxplots show the distribution of ISP in each margins, for each continent and margin types. Overall, fecundity seems higher in Europe. Fecundity is slightly higher in hot and humid margins than in core and cold/arid margin. Because ISP is scaled all species together, the ranking in ISP between species is conserved. This means that overall species are more fecund in Europe

```{r margin.dif}
sp.dataset |>  
  ggplot()+
  geom_boxplot(aes(margin.val,ISP,color=zone,weight=1/cv_plot))+
  scale_color_manual(values=c("firebrick1","slateblue","firebrick4"))+
  facet_wrap(~margin.type,scales="free_x")
```

We performed the same analysis per species. For many species, fecundity is higher in hot margin, but for some the trend is reverse,ie Quercus ilex & Pinus pinea. This could be because these species are distributed in dry areas where the hot margin is too dry to maintain high fecundity.
When performing the analysis for wai, results are more difficult to analyse with some species with higher fecunditiy in humid margins (ie. Q ilex & P pinea) butothers with higher fecundity in dry margins (ie Abies alba & Q robur). This could be because of interactions between wai and sgdd effects.

```{r margin.diff.species, fig.cap="Boxplots of ISP logged and scaled by species, for each margin type of sgdd" }
sp.dataset|>  
  filter(margin.type=="margin.temp") |> 
  ggplot()+
  geom_boxplot(aes(margin.val,ISP,color=block,weight=1/cv_plot))+
  facet_wrap(~species,scales="free")
```

## LMM per margins, with continent effect

1 model for each margin type.
Each model shows that the margin tested has an effect on fecundity.

```{r lmmPerMarginTemp}
# for SGDD #

# run lmer model
sp.mod=sp.dataset |> filter(margin.type=="margin.temp") |> 
  mutate(margin.val=factor(margin.val,levels=c("cold","midtemp","hot")))
sp.mod |> 
  group_by(species,margin.val) |> 
  summarise(n=n())
mod.lme=lme(ISP~margin.val*zone,random=~1|species,weights=varFixed(~cv_plot),data=sp.mod)
summary(mod.lme)$tTable
anova(mod.lme)


# graphs of observations

sp.mod |> 
  mutate(margin.val=factor(margin.val,levels=c("cold","midtemp","hot","arid","midhum","humid"))) |> 
  ggplot(aes(margin.val,ISP))+
  geom_boxplot(aes(weight=1/cv_plot,color=zone))+
  scale_color_manual(values=c("firebrick1","slateblue","firebrick4"))


# predictions with bolker interval
# data.predict=sp.mod |> 
#   dplyr::select(block,margin.val) |> 
#   unique()
# 
# data.predict<-bolker_ci(mod.lme,data.predict)
# 
# 
# data.predict |> 
#   mutate(margin.val=if_else(margin.val=="midtemp","Core",
#                             stringr::str_to_title(margin.val))) |> 
#   ggplot(aes(color=block))+
#   geom_point(aes(margin.val,pred))+
#   geom_segment(aes( x = margin.val,xend=margin.val,y=ci_l,yend=ci_h))+
#   scale_color_manual(values=c("firebrick3","cornflowerblue"))+
#   labs(x="Margin relative to the SGDD gradient",
#        y="Predictions",
#        color="Continent")->p
# p
# ggsave("sgddmargin.pdf",plot=p)

mod.means=emmeans(object=mod.lme,
        specs=~margin.val*zone)
data_pred=cld(object=mod.means,
    adjust="Tukey",
    Letters=letters,
    alpha=0.05)
adjust_width <- 0.05  # valeur à ajuster selon vos besoins

data_pred_adj <- as.data.frame(data_pred) %>%
  mutate(margin.val = if_else(margin.val == "midtemp", "Core", stringr::str_to_title(margin.val)),
         x_adjusted = as.numeric(as.factor(margin.val))/4 + 
           if_else(zone == "east", adjust_width, 0) +
           if_else(zone == "west", -adjust_width, 0))

ggplot(data_pred_adj, aes(color = zone)) +
  geom_point(aes(x_adjusted, emmean)) +
  geom_segment(aes(x = x_adjusted, xend = x_adjusted, y = lower.CL, yend = upper.CL)) +
  scale_color_manual(values=c("firebrick1","slateblue","firebrick4"))+
  geom_text(aes(label = stringr::str_trim(.group), x = x_adjusted, y = emmean), hjust = 1.5) +
  labs(x = "Margin relative to the MAT gradient",
       y = "Predictions",
       color = "Continent") +
  scale_x_continuous(breaks = as.numeric(as.factor(unique(data_pred_adj$margin.val)))/4, 
                     labels = unique(data_pred_adj$margin.val))->q
q
# ggsave(filename="sgddmargin_tukey.pdf",scale=1.8,width=15,height=8,units="cm",plot=q)
```


```{r lmmPerMarginDH}
# for WAI #
sp.mod=sp.dataset |> filter(margin.type=="margin.deficit") |> 
    mutate(margin.val=factor(margin.val,levels=c("arid","midhum","humid")))  


mod.lme=lme(ISP~margin.val*zone,random=~1|species,weights=varFixed(~cv_plot),data=sp.mod)
summary(mod.lme)$tTable
anova(mod.lme)
sp.mod |> 
  mutate(margin.val=factor(margin.val,levels=c("cold","midtemp","hot","arid","midhum","humid"))) |> 
  ggplot(aes(margin.val,ISP))+
  geom_boxplot(aes(weight=1/cv_plot,color=zone))

# ggsave("waimargin.pdf",plot=p)
mod.means=emmeans(object=mod.lme,
        specs=~margin.val*zone)
data_pred=cld(object=mod.means,
    adjust="Tukey",
    Letters=letters,
    alpha=0.05)
adjust_width <- 0.05  # valeur à ajuster selon vos besoins

data_pred_adj <- as.data.frame(data_pred) %>%
  mutate(margin.val = if_else(margin.val == "midhum", "Core", stringr::str_to_title(margin.val)),
         x_adjusted = as.numeric(as.factor(margin.val))/4 + 
           if_else(zone == "east", adjust_width, 0) +
           if_else(zone == "west", -adjust_width, 0))

ggplot(data_pred_adj, aes(color = zone)) +
  geom_point(aes(x_adjusted, emmean)) +
  geom_segment(aes(x = x_adjusted, xend = x_adjusted, y = lower.CL, yend = upper.CL)) +
  scale_color_manual(values=c("firebrick1","slateblue","firebrick4"))+
  geom_text(aes(label = str_trim(.group), x = x_adjusted, y = emmean), hjust = 1.5) +
  labs(x = "Margin relative to the water deficit gradient",
       y = "Predictions",
       color = "Continent") +
  scale_x_continuous(breaks = as.numeric(as.factor(unique(data_pred_adj$margin.val)))/4, 
                     labels = unique(data_pred_adj$margin.val))->q
q
# ggsave(filename="waimargin_tukey.pdf",scale=1.8,width=15,height=8,units="cm",plot=q)
  


rm(mod.lme,sp.mod)
summary(mod.means)
```



# Hypothesis 2 : fecundity is even higher when the hot margin is also humid.
_Hypothesis_
Some margins combine two effects of marginality: for example, they are at the dry end of the water deficit gradient and at the warm end of the temperature. It is assumed that the combination of two margin effects can have a compounding impact on fecundity. In particular, in our second hypothesis, we assume that fecundity will be higher the more species are in extremes of heat and humidity within their margin. We assume that this effect is greatest in America, where the climatic space allows for the occurrence of hotter and more humid zones.

Test : there is a different pattern between continent because of difference in climatic space
-> correlation between sgdd/wai is higher in species distribution of america
-> 

## Preliminary figures


Using a 2D representation we plotted variation of fecundity among the mat/dh space, in order to catch the effect of correlation between dh and mat.

```{r 2Drepr, fig.cap="2D representation of fecundity variation in mat/dh space, for Europe"}

fecundity.eu_clim |> 
  mutate(block="europe") |>
  left_join(phylo.select) |> 
  mutate(dh=12*pet-map) |> 
  filter(BA!=0) |>
  mutate(ISP=scale(log(ISP)),
         fecGmMu=scale(log(fecGmMu))) |> 
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot),
         dh=cut(dh,breaks=20),
         mat=cut(mat,breaks=20)) |> # compute cv for missing values
  ungroup() |> group_by(species,dh,mat) |> 
  mutate(ISP.mean=weighted.mean(ISP,w=1/cv_plot)) |> 
  ungroup() |>
  dplyr::select(species,mat,dh,ISP.mean,cv_plot) |> 
  ggplot(aes(x = mat, y = dh, fill = ISP.mean)) +
  geom_tile() +
  scale_fill_gradientn(colours = viridis(15))+
  theme(axis.text = element_blank())+
  facet_wrap(~species,scales="free")->p
p
# ggsave("2Dfecundity.pdf",plot=p)
```
Idem all species together and considering only margins and core areas.

```{r 2Dreprmargin, eval=FALSE, include=FALSE}
rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
# fecundity.eu_clim |>
  # mutate(block="europe") |> 
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"cold-dry",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"cold-int",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"cold-hum",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"int-dry",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"int-int",
                                sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"int-hum",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"hot-dry",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"hot-int",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"hot-hum")) |> 
  filter(!is.na(margin)) |> # position importante pour le scaling!!
  mutate(cor.wai.sgdd=cor(wai,sgdd,use="complete.obs"),
         margin=factor(margin,levels=c("cold-dry","cold-int","cold-hum","int-dry","int-int","int-hum","hot-dry","hot-int","hot-hum"))) |> 
  mutate(ISP=scale(log(ISP))) |> 
  ungroup() |>
  group_by(species,margin) |> summarise(mean.ISP=mean(ISP,na.rm = TRUE)) |> 
  separate(margin,sep="-",into=c("sgdd","wai")) |> 
  mutate(sgdd=factor(sgdd,levels=c("cold","int","hot")),
         wai=factor(wai,levels=c("hum","int","dry"))) |> 
  # filter(species %in% species.sample) |> 
  ggplot(aes(sgdd,wai,fill=mean.ISP))+
  geom_tile()+
  scale_fill_gradientn(colours = viridis(15))+
  facet_wrap(~species)
```

```{r 2DrepN}
sp.dataset|>  
  pivot_wider(names_from = margin.type,values_from = margin.val) |> 
    filter(!is.na(margin.deficit)) |> filter(!is.na(margin.temp)) |> 
  group_by(species,margin.deficit,margin.temp) |> 
  summarise(n=n()) |>
  ungroup() |> group_by(species) |> 
  mutate(n=scale(n)) |> 
  ggplot(aes(margin.deficit,margin.temp,fill=n))+
  geom_tile()+
  scale_fill_gradientn(colours = viridis(15))+
  facet_wrap(~species)

sp.dataset|>  
  pivot_wider(names_from = margin.type,values_from = margin.val) |>  
  filter(!is.na(margin.deficit)) |> filter(!is.na(margin.temp)) |> 
  group_by(zone,margin.deficit,margin.temp) |> 
  summarise(n=n()) |>
  ungroup() |> group_by(zone) |>
  mutate(n=scale(n)) |>
  ggplot(aes(margin.deficit,margin.temp,fill=n))+
  geom_tile()+
  scale_fill_gradientn(colours = viridis(15))+
  facet_wrap(~zone)




```



One key point is that correlation between wai/sgdd in species distribution might be different between continent.
<!-- Weight lacking in computation, but should only be weighted by BA and not cv_plot!! -->
Sgdd/wai are analysed with correlation with all observation and with observation only in margins.

```{r cor.dif, fig.cap="Comparison of correlation wai/sgdd between continent"}
# investigating ddiference in wai/sgdd correlation between continents

sp.ttest<-sp.dataset |> 
  dplyr::select(species,cor.mat.dh,zone) |> 
  unique()

# correlation computed on whole dataset
sp.ttest |> 
  ggplot(aes(cor.mat.dh,color=zone))+
  geom_density()+
  labs(x="Correlation WAI/SGDD inside species distribution",
       color="Continent",
       y="")->p
p

# ggsave("contcor.pdf",plot=p)
# correlation computed only on margins obs
sp.dataset |> 
  group_by(species) |> 
  mutate(cor.mat.dh=cor(dh,mat,use="complete.obs")) |> 
  dplyr::select(species,cor.mat.dh,zone) |> 
  unique()|> 
  ggplot(aes(cor.mat.dh,color=zone))+
  geom_density()+
  scale_color_manual(values=c("firebrick1","slateblue","firebrick4"))

# t.test(sp.ttest[sp.ttest$block=="america","cor.wai.sgdd"],
#        sp.ttest[sp.ttest$block=="europe","cor.wai.sgdd"])


rm(sp.ttest)
```


Using boxplot for a selection of few species, we can highlight that trend of fecundity in one of the sgdd margin, differs according to the corresponding wai margin.

```{r InteractionsFig, fig.cap="Interactions between margin types for few species"}
species.sample= c(sample(unique(fecundity.eu_clim$species),6),
                  sample(unique(fecundity.am_clim$species),6))

sp.dataset|>  
  pivot_wider(names_from = margin.type,values_from = margin.val) |>  
  filter(!is.na(margin.deficit)) |> filter(!is.na(margin.temp)) |> 
  filter(species %in% species.sample) |> 
  ggplot(aes(margin.temp,ISP,weight=1/cv_plot,color=margin.deficit))+
  geom_boxplot()+
  facet_wrap(~species,scales="free")
```

All species together : 

```{r lmmInteractionsFig, fig.cap="Interactions per continent, from the sgdd axis" }
sp.dataset|>  
  pivot_wider(names_from = margin.type,values_from = margin.val) |> 
  filter(!is.na(margin.deficit)) |> filter(!is.na(margin.temp)) |> 
  filter(margin.temp=="hot") |> 
  ungroup() |> 
  filter(species %in% species.sample) |> 
  ggplot(aes(margin.deficit,ISP,weight=1/cv_plot,color=zone))+
  geom_boxplot()
```

## LMM with interactions between margins

The test was performed using two design of data. First with the same data as in the lmm per margin. All species that were only in one type of extreme margins were attributed to the center. The second design was built by using larger quantiles in order to have more data matching both margin types.

### NLME 
```{r lmmInteractions, eval=FALSE, include=FALSE}
# First design: datasets with all data of margins
# sp.mod=sp.dataset |>
#   pivot_wider(names_from = "margin.type",
#               values_from = "margin.val") |> 
#   # mutate(across(matches("margin"),~replace_na(as.character(.x),"inter"))) |> 
#   mutate(margin.sgdd=case_when(is.na(margin.sgdd)~"midtemp",
#                                TRUE~as.character(margin.sgdd)),
#          margin.wai=case_when(is.na(margin.wai)~"midhum",
#                                TRUE~as.character(margin.wai))) |> 
#   mutate(margin.sgdd=factor(margin.sgdd,levels=c("midtemp","cold","hot")),
#          margin.wai=factor(margin.wai,levels=c("midhum","arid","humid"))) 


# Second desgin: dataset restricted
sp.mod=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  mutate(dh=12*pet-map) |> 
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.temp=case_when(mat<weighted.quantile(mat,w=BA, prob=0.1)[[1]]~"cold",
                               mat<weighted.quantile(mat,w=BA, prob=0.6)[[1]]&
                                 mat>weighted.quantile(mat,w=BA, prob=0.4)[[1]]~"midtemp",
                               mat>weighted.quantile(mat,w=BA, prob=0.9)[[1]]~"hot"),
         margin.deficit=case_when(dh<weighted.quantile(dh,w=BA, prob=0.1)[[1]]~"humid",
                              dh<weighted.quantile(dh,w=BA, prob=0.6)[[1]]&
                                 dh>weighted.quantile(dh,w=BA, prob=0.4)[[1]]~"midhum",
                               dh>weighted.quantile(dh,w=BA, prob=0.9)[[1]]~"arid"),
         # margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.1)[[1]]~"cold",
         #                       sgdd<weighted.quantile(sgdd,w=BA, prob=0.6)[[1]]&
         #                         sgdd>weighted.quantile(sgdd,w=BA, prob=0.4)[[1]]~"midtemp",
         #                       sgdd>weighted.quantile(sgdd,w=BA, prob=0.9)[[1]]~"hot"),
         # margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.1)[[1]]~"arid",
         #                      wai<weighted.quantile(wai,w=BA, prob=0.6)[[1]]&
         #                         wai>weighted.quantile(wai,w=BA, prob=0.4)[[1]]~"midhum",
         #                       wai>weighted.quantile(wai,w=BA, prob=0.9)[[1]]~"humid"),
         cor.mat.dh=cor(dh,mat,use="complete.obs"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  mutate(margin.temp=factor(margin.temp,levels=c("midtemp","cold","hot")),
         margin.deficit=factor(margin.deficit,levels=c("midhum","arid","humid")),
         zone=factor(zone,levels=c("west","east","europe"))) |> 
  filter(!is.na(margin.temp)&!is.na(margin.deficit)) |>
  ungroup() |> 
  mutate(ISP=scale(log(ISP))) |> 
  as.data.table()


mod.lme = lme(ISP ~ -1+ margin.temp * margin.deficit , 
              random = ~ 1 | species, 
             #weights = varFixed(~cv_plot), 
             data = sp.mod)
summary(mod.lme)$tTable
anova(mod.lme)


sp.mod |> group_by(block,margin.sgdd,margin.wai) |> summarise(n=n())

mod.means=emmeans(object=mod.lme,
        specs=~margin.wai*margin.sgdd)
data_pred=cld(object=mod.means,
    adjust="Tukey",
    Letters=letters,
    alpha=0.05)
as.data.frame(data_pred) |> 
  mutate(margin.sgdd=if_else(margin.sgdd=="midtemp","Core",
                            stringr::str_to_title(margin.sgdd)),
         margin.wai=if_else(margin.wai=="midhum","Core",
                            stringr::str_to_title(margin.wai))) |> 
  ggplot(aes(color=margin.wai))+
  geom_point(aes(margin.wai,emmean))+
  geom_segment(aes( x = margin.wai,xend=margin.wai,y=lower.CL,yend=upper.CL))+
  scale_color_manual(values=c("orangered","gold","lightseagreen"))+
  geom_text(aes(label=str_trim(.group),x=margin.wai,y=upper.CL),vjust=-1,color="black")+
  labs(x="Margin relative to the SGDD gradient",
       y="Predictions",
       color="Margin relative to the WAI gradient")+
  facet_wrap(~margin.sgdd)->p
# ggsave("interactionall_tukey.pdf",scale=1.8,width=15,height=8,units="cm",plot=p)
p
vcov(mod.lme)
q
```

### Bayesian


#### Interaction only 
```{r}
select.species=sample(unique(sp.mod$species), size = 10)
sp.bayes=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  mutate(dh=12*pet-map) |> 
  group_by(species) |> 
  mutate(margin.temp=case_when(mat<weighted.quantile(mat,w=BA, prob=0.1)[[1]]~"cold",
                               mat<weighted.quantile(mat,w=BA, prob=0.6)[[1]]&
                                 mat>weighted.quantile(mat,w=BA, prob=0.4)[[1]]~"midtemp",
                               mat>weighted.quantile(mat,w=BA, prob=0.9)[[1]]~"hot"),
         margin.deficit=case_when(dh<weighted.quantile(dh,w=BA, prob=0.1)[[1]]~"humid",
                              dh<weighted.quantile(dh,w=BA, prob=0.6)[[1]]&
                                 dh>weighted.quantile(dh,w=BA, prob=0.4)[[1]]~"midhum",
                               dh>weighted.quantile(dh,w=BA, prob=0.9)[[1]]~"arid")) |> 
  mutate(margin.temp=factor(margin.temp,levels=c("midtemp","cold","hot")),
         margin.deficit=factor(margin.deficit,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.temp)&!is.na(margin.deficit)) |>
  ungroup() |> 
  # mutate(ISP=scale(log(ISP))[,]) |> 
  group_by(species) |> 
  mutate(ISP=log(ISP),
         ISP = scale(ISP, center = mean(ISP[margin.sgdd == "midtemp" & margin.wai == "midhum"]), 
                     scale = sd(ISP[margin.sgdd == "midtemp" & margin.wai == "midhum"]))[,]) |> 
  left_join(phylo.select) #|> 
  # filter(species %in% select.species[3])



sp.bayes |> 
  ggplot(aes(margin.sgdd,ISP,color=margin.wai))+
  geom_boxplot()+
  facet_wrap(~species,scales="free")
X=model.matrix(~margin.sgdd*margin.wai, sp.bayes)

data_list=list(N=dim(sp.bayes)[1],
               NX=ncol(X),
               S=nlevels(as.factor(sp.bayes$species)),
               species=as.numeric(as.factor(sp.bayes$species)),
               ISP=sp.bayes$ISP,
               X=X)
               # K_sgdd=nlevels(sp.bayes$margin.sgdd),
               # K_wai=nlevels(sp.bayes$margin.wai),
               # sgdd=as.numeric(sp.bayes$margin.sgdd))#,
               # wai=as.numeric(sp.bayes$margin.wai),
               # cv_plot=sp.bayes$cv_plot)
library(rstan)
fit.lm <- stan(file = "lmm_int.stan",
                    data=data_list,
                    iter=1000,
                    chains=3,
                    core=3)
library(shinystan)
launch_shinystan(fit.lm)
colnames(X)

posteriors_fec<-as.data.frame(fit.lm) |> 
  dplyr::select(!matches("beta_")) |> 
  dplyr::select(matches("beta"))
colnames(posteriors_fec)[1:ncol(X)]=colnames(X)


# contrast.max=
contrast_cor=as.data.frame(X) |> 
  unique() |>
  mutate(margin.sgdd=case_when(margin.sgddcold==1~"cold",
                               margin.sgddhot==1~"hot",
                               TRUE~"mid"),
         margin.wai=case_when(margin.waihumid==1~"humid",
                               margin.waiarid==1~"arid",
                               TRUE~"mid")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("cold","mid","hot")),
         margin.wai=factor(margin.wai,levels=c("arid","mid","humid"))) |> 
  tibble::rownames_to_column(var = "code") |> 
  dplyr::select(code,margin.sgdd,margin.wai) |> 
  mutate(contrast=paste0(margin.sgdd,"_",margin.wai))

contrast_mat= X |> unique() |>  t()
# par_names <-unlist( lapply(colnames(as.matrix(posteriors_fec)[,1:ncol(X)]),
#                          function(x)paste(str_extract_all(x,
#                                                           pattern=pattern)[[1]],
#                                           collapse="_"))
#                   )
# par_names[1]="int"
# rownames(contrast_mat)=par_names
# contrast_names=unlist(lapply(1:ncol(contrast_mat),function(x)paste(rep(names(contrast_mat[2:5,x]),
#                                                  as.numeric(contrast_mat[2:5,x])),
#                                              collapse="_")))
# contrast_names[contrast_names==""]="core"
# colnames(contrast_mat)=contrast_names
contrast_post=as.matrix(posteriors_fec)[,1:ncol(X)] %*% contrast_mat

as.data.frame(contrast_post) |> 
  pivot_longer(cols=everything(),
               names_to = "code") |>
  left_join(contrast_cor,by="code") |> 
  ggplot(aes(margin.sgdd,value,color=margin.wai))+
  geom_boxplot()

setnames(as.data.frame(contrast_post),new= contrast_cor$contrast)|> 
  mutate(c_mid_arid=cold_mid-cold_arid,
         c_mid_humid=cold_mid-cold_humid,
         m_mid_arid=mid_mid-mid_arid,
         m_mid_humid=mid_mid-mid_humid,
         h_mid_arid=hot_mid-hot_arid,
         h_mid_humid=hot_mid-hot_humid) |> 
  dplyr::select(c_mid_arid,
         c_mid_humid,
         m_mid_arid,
         m_mid_humid,
         h_mid_arid,
         h_mid_humid) |>
  pivot_longer(cols=everything(),
               names_to = "comp") |>
  mutate(comp=factor(comp,levels=c("c_mid_arid","c_mid_humid","m_mid_arid",
                                   "m_mid_humid","h_mid_arid","h_mid_humid"))) |> 
  ggplot(aes(comp,value))+
  geom_boxplot()

setnames(as.data.frame(contrast_post),new= contrast_cor$contrast)|> 
  ggplot(aes(cold_mid,cold_humid))+
  geom_point()+
  geom_abline(slope=1,intercept = 0.2)

pairs(contrast_post)

cor(contrast_post)
launch_shinystan(fit.lm)
pairs(as.matrix(posteriors_fec)[,1:ncol(X)])
unique(model.matrix(~-1+margin.sgdd*margin.wai, sp.bayes))
summary(fit.lm)

c("humid","humid_cold","")

```
(centrer par la moyenne des données au milieu)


#### Weighted observations
```{r}
# data
select.species=sample(unique(sp.mod$species), size = 5)
sp.bayes=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.1)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.6)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.4)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.9)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.1)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.6)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.4)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.9)[[1]]~"humid"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("midtemp","cold","hot")),
         margin.wai=factor(margin.wai,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.sgdd)&!is.na(margin.wai)) |>
  ungroup() |> 
  # mutate(ISP=scale(log(ISP))[,]) |> 
  group_by(species) |> 
  mutate(s_ISP=fecGmSd/BA) |> 
         # ISP=log(ISP),
         # ISP = scale(ISP, center = mean(ISP[margin.sgdd == "midtemp" & margin.wai == "midhum"]),
         #             scale = sd(ISP[margin.sgdd == "midtemp" & margin.wai == "midhum"]) )[,]) |>
  left_join(phylo.select) |> 
  filter(!is.na(s_ISP)) |>
  filter(species %in% select.species) 



# model fit
X=model.matrix(~margin.sgdd*margin.wai, sp.bayes)

data_list=list(N=dim(sp.bayes)[1],
               NX=ncol(X),
               S=nlevels(as.factor(sp.bayes$species)),
               species=as.numeric(as.factor(sp.bayes$species)),
               ISP_meas=sp.bayes$ISP,
               X=X,
               s_ISP=sp.bayes$s_ISP,
               prior_mean=mean(sp.bayes[sp.bayes$margin.sgdd == "midtemp" & sp.bayes$margin.wai == "midhum","ISP"][[1]]),
               prior_sd=sd(sp.bayes[sp.bayes$margin.sgdd == "midtemp" & sp.bayes$margin.wai == "midhum","ISP"][[1]]),
               NULL)
               # K_sgdd=nlevels(sp.bayes$margin.sgdd),
               # K_wai=nlevels(sp.bayes$margin.wai),
               # sgdd=as.numeric(sp.bayes$margin.sgdd))#,
               # wai=as.numeric(sp.bayes$margin.wai),
               # cv_plot=sp.bayes$cv_plot)
library(rstan)
fit.lm <- stan(file = "lmm_int_weighted.stan",
                    data=data_list,
                    iter=1000,
                    chains=3,
                    core=3,
               include=FALSE,
               pars=c("ISP_real","beta_raw"))
library(shinystan)
launch_shinystan(fit.lm)
colnames(X)

posteriors_fec<-as.data.frame(fit.lm) |> 
  dplyr::select(!matches("beta_")) |> 
  dplyr::select(matches("beta"))
colnames(posteriors_fec)[1:ncol(X)]=colnames(X)


# contrast.max=
contrast_cor=as.data.frame(X) |> 
  unique() |>
  mutate(margin.sgdd=case_when(margin.sgddcold==1~"cold",
                               margin.sgddhot==1~"hot",
                               TRUE~"mid"),
         margin.wai=case_when(margin.waihumid==1~"humid",
                               margin.waiarid==1~"arid",
                               TRUE~"mid")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("cold","mid","hot")),
         margin.wai=factor(margin.wai,levels=c("arid","mid","humid"))) |> 
  tibble::rownames_to_column(var = "code") |> 
  dplyr::select(code,margin.sgdd,margin.wai) |> 
  mutate(contrast=paste0(margin.sgdd,"_",margin.wai))

contrast_mat= X |> unique() |>  t()
# par_names <-unlist( lapply(colnames(as.matrix(posteriors_fec)[,1:ncol(X)]),
#                          function(x)paste(str_extract_all(x,
#                                                           pattern=pattern)[[1]],
#                                           collapse="_"))
#                   )
# par_names[1]="int"
# rownames(contrast_mat)=par_names
# contrast_names=unlist(lapply(1:ncol(contrast_mat),function(x)paste(rep(names(contrast_mat[2:5,x]),
#                                                  as.numeric(contrast_mat[2:5,x])),
#                                              collapse="_")))
# contrast_names[contrast_names==""]="core"
# colnames(contrast_mat)=contrast_names
contrast_post=as.matrix(posteriors_fec)[,1:ncol(X)] %*% contrast_mat

as.data.frame(contrast_post) |> 
  pivot_longer(cols=everything(),
               names_to = "code") |>
  left_join(contrast_cor,by="code") |> 
  ggplot(aes(margin.sgdd,value,color=margin.wai))+
  geom_boxplot()

setnames(as.data.frame(contrast_post),new= contrast_cor$contrast)|> 
  mutate(c_mid_arid=cold_mid-cold_arid,
         c_mid_humid=cold_mid-cold_humid,
         m_mid_arid=mid_mid-mid_arid,
         m_mid_humid=mid_mid-mid_humid,
         h_mid_arid=hot_mid-hot_arid,
         h_mid_humid=hot_mid-hot_humid) |> 
  dplyr::select(c_mid_arid,
         c_mid_humid,
         m_mid_arid,
         m_mid_humid,
         h_mid_arid,
         h_mid_humid) |>
  pivot_longer(cols=everything(),
               names_to = "comp") |>
  mutate(comp=factor(comp,levels=c("c_mid_arid","c_mid_humid","m_mid_arid",
                                   "m_mid_humid","h_mid_arid","h_mid_humid"))) |> 
  ggplot(aes(comp,value))+
  geom_boxplot()

setnames(as.data.frame(contrast_post),new= contrast_cor$contrast)|> 
  ggplot(aes(cold_mid,cold_humid))+
  geom_point()+
  geom_abline(slope=1,intercept = 0.2)

pairs(contrast_post)

cor(contrast_post)
launch_shinystan(fit.lm)
pairs(as.matrix(posteriors_fec)[,1:ncol(X)])
unique(model.matrix(~-1+margin.sgdd*margin.wai, sp.bayes))
summary(fit.lm)

c("humid","humid_cold","")

```

#### Weighted differences

```{r eval=FALSE, include=FALSE}
select.species=sample(unique(sp.mod$species), size = 5)
sp.bayes=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  dplyr::select(plot,lon,lat,species,BA,fecGmMu,fecGmSd,sgdd,wai,block) |> 
  filter(species %in% select.species[3]) |> 
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.1)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.6)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.4)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.9)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.1)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.6)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.4)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.9)[[1]]~"humid"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("midtemp","cold","hot")),
         margin.wai=factor(margin.wai,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.sgdd)&!is.na(margin.wai)) |> 
  ungroup() 

sp.bayes |> 
  ggplot(aes(fecGmMu,color=margin.sgdd))+
  geom_density()+
  scale_x_log10()


sp.bayes=sp.bayes |> 
  mutate(ISP=fecGmMu/BA,
         s_ISP=fecGmSd/(BA^2))

sp.bayes |> 
  ggplot(aes(log(ISP),color=margin.sgdd))+
  geom_density()



mid_isp<-sp.bayes |> 
  group_by(species,margin.sgdd,margin.wai) |> 
  summarise(mid_isp=median(ISP)[[1]]) |> 
  filter(margin.sgdd=="midtemp"&margin.wai=="midhum") |>
  ungroup() |> 
  dplyr::select(species,mid_isp)

sp.bayes |> 
  ggplot(aes(log(ISP),color=margin.sgdd))+
  geom_density() +
  # scale_x_log10()+
  geom_vline(xintercept = log(mid_isp[mid_isp$species==select.species[3],"mid_isp"][[1]]))



sp.bayes=sp.bayes |>
  left_join(mid_isp) |>
  mutate(dISP=ISP/mid_isp,
         s_ISP=s_ISP/(mid_isp^2),
         ls_ISP=(min(log(s_ISP))-log(s_ISP))/(min(log(s_ISP))))


sp.bayes |> 
  group_by(margin.sgdd,margin.wai) |> 
  summarise(n=n())

sp.bayes |> 
  # filter(margin.wai=="midhum") |> 
  ggplot(aes(margin.sgdd,log(dISP)))+
  geom_boxplot()+
  facet_wrap(~species,scale="free")+
  geom_hline(yintercept = 0)

sp.bayes |> 
  mutate(margin=paste0(margin.sgdd,"_",margin.wai)) |> 
  ggplot(aes(log(dISP),color=as.factor(margin)))+ 
  geom_density()+
  facet_wrap(~species)

sp.bayes |> 
  mutate(std=(min(log(s_ISP))-log(s_ISP))/(min(log(s_ISP)))) |> 
  ggplot(aes(std,color=margin.sgdd))+ 
  geom_density()+
  # scale_x_log10()+
  facet_wrap(~margin.wai)

ggplot(sp.bayes,aes(dISP,s_ISP,color=margin.sgdd))+
  geom_point()+
  geom_smooth(method="lm")
  # scale_x_log10()


```


```{r eval=FALSE, include=FALSE}
# model fit
X=model.matrix(~margin.sgdd*margin.wai, sp.bayes)

data_list=list(N=dim(sp.bayes)[1],
               NX=ncol(X),
               # S=nlevels(as.factor(sp.bayes$species)),
               # species=as.numeric(as.factor(sp.bayes$species)),
               ISP_meas=sp.bayes$dISP,
               X=X,
               s_ISP=sp.bayes$dISP,sp.bayes$dISP/max(sp.bayes$dISP)*runif(dim(sp.bayes)[1],0,1.5), #runif(dim(sp.bayes)[1],0,1.5), #sp.bayes$s_ISP,
               NULL)
               # K_sgdd=nlevels(sp.bayes$margin.sgdd),
               # K_wai=nlevels(sp.bayes$margin.wai),
               # sgdd=as.numeric(sp.bayes$margin.sgdd))#,
               # wai=as.numeric(sp.bayes$margin.wai),
               # cv_plot=sp.bayes$cv_plot)
library(rstan)
fit.lm <- stan(file = "lmm_int_dif.stan",
                    data=data_list,
                    iter=1000,
                    chains=3,
                    core=3,
               include=FALSE,
               pars=c("beta_raw"))
library(shinystan)
launch_shinystan(fit.lm)


# summary.fit=summary(fit.lm)$c_summary[,,3]
summary.fit=summary(fit.lm)$summary
comp.fit=data.frame(ldISP=log(sp.bayes$dISP),
                    dISP=sp.bayes$dISP,
                    ISP_real=summary.fit[1:dim(sp.bayes)[1],1],
                    rhat=summary.fit[1:dim(sp.bayes)[1],10],
                    s_ISP=sp.bayes$s_ISP,
                    s_ISP_fict=data_list$s_ISP)

comp.fit |> 
  ggplot(aes(dISP,ISP_real,color=s_ISP_fict))+
  geom_point()

comp.fit |> 
  ggplot(aes(rhat,s_ISP_fict))+
  geom_point()+
  scale_x_log10()

comp.fit |> 
  ggplot(aes(rhat,dISP,color=s_ISP_fict))+
  geom_point()+
  scale_x_log10()
```


```{r eval=FALSE, include=FALSE}
colnames(X)

posteriors_fec<-as.data.frame(fit.lm) |> 
  dplyr::select(!matches("beta_")) |> 
  dplyr::select(matches("beta"))
colnames(posteriors_fec)[1:ncol(X)]=colnames(X)


# contrast.max=
contrast_cor=as.data.frame(X) |> 
  unique() |>
  mutate(margin.sgdd=case_when(margin.sgddcold==1~"cold",
                               margin.sgddhot==1~"hot",
                               TRUE~"mid"),
         margin.wai=case_when(margin.waihumid==1~"humid",
                               margin.waiarid==1~"arid",
                               TRUE~"mid")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("cold","mid","hot")),
         margin.wai=factor(margin.wai,levels=c("arid","mid","humid"))) |> 
  tibble::rownames_to_column(var = "code") |> 
  dplyr::select(code,margin.sgdd,margin.wai) |> 
  mutate(contrast=paste0(margin.sgdd,"_",margin.wai))

contrast_mat= X |> unique() |>  t()
# par_names <-unlist( lapply(colnames(as.matrix(posteriors_fec)[,1:ncol(X)]),
#                          function(x)paste(str_extract_all(x,
#                                                           pattern=pattern)[[1]],
#                                           collapse="_"))
#                   )
# par_names[1]="int"
# rownames(contrast_mat)=par_names
# contrast_names=unlist(lapply(1:ncol(contrast_mat),function(x)paste(rep(names(contrast_mat[2:5,x]),
#                                                  as.numeric(contrast_mat[2:5,x])),
#                                              collapse="_")))
# contrast_names[contrast_names==""]="core"
# colnames(contrast_mat)=contrast_names
contrast_post=as.matrix(posteriors_fec)[,1:ncol(X)] %*% contrast_mat

as.data.frame(contrast_post) |> 
  pivot_longer(cols=everything(),
               names_to = "code") |>
  left_join(contrast_cor,by="code") |> 
  ggplot(aes(margin.sgdd,value,color=margin.wai))+
  geom_boxplot()

setnames(as.data.frame(contrast_post),new= contrast_cor$contrast)|> 
  mutate(c_mid_arid=cold_mid-cold_arid,
         c_mid_humid=cold_mid-cold_humid,
         m_mid_arid=mid_mid-mid_arid,
         m_mid_humid=mid_mid-mid_humid,
         h_mid_arid=hot_mid-hot_arid,
         h_mid_humid=hot_mid-hot_humid) |> 
  dplyr::select(c_mid_arid,
         c_mid_humid,
         m_mid_arid,
         m_mid_humid,
         h_mid_arid,
         h_mid_humid) |>
  pivot_longer(cols=everything(),
               names_to = "comp") |>
  mutate(comp=factor(comp,levels=c("c_mid_arid","c_mid_humid","m_mid_arid",
                                   "m_mid_humid","h_mid_arid","h_mid_humid"))) |> 
  ggplot(aes(comp,value))+
  geom_boxplot()

setnames(as.data.frame(contrast_post),new= contrast_cor$contrast)|> 
  ggplot(aes(cold_mid,cold_humid))+
  geom_point()+
  geom_abline(slope=1,intercept = 0.2)

pairs(contrast_post)

cor(contrast_post)
launch_shinystan(fit.lm)
pairs(as.matrix(posteriors_fec)[,1:ncol(X)])
unique(model.matrix(~-1+margin.sgdd*margin.wai, sp.bayes))
summary(fit.lm)

c("humid","humid_cold","")
```


#### Interaction on difference

```{r eval=FALSE}
select.species=sample(c(sp.select.am,sp.select.eu), size = 35)
sp.bayes=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  dplyr::select(plot,lon,lat,species,BA,fecGmMu,fecGmSd,sgdd,wai,block) |> 
  filter(species %in% select.species) |> 
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.1)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.6)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.4)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.9)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.1)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.6)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.4)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.9)[[1]]~"humid"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("midtemp","cold","hot")),
         margin.wai=factor(margin.wai,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.sgdd)&!is.na(margin.wai)) |> 
  ungroup() 

sp.bayes |> 
  ggplot(aes(fecGmMu,color=margin.sgdd))+
  geom_density()+
  scale_x_log10()


sp.bayes=sp.bayes |> 
  mutate(ISP=fecGmMu/BA,
         s_ISP=fecGmSd/(BA^2))

sp.bayes |> 
  ggplot(aes(log(ISP),color=margin.sgdd))+
  geom_density()



mid_isp<-sp.bayes |> 
  group_by(species,margin.sgdd,margin.wai) |> 
  summarise(mid_isp=median(ISP)[[1]]) |> 
  filter(margin.sgdd=="midtemp"&margin.wai=="midhum") |>
  ungroup() |> 
  dplyr::select(species,mid_isp)

sp.bayes |> 
  ggplot(aes(log(ISP),color=margin.sgdd))+
  geom_density() +
  # scale_x_log10()+
  geom_vline(xintercept = log(mid_isp[mid_isp$species==select.species[3],"mid_isp"][[1]]))



sp.bayes=sp.bayes |>
  left_join(mid_isp) |>
  mutate(dISP=ISP/mid_isp,
         s_ISP=s_ISP/(mid_isp^2),
         ls_ISP=(min(log(s_ISP))-log(s_ISP))/(min(log(s_ISP))))


sp.bayes |> 
  group_by(margin.sgdd,margin.wai) |> 
  summarise(n=n())

sp.bayes |> 
  # filter(margin.wai=="midhum") |> 
  ggplot(aes(margin.sgdd,log(dISP)))+
  geom_boxplot()+
  facet_wrap(~species,scale="free")+
  geom_hline(yintercept = 0)

sp.bayes |> 
  mutate(margin=paste0(margin.sgdd,"_",margin.wai)) |> 
  ggplot(aes(log(dISP),color=as.factor(margin)))+ 
  geom_density()+
  facet_wrap(~species)
```


```{r echo=FALSE}
# model fit
X=model.matrix(~margin.sgdd*margin.wai, sp.bayes)

data_list=list(N=dim(sp.bayes)[1],
               NX=ncol(X),
               S=nlevels(as.factor(sp.bayes$species)),
               species=as.numeric(as.factor(sp.bayes$species)),
               ISP=sp.bayes$dISP,
               X=X,
               NULL)
               # K_sgdd=nlevels(sp.bayes$margin.sgdd),
               # K_wai=nlevels(sp.bayes$margin.wai),
               # sgdd=as.numeric(sp.bayes$margin.sgdd))#,
               # wai=as.numeric(sp.bayes$margin.wai),
               # cv_plot=sp.bayes$cv_plot)
library(rstan)
fit.lm <- stan(file = "lmm_dif.stan",
                    data=data_list,
                    iter=1000,
                    chains=3,
                    core=3,
               include=FALSE,
               pars=c("beta_raw"))
library(shinystan)
launch_shinystan(fit.lm)


posteriors_fec<-as.data.frame(fit.lm) |> 
  dplyr::select(!matches("beta_")) |> 
  dplyr::select(matches("beta"))
colnames(posteriors_fec)[1:ncol(X)]=colnames(X)


# contrast.max=
contrast_cor=as.data.frame(X) |> 
  unique() |>
  mutate(margin.sgdd=case_when(margin.sgddcold==1~"cold",
                               margin.sgddhot==1~"hot",
                               TRUE~"mid"),
         margin.wai=case_when(margin.waihumid==1~"humid",
                               margin.waiarid==1~"arid",
                               TRUE~"mid")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("cold","mid","hot")),
         margin.wai=factor(margin.wai,levels=c("arid","mid","humid"))) |> 
  tibble::rownames_to_column(var = "code") |> 
  dplyr::select(code,margin.sgdd,margin.wai) |> 
  mutate(contrast=paste0(margin.sgdd,"_",margin.wai))

contrast_mat= X |> unique() |>  t()
contrast_post=as.matrix(posteriors_fec)[,1:ncol(X)] %*% contrast_mat

as.data.frame(contrast_post) |> 
  pivot_longer(cols=everything(),
               names_to = "code") |>
  left_join(contrast_cor,by="code") |> 
  ggplot(aes(margin.sgdd,value,color=margin.wai))+
  geom_boxplot()

# setnames(as.data.frame(contrast_post),new= contrast_cor$contrast)|> 
#   mutate(c_mid_arid=cold_mid-cold_arid,
#          c_mid_humid=cold_mid-cold_humid,
#          m_mid_arid=mid_mid-mid_arid,
#          m_mid_humid=mid_mid-mid_humid,
#          h_mid_arid=hot_mid-hot_arid,
#          h_mid_humid=hot_mid-hot_humid) |> 
#   dplyr::select(c_mid_arid,
#          c_mid_humid,
#          m_mid_arid,
#          m_mid_humid,
#          h_mid_arid,
#          h_mid_humid) |>
#   pivot_longer(cols=everything(),
#                names_to = "comp") |>
#   mutate(comp=factor(comp,levels=c("c_mid_arid","c_mid_humid","m_mid_arid",
#                                    "m_mid_humid","h_mid_arid","h_mid_humid"))) |> 
#   ggplot(aes(comp,value))+
#   geom_boxplot()

# setnames(as.data.frame(contrast_post),new= contrast_cor$contrast)|> 
#   ggplot(aes(cold_mid,cold_humid))+
#   geom_point()+
#   geom_abline(slope=1,intercept = 0.2)
# 
# pairs(contrast_post)
# 
# cor(contrast_post)
# launch_shinystan(fit.lm)
# pairs(as.matrix(posteriors_fec)[,1:ncol(X)])
# unique(model.matrix(~-1+margin.sgdd*margin.wai, sp.bayes))
# summary(fit.lm)
# 
# c("humid","humid_cold","")
```

#### Int with continent

```{r}
# select.species=sample(c(sp.select.am,sp.select.eu), size = 35)
sp.bayes=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  dplyr::select(plot,lon,lat,species,BA,fecGmMu,fecGmSd,sgdd,wai,block,zone) |> 
  filter(species %in% select.species) |> 
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.1)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.6)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.4)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.9)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.1)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.6)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.4)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.9)[[1]]~"humid"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("midtemp","cold","hot")),
         margin.wai=factor(margin.wai,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.sgdd)&!is.na(margin.wai)) |> 
  ungroup() |> 
  mutate(ISP=fecGmMu/BA,
         s_ISP=fecGmSd/(BA^2))

mid_isp<-sp.bayes |> 
  group_by(species,margin.sgdd,margin.wai) |> 
  summarise(mid_isp=median(ISP)[[1]]) |> 
  filter(margin.sgdd=="midtemp"&margin.wai=="midhum") |>
  ungroup() |> 
  dplyr::select(species,mid_isp)


sp.bayes=sp.bayes |>
  left_join(mid_isp) |>
  mutate(dISP=ISP/mid_isp,
         s_ISP=s_ISP/(mid_isp^2),
         ls_ISP=(min(log(s_ISP))-log(s_ISP))/(min(log(s_ISP))))


# model fit
X=model.matrix(~margin.sgdd*margin.wai*zone, sp.bayes)

data_list=list(N=dim(sp.bayes)[1],
               NX=ncol(X),
               S=nlevels(as.factor(sp.bayes$species)),
               species=as.numeric(as.factor(sp.bayes$species)),
               ISP=sp.bayes$dISP,
               X=X,
               NULL)
               # K_sgdd=nlevels(sp.bayes$margin.sgdd),
               # K_wai=nlevels(sp.bayes$margin.wai),
               # sgdd=as.numeric(sp.bayes$margin.sgdd))#,
               # wai=as.numeric(sp.bayes$margin.wai),
               # cv_plot=sp.bayes$cv_plot)
library(rstan)
fit.lm.cont <- stan(file = "lmm_dif.stan",
                    data=data_list,
                    iter=1000,
                    chains=3,
                    core=3,
               include=FALSE,
               pars=c("beta_raw"))
library(shinystan)
launch_shinystan(fit.lm)
# save(fit.lm.cont,file="mod_fit/lm_cont_int.RData")

posteriors_fec<-as.data.frame(fit.lm.cont) |> 
  dplyr::select(!matches("beta_")) |> 
  dplyr::select(matches("beta"))
colnames(posteriors_fec)[1:ncol(X)]=colnames(X)


# contrast.max=
contrast_cor=as.data.frame(X) |> 
  unique() |>
  mutate(margin.sgdd=case_when(margin.sgddcold==1~"cold",
                               margin.sgddhot==1~"hot",
                               TRUE~"mid"),
         margin.wai=case_when(margin.waihumid==1~"humid",
                               margin.waiarid==1~"arid",
                               TRUE~"mid"),
         zone=case_when(zoneeurope==1~"europe",
                        zonewest==1~"west",
                        TRUE~"east")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("cold","mid","hot")),
         margin.wai=factor(margin.wai,levels=c("arid","mid","humid")),
         zone=factor(zone,levels=c("europe","east","west"))) |> 
  tibble::rownames_to_column(var = "code") |> 
  dplyr::select(code,margin.sgdd,margin.wai,zone) |> 
  mutate(contrast=paste0(margin.sgdd,"_",margin.wai,"_",zone))

contrast_mat= X |> unique() |>  t()
contrast_post=as.matrix(posteriors_fec)[,1:ncol(X)] %*% contrast_mat

as.data.frame(contrast_post) |> 
  pivot_longer(cols=everything(),
               names_to = "code") |>
  left_join(contrast_cor,by="code") |> 
  ggplot(aes(margin.sgdd,value,color=margin.wai))+
  geom_boxplot()+
  facet_wrap(~zone)

```


```{r}
zone=phylo.select |> dplyr::select(zone) |> filter(!is.na(zone)) |> unique() |> pull(zone)
sp.bayes=rbind(fecundity.eu_clim |> mutate(block="europe"),
               fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  dplyr::select(plot,lon,lat,species,BA,fecGmMu,fecGmSd,sgdd,wai,pet,map,mat,block,zone) |> 
  filter(BA!=0) |> #rm absences
  mutate(dh=12*pet-map) |> 
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.temp=case_when(mat<weighted.quantile(mat,w=BA, prob=0.1)[[1]]~"cold",
                               mat<weighted.quantile(mat,w=BA, prob=0.6)[[1]]&
                                 mat>weighted.quantile(mat,w=BA, prob=0.4)[[1]]~"midtemp",
                               mat>weighted.quantile(mat,w=BA, prob=0.9)[[1]]~"hot"),
         margin.deficit=case_when(dh<weighted.quantile(dh,w=BA, prob=0.1)[[1]]~"humid",
                              dh<weighted.quantile(dh,w=BA, prob=0.6)[[1]]&
                                 dh>weighted.quantile(dh,w=BA, prob=0.4)[[1]]~"midhum",
                               dh>weighted.quantile(dh,w=BA, prob=0.9)[[1]]~"arid"),
         cor.mat.dh=cor(dh,mat,use="complete.obs")) |>
  mutate(margin.temp=factor(margin.temp,levels=c("midtemp","cold","hot")),
         margin.deficit=factor(margin.deficit,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.temp)&!is.na(margin.deficit)) |> 
  ungroup() |> 
  mutate(ISP=fecGmMu/BA,
         s_ISP=fecGmSd/(BA^2))


post=data.frame(code=as.character(0),
                value=as.numeric(0),
                margin.temp=as.factor(0),
                margin.deficit=as.factor(0),
                zone=as.character(0),
                contrast=as.character(0))
for(z in zone){
  print(z)
  file=paste0("mod_fit3/lm_int_",z,".RData")
  sp.zone=sp.bayes |> 
    filter(zone==z)
  mid_isp<-sp.zone |> 
    group_by(species,margin.temp,margin.deficit) |> 
    summarise(mid_isp=median(ISP)[[1]]) |> 
    filter(margin.temp=="midtemp"&margin.deficit=="midhum") |>
    ungroup() |> 
    dplyr::select(species,mid_isp)
  
  sp.zone=sp.zone |>
    left_join(mid_isp) |>
    mutate(dISP=ISP/mid_isp,
           s_ISP=s_ISP/(mid_isp^2))
  
  X=model.matrix(~margin.temp*margin.deficit, sp.zone)
  
  
  if(file.exists(file)){
    load(file)
  }else{
    data_zone=list(N=dim(sp.zone)[1],
                 NX=ncol(X),
                 S=nlevels(as.factor(sp.zone$species)),
                 species=as.numeric(as.factor(sp.zone$species)),
                 ISP=sp.zone$dISP,
                 X=X,
                 NULL)
    fit.zone <- stan(file = "lmm_dif.stan",
                     data=data_zone,
                     iter=1000,
                     chains=3,
                     core=3,
                     include=FALSE,
                     pars=c("beta_raw"))
    save(fit.zone,file=file)
  
  }
  
  
  posteriors_fec<-as.data.frame(fit.zone) |>
    dplyr::select(!matches("beta_")) |>
    dplyr::select(matches("beta"))
  colnames(posteriors_fec)[1:ncol(X)]=colnames(X)
  
  contrast_cor=as.data.frame(X) |>
    unique() |>
    mutate(margin.temp=case_when(margin.tempcold==1~"cold",
                                 margin.temphot==1~"hot",
                                 TRUE~"mid"),
           margin.deficit=case_when(margin.deficithumid==1~"humid",
                                 margin.deficitarid==1~"arid",
                                 TRUE~"mid"),
           zone=z) |> 
    mutate(margin.temp=factor(margin.temp,levels=c("cold","mid","hot")),
           margin.deficit=factor(margin.deficit,levels=c("arid","mid","humid"))) |> 
    tibble::rownames_to_column(var = "code") |> 
    dplyr::select(code,margin.temp,margin.deficit,zone) |> 
    mutate(contrast=paste0(margin.temp,"_",margin.deficit))
  contrast_mat= X |> unique() |>  t()
  contrast_post=as.matrix(posteriors_fec)[,1:ncol(X)] %*% contrast_mat

  post=bind_rows(post,
                 as.data.frame(contrast_post) |>
                   pivot_longer(cols=everything(),
                                names_to = "code") |>
                   left_join(contrast_cor,by="code"))
  
}

post |> 
  filter(code!=0) |> 
  ggplot(aes(margin.temp,value,color=margin.deficit))+
  geom_boxplot(outlier.colour = NA)+
  facet_wrap(~zone)

zone.t="europe"
lim.eu.x=c(min(sp.bayes[sp.bayes$zone==zone.t,"lon"]),
         max(sp.bayes[sp.bayes$zone==zone.t,"lon"]))
lim.eu.y=c(min(sp.bayes[sp.bayes$zone==zone.t,"lat"]),
         max(sp.bayes[sp.bayes$zone==zone.t,"lat"]))
sp.bayes |> 
  filter(margin.temp=="hot"&margin.deficit=="humid") |> 
  filter(zone==zone.t) |> 
  mutate(species=as.factor(species)) |> 
  ggplot()+
  geom_point(aes(x=lon,y=lat,color=species))+
  geom_sf(data=worldmap,fill=NA)+
  xlim(lim.eu.x)+
  ylim(lim.eu.y)+
  theme(legend.position = "none")


sp.bayes |> 
  filter(margin.temp=="cold"&margin.deficit=="midhum"&zone=="europe") |> 
  # filter(zone==zone.t) |> 
  mutate(species=as.factor(species)) |> 
  ggplot()+
  geom_point(aes(x=lon,y=lat,color=species))+
  geom_sf(data=worldmap,fill=NA)+
  # xlim(lim.eu.x)+
  # ylim(lim.eu.y)+
  xlim(c(-10,35))+
  ylim(c(20,70))+
  theme(legend.position = "none")


sp.bayes |> 
  filter(zone=="europe"&margin.temp=="cold") |> 
  ggplot(aes(ISP,color=margin.deficit))+
  geom_density()+
  facet_wrap(~species)+
  scale_x_log10()
species.florida=sp.bayes |> 
  filter(lat<(30)&lon>(-90))|> 
  dplyr::select(species) |> unique() |> pull()
sp.bayes |> 
  filter(species %in% species.florida) |> 
  mutate(species=as.factor(species)) |> 
  ggplot()+
  geom_point(aes(x=lon,y=lat,color=species))+
  geom_sf(data=worldmap,fill=NA)+
  # xlim(lim.eu.x)+
  # ylim(lim.eu.y)+
  xlim(c(-120,-60))+
  ylim(c(20,70))+
  theme(legend.position = "none")+
  facet_wrap(~species)
```


```{r}
### prediction and residual error on europe cold/midhum margin

# load model
load("mod_fit3/lm_int_europe.RData")

# format dataset as in model
sp.zone=sp.bayes |> 
  filter(zone=="europe") 

mid_isp<-sp.zone |> 
  group_by(species,margin.temp,margin.deficit) |> 
  summarise(mid_isp=median(ISP)[[1]]) |> 
  filter(margin.temp=="midtemp"&margin.deficit=="midhum") |>
  ungroup() |> 
  dplyr::select(species,mid_isp)
sp.zone=sp.zone |>
  left_join(mid_isp) |>
  mutate(dISP=ISP/mid_isp,
         s_ISP=s_ISP/(mid_isp^2))

# cont matrix
X=model.matrix(~margin.temp*margin.deficit, sp.zone)

# mod output and match
spcode=sp.bayes |> 
  filter(zone=="europe") |> 
  mutate(species.code=as.numeric(as.factor(species))) |> 
  dplyr::select(species,species.code) |> unique() |> arrange(species.code)
summary(fit.zone)$summary[,1]->t
colnames(X)
names(t)<-c(spcode$species,"sigma","sigma_s",colnames(X),"lp")
t<-as.data.frame(t) |> rownames_to_column(var="species") |> rename(ranef.sp=t)

# pred vs obs, with all european species, including random effect
sp.zone |> 
  filter(!species%in%c("acerPseudopl","piceaAbies")) |> 
  filter(margin.temp=="cold"&margin.deficit=="midhum"&zone=="europe") |> 
  mutate(margin.deficit=case_when(margin.deficit=="midhum"~"mid",
                                  TRUE~margin.deficit),
         margin.temp=case_when(margin.temp=="midtemp"~"mid",
                                  TRUE~margin.temp)) |> 
  left_join(t,by="species") |> 
  mutate(pred=ranef.sp+
           t[t$species=="margin.tempcold","ranef.sp"]+
           t[t$species=="margin.deficithumid","ranef.sp"]+
           t[t$species=="margin.tempcold:margin.deficithumid","ranef.sp"]) |> 
  ggplot()+
  geom_point(aes(log(dISP),pred,color=species))+
  geom_abline(slope=1)+
  geom_vline(xintercept = -1.5)+
  geom_boxplot(aes(log(dISP),-2))
  # geom_boxplot(aes(log(dISP)-pred,species))+
  # geom_boxplot(aes(log(dISP)-pred))

# count obs by margin interaction and species
sp.zone |> 
  # group_by(species,margin.temp,margin.deficit) |> 
  # summarise(n=n()) |> 
  # ungroup() |> 
  mutate(margin.temp=factor(margin.temp,levels=c("cold","midtemp","hot")),
         margin.deficit=factor(margin.deficit,levels=c("arid","midhum","humid"))) |> 
  ggplot(aes(margin.deficit,fill=species))+
  geom_histogram(stat = "count")+
  facet_wrap(~margin.temp)+
  scale_fill_manual(values=viridis(n=13))

sp.zone |> 
  mutate(margin.temp=factor(margin.temp,levels=c("cold","midtemp","hot")),
         margin.deficit=factor(margin.deficit,levels=c("arid","midhum","humid"))) |> 
  # filter(species%in%c("fagusSylvatic","piceaAbies")) |> 
  filter(margin.temp=="cold"&zone=="europe") |> 
  ggplot(aes(log(dISP),color=margin.deficit))+
  geom_density()+
  facet_wrap(~species)

 # try with whole margin
nspecies=rbind(fecundity.eu_clim |> mutate(block="europe"),
               fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  filter(BA!=0) |> #rm absences
  filter(zone=="europe") |> 
  group_by(species) |> 
  summarise(n=n())
sp.bayes.all=rbind(fecundity.eu_clim |> mutate(block="europe"),
               fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  filter(zone=="europe") |> 
  dplyr::select(plot,lon,lat,species,BA,fecGmMu,fecGmSd,sgdd,wai,pet,map,mat,block,zone) |> 
  filter(BA!=0) |> #rm absences
  mutate(dh=12*pet-map) |> 
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  sample_n(min(nspecies$n)) |> 
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.temp=case_when(mat<=weighted.quantile(mat,w=BA, prob=0.33)[[1]]~"cold",
                               mat<weighted.quantile(mat,w=BA, prob=0.66)[[1]]&
                                 mat>weighted.quantile(mat,w=BA, prob=0.33)[[1]]~"midtemp",
                               mat>=weighted.quantile(mat,w=BA, prob=0.66)[[1]]~"hot"),
         margin.deficit=case_when(dh<=weighted.quantile(dh,w=BA, prob=0.33)[[1]]~"humid",
                              dh<weighted.quantile(dh,w=BA, prob=0.66)[[1]]&
                                 dh>weighted.quantile(dh,w=BA, prob=0.33)[[1]]~"midhum",
                               dh>=weighted.quantile(dh,w=BA, prob=0.66)[[1]]~"arid")) |>
  mutate(margin.temp=factor(margin.temp,levels=c("midtemp","cold","hot")),
         margin.deficit=factor(margin.deficit,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.temp)&!is.na(margin.deficit)) |> 
  ungroup() |> 
  mutate(ISP=fecGmMu/BA,
         s_ISP=fecGmSd/(BA^2))

sp.zone=sp.bayes.all |> 
  filter(zone=="europe")

mid_isp<-sp.zone |> 
    group_by(species,margin.temp,margin.deficit) |> 
    summarise(mid_isp=median(ISP)[[1]]) |> 
    filter(margin.temp=="midtemp"&margin.deficit=="midhum") |>
    ungroup() |> 
    dplyr::select(species,mid_isp)

sp.zone=sp.zone |>
  left_join(mid_isp) |>
  mutate(dISP=ISP/mid_isp,
         s_ISP=s_ISP/(mid_isp^2))

X=model.matrix(~margin.temp*margin.deficit, sp.zone)

data_zone=list(N=dim(sp.zone)[1],
                 NX=ncol(X),
                 S=nlevels(as.factor(sp.zone$species)),
                 species=as.numeric(as.factor(sp.zone$species)),
                 ISP=sp.zone$dISP,
                 X=X,
                 NULL)
fit.zone.2 <- stan(file = "lmm_dif.stan",
                 data=data_zone,
                 iter=1000,
                 chains=3,
                 core=3,
                 include=FALSE,
                 pars=c("beta_raw"))


posteriors_fec<-as.data.frame(fit.zone.2) |>
  dplyr::select(!matches("beta_")) |>
  dplyr::select(matches("beta"))
colnames(posteriors_fec)[1:ncol(X)]=colnames(X)
  
contrast_cor=as.data.frame(X) |>
    unique() |>
    mutate(margin.temp=case_when(margin.tempcold==1~"cold",
                                 margin.temphot==1~"hot",
                                 TRUE~"midtemp"),
           margin.deficit=case_when(margin.deficithumid==1~"humid",
                                 margin.deficitarid==1~"arid",
                                 TRUE~"midhum"),
           zone=z) |> 
    mutate(margin.temp=factor(margin.temp,levels=c("cold","midtemp","hot")),
           margin.deficit=factor(margin.deficit,levels=c("arid","midhum","humid"))) |> 
    tibble::rownames_to_column(var = "code") |> 
    dplyr::select(code,margin.temp,margin.deficit,zone) |> 
    mutate(contrast=paste0(margin.temp,"_",margin.deficit))
contrast_mat= X |> unique() |>  t()
contrast_post=as.matrix(posteriors_fec)[,1:ncol(X)] %*% contrast_mat

obs.group=sp.zone |> group_by(margin.temp,margin.deficit) |> 
  mutate(margin.temp=factor(margin.temp,levels=c("cold","midtemp","hot")),
           margin.deficit=factor(margin.deficit,levels=c("arid","midhum","humid"))) |> 
  summarise(n=n())
as.data.frame(contrast_post) |>
                 pivot_longer(cols=everything(),
                              names_to = "code") |>
                 left_join(contrast_cor,by="code") |>
  ggplot(aes(margin.temp,value,color=margin.deficit))+
  geom_boxplot(outlier.colour = NA)+
  geom_text(data=obs.group,aes(label=n,y=Inf,color=margin.deficit),
            position=position_dodge(width=0.8),
            vjust=1)


sp.zone |> 
  # group_by(species,margin.temp,margin.deficit) |> 
  # summarise(n=n()) |> 
  # ungroup() |> 
  mutate(margin.temp=factor(margin.temp,levels=c("cold","midtemp","hot")),
         margin.deficit=factor(margin.deficit,levels=c("arid","midhum","humid"))) |> 
  ggplot(aes(margin.deficit,fill=species))+
  geom_histogram(stat = "count")+
  facet_wrap(~margin.temp)+
  scale_fill_manual(values=viridis(n=13))
```


#### Draft 
```{r}
# draft

zone.t="west"
lim.eu.x=c(min(sp.bayes[sp.bayes$zone==zone.t,"lon"]),
         max(sp.bayes[sp.bayes$zone==zone.t,"lon"]))
lim.eu.y=c(min(sp.bayes[sp.bayes$zone==zone.t,"lat"]),
         max(sp.bayes[sp.bayes$zone==zone.t,"lat"]))
sp.bayes |> 
  # filter(margin.temp=="hot"&margin.deficit=="humid") |> 
  filter(zone==zone.t) |> 
  mutate(species=as.factor(species)) |> 
  sample_n(7000) |> 
  ggplot()+
  geom_point(aes(x=lon,y=lat,color=margin.deficit))+
  geom_sf(data=worldmap,fill=NA)+
  xlim(lim.eu.x)+
  ylim(lim.eu.y)+
  facet_wrap(~species)

sp.plot=rbind(fecundity.eu_clim |> mutate(block="europe"),
               fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  dplyr::select(plot,lon,lat,species,BA,fecGmMu,fecGmSd,sgdd,wai,pet,map,mat,block,zone) |> 
  filter(BA!=0) |> #rm absences
  mutate(dh=12*pet-map) |> 
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.temp=case_when(mat<weighted.quantile(mat,w=BA, prob=0.1)[[1]]~"cold",
                               mat<weighted.quantile(mat,w=BA, prob=0.6)[[1]]&
                                 mat>weighted.quantile(mat,w=BA, prob=0.4)[[1]]~"midtemp",
                               mat>weighted.quantile(mat,w=BA, prob=0.9)[[1]]~"hot"),
         margin.deficit=case_when(dh<weighted.quantile(dh,w=BA, prob=0.1)[[1]]~"humid",
                              dh<weighted.quantile(dh,w=BA, prob=0.6)[[1]]&
                                 dh>weighted.quantile(dh,w=BA, prob=0.4)[[1]]~"midhum",
                               dh>weighted.quantile(dh,w=BA, prob=0.9)[[1]]~"arid"),
         cor.mat.dh=cor(dh,mat,use="complete.obs")) |>
  mutate(margin.temp=factor(margin.temp,levels=c("midtemp","cold","hot")),
         margin.deficit=factor(margin.deficit,levels=c("midhum","arid","humid"))) |> 
  ungroup() |> 
  mutate(ISP=fecGmMu/BA,
         s_ISP=fecGmSd/(BA^2)) |> 
  mutate(comb.margin=case_when(margin.temp=="cold"&margin.deficit=="arid"~1,
                               margin.temp=="cold"&margin.deficit=="midhum"~2,
                               margin.temp=="cold"&margin.deficit=="humid"~3,
                               margin.temp=="midtemp"&margin.deficit=="arid"~4,
                               margin.temp=="midtemp"&margin.deficit=="midhum"~5,
                               margin.temp=="midtemp"&margin.deficit=="humid"~6,
                               margin.temp=="hot"&margin.deficit=="arid"~7,
                               margin.temp=="hot"&margin.deficit=="midhum"~8,
                               margin.temp=="hot"&margin.deficit=="humid"~9,
                               TRUE~NA))



for (sp in unique(sp.plot$species)){
  print(sp)
  gg<-sp.plot |> 
    filter(species==sp) |> 
    ggplot(aes(mat,dh,color=as.factor(comb.margin)))+
    geom_point(size=0.9)+
    scale_color_manual(values=viridis(n=9))
  ggsave(plot=gg, filename = paste0("fig_clim/",sp,".png" ))
}
sp="pseudotsMenziesi"
sp.plot |> 
  filter(species==sp) |> 
  filter(ISP<2000) |> 
  # filter(margin.deficit=="arid") |> 
  ggplot(aes(mat,log(ISP)))+
  geom_point()+
  geom_smooth(method="gam")+
  facet_wrap(~margin.deficit)

sp.plot |> 
  filter(species==sp) |> 
  # filter(margin.deficit=="arid") |> 
  filter(ISP<2000) |> 
  ggplot(aes(dh,log(ISP)))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~margin.temp)

model.matrix(~margin.temp*map, sp.zone)
```


#### taxa



```{r}
zone=phylo.select |> dplyr::select(zone) |> filter(!is.na(zone)) |> unique() |> pull(zone)
sp.bayes=rbind(fecundity.eu_clim |> mutate(block="europe"),
               fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  dplyr::select(plot,lon,lat,species,taxa,BA,fecGmMu,fecGmSd,sgdd,wai,pet,map,mat,block,zone) |> 
  filter(BA!=0) |> #rm absences
  mutate(dh=12*pet-map) |> 
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.temp=case_when(mat<weighted.quantile(mat,w=BA, prob=0.1)[[1]]~"cold",
                               mat<weighted.quantile(mat,w=BA, prob=0.6)[[1]]&
                                 mat>weighted.quantile(mat,w=BA, prob=0.4)[[1]]~"midtemp",
                               mat>weighted.quantile(mat,w=BA, prob=0.9)[[1]]~"hot"),
         margin.deficit=case_when(dh<weighted.quantile(dh,w=BA, prob=0.1)[[1]]~"humid",
                              dh<weighted.quantile(dh,w=BA, prob=0.6)[[1]]&
                                 dh>weighted.quantile(dh,w=BA, prob=0.4)[[1]]~"midhum",
                               dh>weighted.quantile(dh,w=BA, prob=0.9)[[1]]~"arid"),
         cor.mat.dh=cor(dh,mat,use="complete.obs")) |>
  mutate(margin.temp=factor(margin.temp,levels=c("midtemp","cold","hot")),
         margin.deficit=factor(margin.deficit,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.temp)&!is.na(margin.deficit)) |> 
  ungroup() |> 
  mutate(ISP=fecGmMu/BA,
         s_ISP=fecGmSd/(BA^2))

mid_isp<-sp.bayes |> 
  group_by(species,margin.temp,margin.deficit) |> 
  summarise(mid_isp=median(ISP)[[1]]) |> 
  filter(margin.temp=="midtemp"&margin.deficit=="midhum") |>
  ungroup() |> 
  dplyr::select(species,mid_isp)
post.taxa=data.frame(code=as.character(0),
                value=as.numeric(0),
                margin.temp=as.factor(0),
                margin.deficit=as.factor(0),
                zone=as.character(0),
                contrast=as.character(0))
for(z in c("gymnosperm","angiosperm")){
  print(z)
  file=paste0("mod_fit4/lm_int_",z,".RData")
  sp.zone=sp.bayes |> 
    # filter(taxa==z) |> 
    left_join(mid_isp) |>
    mutate(dISP=ISP/mid_isp,
           s_ISP=s_ISP/(mid_isp^2))
  
  X=model.matrix(~margin.temp*margin.deficit*taxa, sp.zone)
  
  
  if(file.exists(file)){
    load(file)
  }else{
    data_zone=list(N=dim(sp.zone)[1],
                 NX=ncol(X),
                 S=nlevels(as.factor(sp.zone$species)),
                 species=as.numeric(as.factor(sp.zone$species)),
                 ISP=sp.zone$dISP,
                 X=X,
                 NULL)
    fit.zone <- stan(file = "lmm_dif.stan",
                     data=data_zone,
                     iter=1000,
                     chains=3,
                     core=3,
                     include=FALSE,
                     pars=c("beta_raw"))
    save(fit.zone,file=file)
  
  }
  
  
  posteriors_fec<-as.data.frame(fit.zone) |>
    dplyr::select(!matches("beta_")) |>
    dplyr::select(matches("beta"))
  colnames(posteriors_fec)[1:ncol(X)]=colnames(X)
  
  contrast_cor=as.data.frame(X) |>
    unique() |>
    mutate(margin.temp=case_when(margin.tempcold==1~"cold",
                                 margin.temphot==1~"hot",
                                 TRUE~"mid"),
           margin.deficit=case_when(margin.deficithumid==1~"humid",
                                 margin.deficitarid==1~"arid",
                                 TRUE~"mid"),
           zone=z) |> 
    mutate(margin.temp=factor(margin.temp,levels=c("cold","mid","hot")),
           margin.deficit=factor(margin.deficit,levels=c("arid","mid","humid"))) |> 
    tibble::rownames_to_column(var = "code") |> 
    dplyr::select(code,margin.temp,margin.deficit,zone) |> 
    mutate(contrast=paste0(margin.temp,"_",margin.deficit))
  contrast_mat= X |> unique() |>  t()
  contrast_post=as.matrix(posteriors_fec)[,1:ncol(X)] %*% contrast_mat

  post.taxa=bind_rows(post.taxa,
                 as.data.frame(contrast_post) |>
                   pivot_longer(cols=everything(),
                                names_to = "code") |>
                   left_join(contrast_cor,by="code"))
  
}

post.taxa |> 
  filter(code!=0) |> 
  ggplot(aes(margin.temp,value,color=margin.deficit))+
  geom_boxplot(outlier.colour = NA)+
  facet_wrap(~zone)

zone.t="europe"
lim.eu.x=c(min(sp.bayes[sp.bayes$zone==zone.t,"lon"]),
         max(sp.bayes[sp.bayes$zone==zone.t,"lon"]))
lim.eu.y=c(min(sp.bayes[sp.bayes$zone==zone.t,"lat"]),
         max(sp.bayes[sp.bayes$zone==zone.t,"lat"]))
sp.bayes |> 
  filter(margin.temp=="hot"&margin.deficit=="humid") |> 
  filter(zone==zone.t) |> 
  mutate(species=as.factor(species)) |> 
  ggplot()+
  geom_point(aes(x=lon,y=lat,color=species))+
  geom_sf(data=worldmap,fill=NA)+
  xlim(lim.eu.x)+
  ylim(lim.eu.y)+
  theme(legend.position = "none")

as.data.frame(contrast_post) |>
                   pivot_longer(cols=everything(),
                                names_to = "code") |>
                   left_join(contrast_cor,by="code") |> 
  ggplot(aes(margin.temp,value,color=margin.deficit))+
  geom_boxplot(outlier.colour = NA)+
  facet_wrap(~zone)


sp.bayes |> 
  filter(taxa=="gymnosperm"&margin.temp=="cold"&margin.deficit=="midhum") |> 
  # filter(zone==zone.t) |> 
  mutate(species=as.factor(species)) |> 
  ggplot()+
  geom_point(aes(x=lon,y=lat,color=species))+
  geom_sf(data=worldmap,fill=NA)+
  xlim(c(-120,35))+
  ylim(c(20,70))+
  theme(legend.position = "none")
```

## LM with interactions between margins and contiuous var
## LMM with interactions between margins, continent effect

```{r lmmInteractionsCont}
mod.lme = lme(ISP ~ margin.sgdd * margin.wai * zone, 
              random = ~ 1 | species, 
             weights = varFixed(~cv_plot), 
             data = sp.mod)
mod.lme.sigma = lme(ISP ~ margin.sgdd * margin.wai * block, 
              random = ~ 1 | species, 
             weights = varFixed(~cv_plot), 
             data = sp.mod,
             control=lmeControl(sigma = 1))
summary(mod.lme)$tTable
anova(mod.lme)


# predictions 
data.predict=sp.mod |> 
  dplyr::select(block,margin.sgdd,margin.wai) |> 
  unique()

data.predict<-bolker_ci(mod.lme,data.predict)


data.predict |> 
  mutate(margin.sgdd=if_else(margin.sgdd=="midtemp","Core",
                            stringr::str_to_title(margin.sgdd)),
         margin.wai=if_else(margin.wai=="midhum","Core",
                            stringr::str_to_title(margin.wai))) |> 
  ggplot(aes(color=block))+
  geom_point(aes(margin.wai,pred))+
  geom_segment(aes( x = margin.wai,xend=margin.wai,y=ci_l,yend=ci_h))+
  scale_color_manual(values=c("firebrick3","cornflowerblue"))+
  labs(x="Margin relative to the SGDD gradient",
       y="Predictions",
       color="Continent")+
  facet_wrap(~margin.sgdd)->p
p
# ggsave("interactioncont.pdf",plot=p)


mod.means=emmeans(object=mod.lme,
        specs=~margin.wai*margin.sgdd,
        by="zone")
data_pred=cld(object=mod.means,
    adjust="Tukey",
    Letters=letters,
    alpha=0.05)
contrast(mod.means)
pairs(mod.means)


adjust_width <- -0.05  

data_pred_adj <- as.data.frame(data_pred) %>%
  mutate(margin.sgdd = if_else(margin.sgdd == "midtemp", "Core", stringr::str_to_title(margin.sgdd)),
         margin.wai = if_else(margin.wai == "midhum", "Core", stringr::str_to_title(margin.wai)),
         x_adjusted = as.numeric(as.factor(margin.wai))/6 + 
           if_else(zone == "europe", 
                   adjust_width, 
                   if_else(zone== "east",
                           -adjust_width,
                           0)))

ggplot(data_pred_adj, aes(color = zone)) +
  geom_point(aes(x_adjusted, emmean)) +
  geom_segment(aes(x = x_adjusted, xend = x_adjusted, y = lower.CL, yend = upper.CL)) +
  scale_color_manual(values = c("firebrick3", "cornflowerblue","tan1")) +
  geom_text(aes(label = str_trim(.group), x = x_adjusted, y = emmean), hjust = 1.6,vjust=1) +
  labs(x = "Margin relative to the SGDD gradient",
       y = "Predictions",
       color = "Continent") +
  scale_x_continuous(breaks = as.numeric(as.factor(unique(data_pred_adj$margin.wai)))/6, 
                     labels = unique(data_pred_adj$margin.wai))+
  facet_wrap(~margin.sgdd)+
  theme(panel.background = element_rect(fill = NA, color = "black"))-> p
# ggsave(filename="interactioncont_tukey.pdf",scale=1.8,width=15,height=8,units="cm",plot=p)

p
q


```

## control for species proximity

```{r eval=FALSE, include=FALSE}
phylo.select |> 
  group_by(genus) |> 
  summarise(n=length(unique(block))) |> 
  arrange(desc(n)) |> 
  filter(n>1) |> 
  pull(genus)->genus.select
sp.mod=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  left_join(phylo.select) |> 
  filter(genus %in% genus.select) |> 
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.2)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.6)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.4)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.8)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.2)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.6)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.4)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.8)[[1]]~"humid"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("midtemp","cold","hot")),
         margin.wai=factor(margin.wai,levels=c("midhum","arid","humid"))) |> 
  filter(!is.na(margin.sgdd)&!is.na(margin.wai)) |>
  ungroup() |> 
  mutate(ISP=scale(log(ISP))) 


## by genus ## 

# mod.lme = lme(ISP ~ margin.sgdd * margin.wai * block, 
#               random = ~ 1 | genus/species, 
#              weights = varFixed(~cv_plot), 
#              data = sp.mod)
# summary(mod.lme)$tTable
# anova(mod.lme)

mod.lmegenus = lme(ISP ~ margin.sgdd * margin.wai * block*genus, 
              random = ~ 1 | species, 
             weights = varFixed(~cv_plot), 
             data = sp.mod)
summary(mod.lmegenus)$tTable
anova(mod.lmegenus)


mod.means=emmeans(object=mod.lmegenus,
        specs=~margin.wai*margin.sgdd*block,
        by=c("genus","margin.sgdd"))

data_pred=cld(object=mod.means,
    adjust="Tukey",
    Letters=letters,
    alpha=0.05)
contrast(mod.means)
pairs(mod.means)


adjust_width <- -0.05  

data_pred_adj <- as.data.frame(data_pred) %>%
  mutate(margin.sgdd = if_else(margin.sgdd == "midtemp", "Core", stringr::str_to_title(margin.sgdd)),
         margin.wai = if_else(margin.wai == "midhum", "Core", stringr::str_to_title(margin.wai)),
         x_adjusted = as.numeric(as.factor(margin.wai))/6 + if_else(block == "europe", adjust_width, 0))

ggplot(data_pred_adj, aes(color = block)) +
  geom_point(aes(x_adjusted, emmean)) +
  geom_segment(aes(x = x_adjusted, xend = x_adjusted, y = lower.CL, yend = upper.CL)) +
  scale_color_manual(values = c("firebrick3", "cornflowerblue")) +
  geom_text(aes(label = gsub(" ","",.group), x = x_adjusted, y = emmean+2.5) ) + #y = emmean hjust = 1.4,vjust=1
  labs(x = "Margin relative to the SGDD gradient",
       y = "Predictions",
       color = "Continent") +
  scale_x_continuous(breaks = as.numeric(as.factor(unique(data_pred_adj$margin.wai)))/6, 
                     labels = unique(data_pred_adj$margin.wai))+
  facet_grid(genus~margin.sgdd)+
  theme(panel.background = element_rect(fill = NA, color = "black"))#-> p
# ggsave(filename="interactioncont_tukey.pdf",scale=1.8,width=15,height=8,units="cm",plot=p)




## by taxa ##
mod.lmetaxa = lme(ISP ~ margin.sgdd * margin.wai * block * taxa, 
              random = ~ 1 | species, 
             weights = varFixed(~cv_plot), 
             data = sp.mod)
anova(mod.lmegenus)


mod.means=emmeans(object=mod.lmetaxa,
        specs=~margin.wai*margin.sgdd,
        by=c("taxa","block"))
data_pred=cld(object=mod.means,
    adjust="Tukey",
    Letters=letters,
    alpha=0.05)
contrast(mod.means)
pairs(mod.means)

data.predict |> 
  mutate(margin.sgdd=if_else(margin.sgdd=="midtemp","Core",
                            stringr::str_to_title(margin.sgdd)),
         margin.wai=if_else(margin.wai=="midhum","Core",
                            stringr::str_to_title(margin.wai))) |> 
  ggplot(aes(color=block))+
  geom_point(aes(margin.wai,pred))+
  geom_segment(aes( x = margin.wai,xend=margin.wai,y=ci_l,yend=ci_h))+
  scale_color_manual(values=c("firebrick3","cornflowerblue"))+
  labs(x="Margin relative to the SGDD gradient",
       y="Predictions",
       color="Continent")+
  facet_grid(genus~margin.sgdd)

```


```{r eval=FALSE, include=FALSE}
# only account for genus differences
mod.lme = lme(ISP ~ margin.sgdd * margin.wai * block, 
              random = ~ 1 | genus, 
             weights = varFixed(~cv_plot), 
             data = sp.mod)
summary(mod.lme)$tTable
anova(mod.lme)

# predictions 
data.predict=sp.mod |> 
  dplyr::select(block,genus,margin.sgdd,margin.wai) |> 
  unique()
conf_level = 0.95
z <- round(qnorm((1-conf_level)/2, lower.tail = FALSE), 2)

data.predict$pred=unname(predict(mod.lme,newdata = data.predict))

boot_fn <- function(data, indices) {
  boot_data <- data[indices, ]
  mod_boot <- update(mod.lme, data = boot_data)
  return(predict(mod_boot, newdata = data.predict, level = 0))
}

# Perform bootstrap
boot_results <- boot::boot(data = sp.mod, statistic = boot_fn, R = 1000)

# Compute standard errors of the predictions
data.predict$pred_se <- apply(boot_results$t, 2, sd)
data.predict$ci_l <- data.predict$pred - z*data.predict$pred_se
data.predict$ci_h<- data.predict$pred + z*data.predict$pred_se

data.predict |> 
  # filter(genus=="Fagus") |>
  mutate(margin.sgdd=if_else(margin.sgdd=="midtemp","Core",
                            stringr::str_to_title(margin.sgdd)),
         margin.wai=if_else(margin.wai=="midhum","Core",
                            stringr::str_to_title(margin.wai))) |> 
  ggplot(aes(color=block))+
  geom_point(aes(margin.wai,pred))+
  geom_segment(aes( x = margin.wai,xend=margin.wai,y=ci_l,yend=ci_h))+
  scale_color_manual(values=c("firebrick3","cornflowerblue"))+
  labs(x="Margin relative to the SGDD gradient",
       y="Predictions",
       color="Continent")+
  facet_grid(genus~margin.sgdd)
```


Test of delineation of climatic groups
```{r eval=FALSE, include=FALSE}
classif.sp=df.gbif.short |> dplyr::select(species,clim,opt) |> pivot_wider(names_from = clim,values_from = opt)
species.acp=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  left_join(phylo.select) |> 
  summarise(mean.slope=median(slope,na.rm=TRUE),
            mean.wai=mean(wai,na.rm=TRUE)) |> left_join(classif.sp)
species.acp$categorie <- as.factor(kmeans(species.acp[,2:6],centers=3)$cluster)

acp=FactoMineR::PCA(species.acp[,2:7], quali.sup = 6)

fviz_pca_ind(acp,col.ind = species.acp$categorie)
# Préparer les données pour ggplot
ind.coord <- as.data.frame(acp$ind$coord)
ind.coord$categorie <- df$categorie

# Faire le plot
ggplot(ind.coord, aes(x = Dim.1, y = Dim.2, color = categorie)) +
  geom_point(aes(shape = categorie), size = 4) +
  theme_minimal()

sp.dataset |> 
  group_by(species) |> 
  summarise(mean.alt=mean(al) |> 
  arrange(species,desc(n)) |> 
  group_by(species) |> 
  filter(n==max(n)) |> 
  arrange(ecoReg)
```


# Hypothesis 3 : changes in fecundity is dependant on the position of species niche in the climatic space

Test: using linear models per species, we test that the coefficient associated with the hot margin is even higher if the targeted species niche is in a climatic space not limited per drought.

```{r Spcoeff}
sp.dataset.lm=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"humid"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs"),
         weight=fecGmMu_plot/(se_plot^(3/2)),
         mean.wai=mean(wai,na.rm=TRUE),
         mean.sgdd=mean(sgdd,na.rm=TRUE),
         mean.tmin=mean(tmin,na.rm=TRUE)) |> 
  pivot_longer(cols=c("margin.sgdd","margin.wai"),
               names_to="margin.type",
               values_to="margin.val") |> 
  filter(!is.na(margin.val)) |> # position importante pour le scaling!!
  mutate(margin.val=factor(margin.val,levels=c("midtemp","cold","hot","midhum","arid","humid"))) |> 
         # ISP=(ISP-weighted.mean(ISP,w=1/cv_plot))/sqrt(weighted.var(ISP,w=1/cv_plot))) |>
  ungroup() |>
  as.data.table()
# sp.dataset.lm |> 
#   sample_n(50000) |> 
#   ggplot(aes(weight,ISP))+
#   geom_point()+
#   scale_x_log10()

summary.mod=sp.dataset.lm |> 
  dplyr::select(species,block,mean.wai,mean.sgdd,mean.tmin) |> 
  unique() |> 
  mutate(margincold.est=0,
         margincold.sd=0,
         marginhot.est=0,
         marginhot.sd=0,
         marginhum.est=0,
         marginhum.sd=0,
         margindry.est=0,
         margindry.sd=0)
for(sp in unique(sp.dataset.lm$species)){
  print(sp)
  sp.lm=sp.dataset.lm |> 
    filter(species==sp) |> 
    mutate(ISP=scale(log(ISP))[,])
  # sp.lm |> 
  #   ggplot(aes(ISP))+geom_density()
  lm.sgdd=lm(ISP~margin.val,
            weights = 1/cv_plot, #weight, 
            data=sp.lm |> 
              filter(margin.type=="margin.sgdd"))
  lm.wai=lm(ISP~margin.val,
            weights = 1/cv_plot, #weight,
            data=sp.lm |> 
              filter(margin.type=="margin.wai"))
  # sp.lm |>
  #   filter(margin.type=="margin.wai") |>
  #   ggplot()+
  #   geom_boxplot(aes(margin.val,ISP,weight=1/cv_plot))
  summary.mod[summary.mod$species==sp,6:13]=
    list(summary(lm.sgdd)$coef["margin.valcold","Estimate"],
      summary(lm.sgdd)$coef["margin.valcold","Std. Error"],
      summary(lm.sgdd)$coef["margin.valhot","Estimate"],
      summary(lm.sgdd)$coef["margin.valhot","Std. Error"],
      summary(lm.wai)$coef["margin.valhumid","Estimate"],
      summary(lm.wai)$coef["margin.valhumid","Std. Error"],
      summary(lm.wai)$coef["margin.valarid","Estimate"],
      summary(lm.wai)$coef["margin.valarid","Std. Error"])
}

summary.mod |> 
  # mutate(weight=abs(mean/sd)) |> 
  pivot_longer(cols=matches("margin")) |> 
  separate(name,into=c("margin","val")) |> 
  pivot_wider(names_from = val,
              values_from = value) |> 
  mutate(margin.type=case_when(grepl("cold|hot",margin)~"sgdd",
                               TRUE~"wai")) |> 
  ggplot()+
  geom_density(aes(x=est,y=..density..,weight=1/sd,color=block))+
  geom_vline(xintercept = 0)+
  facet_wrap(~margin)

summary.mod |> 
  # mutate(weight=abs(mean/sd)) |> 
  pivot_longer(cols=matches("margin")) |> 
  separate(name,into=c("margin","val")) |> 
  pivot_wider(names_from = val,
              values_from = value) |> 
  mutate(margin.type=case_when(grepl("cold|hot",margin)~"sgdd",
                               TRUE~"wai"))|> 
  ggplot()+
  geom_violin(aes(est,margin,weight=1/sd,color=block))


summary.mod |> 
  # mutate(weight=abs(mean/sd)) |> 
  pivot_longer(cols=matches("margin")) |> 
  separate(name,into=c("margin","val")) |> 
  pivot_wider(names_from = val,
              values_from = value) |> 
  mutate(margin.type=case_when(grepl("cold|hot",margin)~"sgdd",
                               TRUE~"wai")) |> 
  ggplot(aes(mean.tmin,est))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~margin)
  
summary.mod |> 
  left_join(sp.dataset |> dplyr::select(species,block,cor.wai.sgdd) |> unique()) |>
  ggplot(aes(margincold.est,marginhot.est,color=block))+
  geom_point()+
  coord_equal() + geom_hline(yintercept = 0) + geom_vline(xintercept = 0)
summary.mod |> 
  ggplot(aes(margincold.est,margindry.est))+
  geom_point()+
  coord_equal() + geom_hline(yintercept = 0) + geom_vline(xintercept = 0)
summary.mod |> 
  left_join(sp.dataset |> dplyr::select(species,block) |> unique()) |>
  ggplot(aes(marginhum.est,margindry.est,color=block))+
  geom_point()+
  coord_equal() + geom_hline(yintercept = 0) + geom_vline(xintercept = 0)


summary.mod |> 
  left_join(sp.dataset |> dplyr::select(species,block,cor.wai.sgdd) |> unique()) |>
  ggplot(aes(marginhot.est,margincold.est,color=cor.wai.sgdd>0))+
  geom_point()+ geom_hline(yintercept = 0) + geom_vline(xintercept = 0)

summary.mod |> 
  # mutate(weight=abs(mean/sd)) |> 
  pivot_longer(cols=matches("margin")) |> 
  separate(name,into=c("margin","val")) |> 
  pivot_wider(names_from = val,
              values_from = value) |> 
  mutate(margin.type=case_when(grepl("cold|hot",margin)~"sgdd",
                               TRUE~"wai"))|> 
  left_join(sp.dataset |> dplyr::select(species,block,cor.wai.sgdd) |> unique()) |>
  ggplot(aes(cor.wai.sgdd,est,col=block))+
  geom_point()+
  geom_smooth(method="lm",aes(color=NULL))+
  facet_wrap(~margin)

sp.dataset.lm |> 
  # filter(species%in% species.sample) |> 
  ggplot()+
  geom_density(aes(x=log(ISP),y=..density..,weight=1/cv_plot,color=species))+
  theme(legend.position = "none")+
  facet_wrap(~species,scales="free")
sp.dataset.lm |> 
  # filter(species%in% species.sample) |> 
  ggplot()+
  geom_density(aes(x=log(ISP),y=..density..,weight=weight,color=species))+
  theme(legend.position = "none")+
  facet_wrap(~species,scales="free")
```


```{r}
res.pca=PCA(summary.mod[,c("mean.wai","mean.tmin","mean.sgdd")])
res.pca=PCA(summary.mod[,grep("mean|margin",colnames(summary.mod)),with=FALSE],quanti.sup=4:11)
res.pca=PCA(summary.mod[,c(3:6,8,10,12),with=FALSE],quanti.sup=4:7)

```


# Annexe 

## Old methods 

This model does not account for weight. Also issues about scaling of variables
```{r lmer, eval=FALSE, include=FALSE}
# effect per species
sp.mod=sp.dataset |> filter(margin.type=="margin.sgdd")
mod.fec.margin=lm(ISP~species + species:margin.val,data=sp.mod)
summary=as.data.frame(summary(mod.fec.margin)$coefficients)

summary |> 
  # format model output
  tibble::rownames_to_column(var="species") |> 
  filter(grepl(":",species)) |> # select only interaction coeff
  separate(species,into=c("species","margin"),sep=":") |> 
  mutate(species=str_sub(species,8,-1)) |> 
  arrange(species) |> 
  group_by(species) |>
  dplyr::select(species,margin,Estimate,`Std. Error`) |> 
  rename(mean=Estimate,
         sd=`Std. Error`) |> 
  pivot_wider(names_from = margin,
              values_from = c("mean","sd")) |> 
  left_join(sp.dataset |> dplyr::select(species,block) |> unique()) |>
  ggplot(aes(mean_margin.valcold,mean_margin.valhot,col=block))+
  geom_point()+
  geom_errorbarh(aes(xmin=mean_margin.valcold-sd_margin.valcold,
                     xmax=mean_margin.valcold+sd_margin.valcold))+
  geom_errorbar(aes(ymin=mean_margin.valhot-sd_margin.valhot,
                     ymax=mean_margin.valhot+sd_margin.valhot))+
  coord_equal()+
  theme(legend.position = "none")
summary |> 
  tibble::rownames_to_column(var="species") |> 
  filter(grepl(":",species)) |> 
  separate(species,into=c("species","margin"),sep=":") |> 
  mutate(species=str_sub(species,8,-1)) |> 
  arrange(species) |> 
  group_by(species) |>
  dplyr::select(species,margin,Estimate,`Std. Error`) |> 
  rename(mean=Estimate,
         sd=`Std. Error`) |> 
  ungroup() |> 
  left_join(sp.dataset |> dplyr::select(species,block) |> unique()) |>
  mutate(weight=abs(mean/sd)) |> 
  ggplot()+
  # geom_point(aes(margin,mean,color=block))
  geom_boxplot(aes(margin,mean,weight=weight,color=block))

 
rm(sp.mod,mod.fec.margin,summary)
```


## Question pour GK
- scaling des variables : scaling par espèce et ensuite filtre avec que les marges -> permet de vraiment capter les différences. Ordre change beaucoup le résultat!!
- quand faut-il prendre en compte le poids? scaling des variables? fit du modèle? Les deux c'est un peu trop non?
- comment prendre en compte la corrélation? a part montrer qu'elle est distribuée différement entre continent, difficile de montrer qu'elle est liée directement aux paramètres des marges.
- est ce que regarder que les intéractions c'est ok? prise en compte notamment de l'intercept par espèce. Mais si c'est les ISP sont scale normalement leur moyenne est a zero. faut-il les scale avant filtrer ...


## Per species


## Test of effect of correlation

```{r corrfig, eval=FALSE, include=FALSE}
sp.dataset.lm=rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"colddry",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"coldint",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"coldhum",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"intdry",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"int",
                                sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"inthum",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"hotdry",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"hotint",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"hothum"),
         weight=fecGmMu_plot/(se_plot^(3/2))) |> 
  filter(!is.na(margin)) |> # position importante pour le scaling!!
  mutate(cor.wai.sgdd=cor(wai,sgdd,use="complete.obs"),
         margin=factor(margin,levels=c("colddry","coldint","coldhum","intdry","int","inthum","hotdry","hotint","hothum"))) |> 
         # ISP=(ISP-weighted.mean(ISP,w=1/cv_plot))/sqrt(weighted.var(ISP,w=1/cv_plot))) |>
  ungroup() |>
  as.data.table()

sp.dataset.lm |> 
  dplyr::select(species,cor.wai.sgdd,block) |> 
  unique() |> 
  ggplot(aes(cor.wai.sgdd,
           color=block))+
  geom_density()

sp.dataset.lm |> 
  mutate(ISP=scale(ISP)) |> 
  ggplot(aes(margin,ISP))+
  geom_boxplot()+
  scale_y_log10()

sp.dataset.lm |> 
  ggplot(aes(margin))+
  geom_histogram(stat="count")+
  facet_wrap(~species)
sp.dataset.lm |>
  ggplot(aes(sgdd,wai,color=margin))+
  geom_point() +
  geom_smooth()+
  facet_wrap(~species)

species.sample= sample(unique(sp.dataset.lm$species),8)
rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  mutate(cor.wai.sgdd=cor(wai,sgdd,use="complete.obs"),
         mean.wai=mean(wai,na.rm=FALSE),
         mean.sgdd=mean(sgdd,na.rm=FALSE)) |> 
  ungroup() |> 
  # filter(species %in% species.sample) |> 
  ggplot(aes(wai,sgdd,color=cor.wai.sgdd))+
  geom_point(alpha=0.5) + 
  geom_smooth(method="lm")+
  facet_wrap(~species)


rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"colddry",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"coldint",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"coldhum",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"intdry",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"int",
                                sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"inthum",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"hotdry",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]&
                                 wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"hotint",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"hothum"),
         weight=fecGmMu_plot/(se_plot^(3/2))) |> 
  mutate(cor.wai.sgdd=cor(wai,sgdd,use="complete.obs"),
         margin=factor(margin,levels=c("colddry","coldint","coldhum","intdry","int","inthum","hotdry","hotint","hothum"))) |> 
         # ISP=(ISP-weighted.mean(ISP,w=1/cv_plot))/sqrt(weighted.var(ISP,w=1/cv_plot))) |>
  ungroup() |>
  ggplot(aes(wai,sgdd,color=margin))+
  geom_point(alpha=0.5) + 
  geom_smooth(aes(color=NULL),method="lm")+
  facet_wrap(~species)
  

```




## slope 

Compute slope
```{r slope, eval=FALSE, include=FALSE}
r<- fecundity.eu_clim |>
  mutate(block="europe") |> 
  filter(species=="fagusSylvatic") |>
  filter(BA!=0) |> #rm absences
  mutate(ISP=scale(log(ISP)),
         fecGmMu=scale(log(fecGmMu))) |> 
  # group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot),
         wai=cut(wai,breaks=20),
         sgdd=cut(sgdd,breaks=20)) |> # compute cv for missing values
  ungroup() |> group_by(species,wai,sgdd) |> 
  summarise(ISP.mean=weighted.mean(ISP,w=1/cv_plot)) |> 
  ungroup()|> 
  complete(sgdd,wai)  |> 
  arrange(sgdd,wai) |> 
  filter(!is.na(wai))
  #  ggplot(aes(x = sgdd, y = wai, fill = ISP.mean)) +
  # geom_tile() +
  # scale_fill_gradientn(colours = viridis(15))+
  # theme(axis.text = element_blank())

fect.rast<-terra::rast(nrows=nlevels(r$wai),
                ncols=nlevels(r$sgdd))
fect.rast[]<-r$ISP.mean
plot(terra::slope(fect.rast))

```



```{r pointposition, eval=FALSE, include=FALSE}
rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.05)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.475)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.95)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.05)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.475)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.95)[[1]]~"humid"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  pivot_longer(cols=c("margin.sgdd","margin.wai"),
               names_to="margin.type",
               values_to="margin.val") |> 
  filter(!is.na(margin.val)) |> # position importante pour le scaling!!
  mutate(margin.val=factor(margin.val,levels=c("midtemp","cold","hot","midhum","arid","humid"))) |> 
         # ISP=(ISP-weighted.mean(ISP,w=1/cv_plot))/sqrt(weighted.var(ISP,w=1/cv_plot))) |>
  ungroup() |> 
  mutate(ISP=log(ISP)) |>
  pivot_wider(names_from = "margin.type",
              values_from = "margin.val") |> 
  # mutate(across(matches("margin"),~replace_na(as.character(.x),"inter"))) |> 
  mutate(margin.sgdd=case_when(is.na(margin.sgdd)~"midtemp",
                               TRUE~as.character(margin.sgdd)),
         margin.wai=case_when(is.na(margin.wai)~"midhum",
                               TRUE~as.character(margin.wai))) |> 
  mutate(margin.sgdd=factor(margin.sgdd,levels=c("cold","midtemp","hot")),
         margin.wai=factor(margin.wai,levels=c("arid","midhum","humid"))) |> 
  ggplot(aes(margin.sgdd,ISP,color=margin.wai))+
  geom_boxplot()+
  scale_y_log10()+
  facet_wrap(~species,scales="free")
```


### Absolute limits?

```{r}
rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  # compute weighted quantiles of sgdd and wai, and correlation between wai and sgdd
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=BA, prob=0.2)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=BA, prob=0.7)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=BA, prob=0.3)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=BA, prob=0.8)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=BA, prob=0.2)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=BA, prob=0.7)[[1]]&
                                 wai>weighted.quantile(wai,w=BA, prob=0.3)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=BA, prob=0.8)[[1]]~"humid")) |> 
  pivot_longer(cols=c("margin.sgdd","margin.wai"),
               names_to="margin.type",
               values_to="margin.val") |> 
  filter(!is.na(margin.val)) |> 
  mutate(ISP=scale(log(ISP))) |> 
    ungroup() |> 

  # filter(species %in% species.sample) |> 
  ggplot(aes(margin.val,ISP,fill=block))+
  geom_boxplot(aes(weight=1/cv_plot))+
  facet_wrap(~margin.type,scales="free_x")



rbind(fecundity.eu_clim |> mutate(block="europe"),
                 fecundity.am_clim|> mutate(block="america")) |>
  filter(BA!=0) |> #rm absences
  # filter(ISP<quantile(ISP,probs=0.97)) |>  # remove extreme values
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  mutate(ISP=scale(log(ISP))) |> 
  ungroup() |> 
  # filter(species %in% species.sample) |> 
  ggplot(aes(wai,ISP))+
  geom_point()+
  geom_smooth()
```

