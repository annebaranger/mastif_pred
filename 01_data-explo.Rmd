---
title: "Fecundity variability in species niche and distribution - outlines "
author: "Anne Baranger"
date: "2023-04-14"
output:
  bookdown::html_document2: 
    toc: TRUE 
  bookdown::pdf_document2: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE,message=FALSE)
library(targets)
lapply(c("stringr","ggplot2","tidyr","dplyr","rworldmap","modi","tibble","terra","factoextra","sf","data.table","viridis","robustbase","taxize"),require,character.only=TRUE)
theme_set(theme_minimal())
tar_load(mastif.eu,store="target_data")
tar_load(mastif.am,store="target_data")

#tar_load(meanClimate_species,store="target_gbif")

tar_load(species_selection,store="target_nfi")

# species details-get taxo
classification(unique(species_selection$df.gbif$species_l),db="ncbi")->out
class2tree(out,check=FALSE)->out2
species.phylo=out2$classification |> 
  rownames_to_column( var = "species_init") |> 
  mutate(species_l=case_when(is.na(species)~species_init,
                           TRUE~species)) |> 
  select(species_l,genus,family,order,class) |> 
  mutate(taxa=case_when(class=="Pinopsida"~"gymnosperm",
                        class=="Magnoliopsida"~"angiosperm")) |> 
  left_join(unique(species_selection$df.gbif[,c("species","species_l")])) |> 
  unique()
rm(out,out2)


df.mastif.tree=rbind(mastif.am$df.tree,mastif.eu$df.tree) 
df.species=rbind(mastif.am$df.species.select,mastif.eu$df.species.select)
sp.select.eu=species_selection$sp.select.eu
sp.select.am=species_selection$sp.select.am



# small format of gbif
df.gbif.short <- species_selection$df.gbif |>
  separate(clim,into = c("clim","range")) |> 
  pivot_wider(names_from = range,
                values_from = clim_niche)

#compute climate range
df.range<-species_selection$df.gbif |> 
    select(species,clim,clim_niche) |> 
    filter(grepl("range",clim)) |> 
    separate(clim,into=c("var","drop")) |> 
    select(-drop) |> 
    rename(range="clim_niche")

# tar_load(nfi.am_clim,store="target_nfi")
# tar_load(nfi.eu_clim,store="target_nfi")
tar_load(fecundity.eu_clim,store="target_nfi")
tar_load(fecundity.am_clim,store="target_nfi")
```

# Data description
species_selection 
 - df.gbif - niche by species, reformated for use with mastif
 - df.tree_w all tree (in df.tree) with computed weight
 - mastif.range - niche according to mastif plots with the use of weight
 - sp.select.am
 - sp.select.eu

df.nfi.eu/am -  plot of nfi, with size, climate

nfi.eu/am_clim
 - acp of climate variables
 - plots of nfi + etc + predictions of pca first axis

fec.eu/am
 - for each nfi plot, ba/ISP/fecmu/sd and weight of each plot -> scaled to the hectare, long format. all species represented on each plots even if absent

sp.margin.eu/am
 - for each species of the nfi, compute the quantile of pca first axi

fecundity.eu_clim
 - fecundity coupled with climate of plots, and condition of margin

-> fecundity datasets are long formats of nfi plots crossed by species list. It includes non-occurence of species.


# Mastif plots distribution
In this first section we use predictions performed on Mastif calibration plots. We filtered only plots where native european species were growing. In the following we present a map of the 1346 plots sampled in the different Mastif census. We also map plots specific to _Pinus sylvestris_.

```{r MastifPlots, fig.cap="Maps of Mastif calibration plots"}

# df.niche=read.csv("output/sp_gbif_climate.csv",sep=" ")
#plot initial dataset and selection
worldmap <- sf::st_as_sf(getMap(resolution = "high"))


# plots of selected species
df.mastif.tree |> 
  filter(species %in% df.species$species) |> 
  select(species,lon,lat) |> 
  distinct() |> 
  ggplot() +
  geom_sf(data=worldmap,fill=NA) +
  geom_point(aes(x=lon,y=lat,color=species))+
  xlim(range(df.species[,c("minlon","maxlon")])) + 
  ylim(range(df.species[,c("minlat","maxlat")]))+
  theme_minimal()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        legend.position = "none")+
  labs(color="Species")
```


```{r MastifPlotsSp,fig.Cap="Mastif plots of Pinus sylvestris"}
df.mastif.tree |> 
  select(species,lon,lat) |>
  filter(species=="pinusSylvestr") |> 
  distinct() |> 
  ggplot() +
  geom_sf(data=worldmap,fill=NA) +
  geom_point(aes(x=lon,y=lat,color=species))+
  xlim(range(df.species[,c("minlon","maxlon")])) + 
  ylim(range(df.species[,c("minlat","maxlat")]))+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        legend.position = "bottom")+
  labs(color="Species")

rm(worldmap)

```

# Comparing GBIF quantiles and Mastif distribution 

To perform our analysis, we cannot extrapolate Mastif to IFN plots ranging outside the gradient spanned by the mastif plots. Using GBIF and an R routine from GK and JB, we computed 5th and 95th quantiles over 3 climate variables : tmin, map, and mat.
We computed on Mastif database the same quantile, using the plot distribution. However, because data were not collected homogenously, we weighted each observations by the coefficient of variation computed from fecundity predictions and stand error.




Figure  \@ref(fig:ClimateDifFig) presents the difference percentage between GBIF quantiles and wieghted quantiles of Mastif.

```{r ClimateDifFig, fig.cap="Climate difference between GBIF and Mastif quantiles"}
# select ranges computed from mastif plots (with weight)
species_selection$mastif.range |> 
  # merge with gbif range
  left_join(species_selection$df.gbif,by=c("species","clim")) |> 
  filter(!is.na(species_l)) |>  # filter for absent species 
  relocate(species_l,.after=species) |> 
  mutate(dif=100*(clim_obs-clim_niche)/clim_niche) |> 
  ggplot(aes(dif,clim,color=species))+
  geom_point()+
  theme(legend.position = "none")


```


On the following histograms we overlayed the weighted observations of Mastif and the GBIF range (5th and 95th quantiles, and median) for species that were not selected by our algorithm. This enables to glimpse how different are Mastif plots distribution compared to GBIF.


```{r PlotsnSp,fig.cap="Numbers of plots per species"}
df.mastif.tree |> 
  filter(!duplicated(treeID)) |> 
  group_by(species) |> 
  mutate(n_ind=n()) |> ungroup() |> 
  select(species,n_ind,plotID) |> 
  unique() |> 
  group_by(species,n_ind) |> 
  summarise(n=n())


```

Test difference in quantiles and optima, between GBIF and MASTIF :
```{r}
#confront mastif climate quantiles and gbif
species_selection$mastif.range |> 
  separate(clim,into=c("var","quant"),remove=FALSE) |> 
  left_join(df.gbif.short,by=c("species","var"="clim")) |> 
  relocate(species_l,.after=species)|> 
  filter(!is.na(species_l)) |> 
  pivot_longer(cols=c("low","opt","high"),
               names_to = "quant_niche",
               values_to = "clim_niche") |> 
  filter(quant==quant_niche) |>  select(-quant_niche) |> 
  mutate(dif=case_when(grepl("opt",clim)~100*abs(clim_obs-clim_niche)/range,
                       grepl("high",clim)~100*(clim_obs-clim_niche)/range,
                       grepl("low",clim)~100*(clim_niche-clim_obs)/range)) |> 
  ggplot(aes(dif,var,color=var,shape=quant))+
  geom_point()+
  theme_minimal()+
  geom_vline(xintercept=0)+
  facet_wrap(~species)
```

We set a threshold of -50% of difference. We ended up selecting the following species for further analysis:
```{r SpSelect}
sp.select.am
sp.select.eu
```

## diagnosis of deleted species
```{r}
sp.deleted=unique(df.species$species)[!unique(df.species$species)%in% c(sp.select.am,sp.select.eu)] 
for (sp in sp.deleted){
  plot<-species_selection$df.tree_w |>
    select(plotID,species,clim,clim_val,cv_plot,low,high) |> 
    left_join(df.gbif.short,by=c("species","clim")) |> 
    filter(species==sp) |> 
    ggplot()+
    geom_histogram(aes(x=clim_val,y=..density..,weight=1/cv_plot))+
    geom_point(aes(x=opt,y=0),color="darkred",size=1)+
    geom_segment(aes(x=low.y,xend=high.y,y=-0,yend=-0),color="darkred",size=1)+
    geom_vline(aes(xintercept = low.x))+
    geom_vline(aes(xintercept = high.x))+
    facet_wrap(~clim,
               # nrow = 3,
               scales = "free")+
    labs(title=sp)
  print(plot)
  rm(plot)
}
rm(sp.deleted)
```

## Species selection with order statistics

```{r orderstats}
#format data with order stats
df.tree=rbind(mastif.am$df.tree,mastif.eu$df.tree) |>
    # replace 0 estimations by NA and compute, rescale mat and tmin
    mutate(fecEstSe=na_if(fecEstSe,0),
           fecEstMu=na_if(fecEstMu,0),
           across(c("mat","tmin"),
                  ~.x/10)
    ) |> 
    filter(!is.na(fecEstMu)) |> filter(!is.na(fecEstSe)) |> 
    # compute numbers of observations per plot
    group_by(plotID,species,mat,map,tmin) |> 
    summarise(n_plot=n(),
              fecEstMu_plot=mean(fecEstMu,na.rm=TRUE),
              se_plot=sqrt(sum(fecEstSe^2)/n_plot),
              cv_plot=se_plot/fecEstMu_plot) |> 
    # Compute mean of se per plot
    ungroup() |> 
    pivot_longer(cols=c("mat","tmin","map"),
                 names_to = "clim",
                 values_to = "clim_val")  |> 
    filter(!is.na(clim_val)) |> 
    group_by(species,clim) |>
    mutate(opt=weighted.quantile(clim_val,1/cv_plot,prob=0.5)[1],
           low=weighted.quantile(clim_val,1/cv_plot,prob=0.025)[1],#,probs=0.1)[1],
           high=weighted.quantile(clim_val,1/cv_plot,prob=0.975)[1],
           high.rank=weighted.quantile(clim_val,1/cv_plot, prob = 1- min(5, n())/n())[1],
           low.rank=weighted.quantile(clim_val,1/cv_plot, prob = min(5, n())/n())[1]) |> 
    ungroup()


# create distribution stat for mastif
mastif.range=df.tree |> 
  select(species,clim,low,low.rank,high,high.rank) |> unique() |> 
  pivot_longer(cols=c("low","high"),names_to = "quant",values_to = "quant_val") |> 
  pivot_longer(cols=c("low.rank","high.rank"),names_to = "rank",values_to = "rank_val") |> 
  filter((quant=="low"&rank=="low.rank")|
         (quant=="high"&rank=="high.rank")) |> 
  mutate(clim=paste0(clim,".",quant)) |> 
  select(-quant,-rank) |> 
  pivot_longer(cols = c("quant_val","rank_val"),
               names_to = "stat",
               values_to = "clim_obs" ) |> 
  separate(stat,into = c("stat","val")) |> select(-val) 

#,plot dif between quant and order
mastif.range |> 
  pivot_wider(names_from = stat,
              values_from = clim_obs) |>
  separate(clim,into=c("clim","edge")) |> 
  ggplot(aes(quant,rank,colour=species,shape=edge))+
  geom_point()+
  theme(legend.position = "none")+
  geom_abline(slope=1)+
  facet_wrap(~clim,scales="free")

# species selection
selection=mastif.range|> 
    left_join(species_selection$df.gbif,by=c("species","clim")) |> 
    relocate(species_l,.after=species)|> 
    separate(clim,into=c("var","quant"),remove=FALSE) |> 
    relocate(var,.after=species_l) |> 
  # merge climate range
    left_join(df.range,by=c("species","var")) |> 
    filter(!is.na(species_l)) |> 
  # filter(stat!="rank") |> 
    mutate(dif=case_when(grepl("high",clim)~100*(clim_obs-clim_niche)/range,
                         grepl("low",clim)~100*(clim_niche-clim_obs)/range)) |>
    mutate(dif.cat=cut(dif,breaks=c(0,-10,-20,-30,-40,-50,-60,-70,-80,-90,-100))) |> 
  group_by(species) |>
  mutate(quant_select=case_when(any(stat=="quant"&dif<(-50))~"quant_excl",
                             TRUE~"bon"),
         rank_select=case_when(any(stat=="rank"&dif<(-50))~"rank_excl",
                             TRUE~"bon")) |> ungroup()
selection |> 
  select(species, quant_select,rank_select) |> unique() |> 
  summarise(n_select=sum(quant_select=="bon"&rank_select=="bon"),
            n_rank_only=sum(rank_select=="rank_excl"&quant_select=="bon"),
            n_quant_only=sum(rank_select=="bon"&quant_select=="quant_excl"),
            n_excl=sum(rank_select=="rank_excl"&quant_select=="quant_excl"))

select.robustness=data.frame(species=unique(df.tree$species),
                             t_rank=NA,
                             t_quant=NA)
for (sp in unique(df.tree$species)){
  print(sp)
  tryCatch({
    selection.sp=mastif.range|> 
      filter(species==sp) |> 
      left_join(species_selection$df.gbif,by=c("species","clim")) |> 
      relocate(species_l,.after=species)|> 
      separate(clim,into=c("var","quant"),remove=FALSE) |> 
      relocate(var,.after=species_l) |> 
    # merge climate range
      left_join(df.range,by=c("species","var")) |> 
      filter(!is.na(species_l)) |> 
    # filter(stat!="rank") |> 
      mutate(dif=case_when(grepl("high",clim)~100*(clim_obs-clim_niche)/range,
                           grepl("low",clim)~100*(clim_niche-clim_obs)/range)) |> 
      filter(!is.na(dif))
  }, 
  error=function(e)print("sp not in mastifrange")
  )

  for (t in seq(0,-100,-5)){
    print(t)
    # save t_rank
    if(any(selection.sp$stat=="rank"&selection.sp$dif<t)){
      select.robustness[select.robustness$species==sp,
                        "t_rank"] <- t
    }
    if(any(selection.sp$stat=="quant"&selection.sp$dif<t)){
      select.robustness[select.robustness$species==sp,
                        "t_quant"] <- t
    }
  }
}
select.robustness |> 
  ggplot(aes(t_rank,t_quant,color=species))+geom_point()+
  geom_abline(slope=1)+
  theme(legend.position = "none")

# select.robustness |> 
#   filter(t_quant>(-50)&!is.na(t_quant)) |> pull(species)->select2

select.robustness |> 
  filter(!is.na(t_quant)) |> 
  arrange(t_quant,t_rank) |> 
  mutate(species=factor(species,species)) |> 
  # mutate(species=forcats::fct_reorder2(as.factor(species),t_rank,t_quant)) |>
  # mutate(species=forcats::fct_reorder(as.factor(species),t_quant)) |> 
  pivot_longer(cols=-species) |> 
  ggplot(aes(value,species,color=name))+
  geom_point()
```




# Preliminary analysis of diameter

We explored the link between diameter and fecundity. We assumed fecundity increased with higher diameter, and decided to standardize the fecundity estimates by the basal area of the producing tree.
```{r}

# plot of diameter/fecundity coloured by species
# library(ggpointdensity)
# df.tree |> 
#   filter(!species %in% sp.deleted) |> 
#   filter(fecEstMu<10000000&diam<200) |> 
#   ggplot(aes(diam,fecEstMu,color=species))+
#   geom_pointdensity()+
#   geom_hline(yintercept=10000000)+
#   scale_y_log10()+scale_x_log10()

# boxplot of fecundity by diameter categories, coloured by species


# df.tree |> 
#   filter(!species %in% sp.deleted) |> 
#   filter(fecEstMu<10000000&diam<200) |> 
#   mutate(fecCat=cut(fecEstMu,
#                     breaks=10),
#          diamCat=cut(diam,
#                      breaks=10)) |> 
#   ggplot(aes(diamCat,fecEstMu,color=species))+
#   geom_boxplot(outlier.color = NA)+
#   scale_y_log10()

for (sp in sample(unique(df.mastif.tree$species),10)){
  print(
    df.mastif.tree |> 
      # filter(!species %in% sp.deleted) |> 
      filter(species==sp) |> 
      filter(fecEstMu<10000000&diam<200) |> 
      mutate(fecCat=cut(fecEstMu,
                        breaks=10),
             diamCat=cut(diam,
                         breaks=10)) |> 
      ggplot(aes(fecCat,diam,color=species))+
      geom_boxplot(outlier.color = NA)
  )
}
```


<!-- # Random forest -->
```{r eval=FALSE, include=FALSE}
library(randomForest)
df.rf=df.mastif.tree |> 
  mutate(across(c("fecEstMu","diam","mat","tmin","map"),
                scale))
randomForest(fecEstMu~species+diam+map+mat+tmin,data=df.rf)->rf_model
plot(rf_model,type="simple")
```


<!-- # Analysis of fec var with distance from opt -->
```{r eval=FALSE, include=FALSE}
for (sp in unique(df.mastif.tree$species)){
  print(
    df.mastif.tree |> 
      filter(species==sp) |> 
      filter(fecEstMu<10000000&diam<200) |> 
      group_by(species,plotID,map,mat,tmin,treeID) |> 
      summarise(fecEstMu=mean(fecEstMu),
                diam=mean(diam)) |>
      mutate(fecEstMuSt=fecEstMu/(diam^2)) |> 
      # select(treeID,plotID,year,species,diam,fecEstMuSt,map,mat,tmin) |> 
      pivot_longer(cols=c("map","mat","tmin"),names_to = "clim") |> 
      left_join(df.niche.short) |> 
      mutate(dist=(value-opt)/range) |> 
      ggplot(aes(dist,fecEstMuSt))+
      geom_point()+
      facet_wrap(~clim)
  )
}

```


# Analysis of fecundity variation in species niche margins and optima, using European FNI

## Climate ACP and boxplot of fecundity for few species

```{r}
# Plot the variables in the first PCA pane for America
tar_load(c(nfi.eu_clim,nfi.am_clim),store="target_nfi")
fviz_pca_var(nfi.am_clim$clim_pca, col.var = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, ggtheme = theme_classic())

# Plot the variables in the first PCA pane for Europe
fviz_pca_var(nfi.eu_clim$clim_pca, col.var = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, ggtheme = theme_classic())
rm(nfi.eu_clim,nfi.am_clim)

# first plot with no weight
for (dataset in list(fecundity.am_clim,fecundity.eu_clim)){
  print(
  dataset |> 
    filter(!is.na(margin)) |> 
    filter(ISP!=0) |>
    # filter(species %in% sample(sp.select.am,10)) |> 
    ggplot(aes(margin,ISP))+
    geom_boxplot()+ #outlier.colour = NA
    facet_wrap(~species,scales="free")+
    scale_y_log10()
  )
}

```
## Margins plots

```{r}
#plot pc1
library(viridis)
worldmap <- sf::st_as_sf(getMap(resolution = "high"))

fecundity.eu_clim |> 
  filter(species=="fagusSylvatic") |> 
  ggplot() +
  geom_sf(data=worldmap,fill=NA) +
  geom_point(aes(x=lon,y=lat,color=PC1,alpha=0.4))+
  xlim(-10,33)+ylim(37,70)+
  theme_minimal()+
  theme(axis.text = element_blank(),
        axis.title=element_blank())+
  scale_color_gradientn(colours = viridis(15))

# plot margin obs
fecundity.eu_clim |> 
  filter(!is.na(margin)) |>
  filter(ISP!=0 | BA !=0) |>
  filter(species %in% c("abiesAlba","fagusSylvatic")) |> 
  ggplot() +
  geom_sf(data=worldmap,fill=NA) +
  geom_point(aes(x=lon,y=lat,color=margin,alpha=0.4))+
  xlim(-10,33)+ylim(37,70)+
  theme_minimal()+
  theme(axis.text = element_blank(),
        axis.title=element_blank())+
  facet_wrap(~species)

# plot all low margin
fecundity.eu_clim |> 
  filter(margin=="low") |> 
  filter(ISP!=0 | BA !=0) |>
  # filter(species %in% c("abiesAlba","fagusSylvatic")) |> 
  ggplot() +
  geom_sf(data=worldmap,fill=NA) +
  geom_point(aes(x=lon,y=lat,color=species,alpha=0.4))+
  xlim(-10,33)+ylim(37,70)+
  theme_minimal()+
  theme(axis.text = element_blank(),
        axis.title=element_blank())

```

## Climatic space of north america
```{r}
tar_load(df.nfi.am,store="target_nfi")
clim_list=list(mat="data/CHELSA/CHELSA_bio10_1.tif",
               tmin="data/CHELSA/CHELSA_bio10_6.tif",
               map="data/CHELSA/CHELSA_bio10_12.tif",
               sgdd="data/CHELSA/CHELSA_gdd5_1981-2010_V.2.1.tif",
               pet="data/CHELSA/CHELSA_pet_penman_mean_1981-2010_V.2.1.tif")
clim_list_sup=paste0("data/CHELSA/sup/",list.files("data/CHELSA/sup/"))
names(clim_list_sup)=substr(clim_list_sup,24,24+7)
clim_list=c(clim_list,clim_list_sup)
# clim=rast(lapply(names(clim_list),
#                  function(z){
#                    r=terra::rast(clim_list[[z]])
#                    names(r)=z
#                    return(r)
#                  }
#                  )
#           )
# 
for (z in names(clim_list_sup)){
   print(z)
   df.nfi.am <- cbind(df.nfi.am,
                      clim=extract(rast(clim_list[[z]]),
                              y=data.frame(x=df.nfi.am$lon,
                                           y=df.nfi.am$lat))[,-1]) |> 
     rename({{z}}:=clim)
  
}
df.acp=fecundity.am_clim |> filter(species=="fagusGrandifo") |> filter(BA!=0) |> select("sgdd","wai") |> drop_na()
clim_pca<-prcomp(df.acp,
                 scale. = TRUE)
clim_pca<-prcomp(df.nfi.am[,12:29] |> drop_na(),
                 scale. = TRUE) 
clim_pca<-prcomp(df.nfi.am[,c("vpd_max_","map","mat","sgdd","bio15_19","bio4_198","cmi_max_","bio14_19")] |> drop_na(),
                 scale. = TRUE)
clim_pca<-prcomp(df.nfi.am[species=="fagusGrandifo",c("sgdd","wai")] |> drop_na(),
                 scale. = TRUE)
fviz_pca_var(clim_pca, col.var = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, ggtheme = theme_classic())
fviz_pca_var(clim_pca, col.var = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), axes=c(2,3),
             repel = TRUE, ggtheme = theme_classic())
fviz_pca_ind(clim_pca, geom.ind = "point")
rm(df.nfi.am)


cbind(df.nfi.am,
      predict(clim_pca, newdata = df.nfi.am[,c("sgdd","wai")])) |>
  rownames_to_column() |>
  select(-rowname) |> 
  mutate(margin=case_when(PC1<quantile(PC1,probs=0.05,na.rm=TRUE)[[1]]~"coldhumid",
                          PC1>quantile(PC1,probs=0.95,na.rm=TRUE)[[1]]~"hotdry",
                          (PC1<quantile(PC1,probs=0.5,na.rm=TRUE)[[1]]&
                            PC1>quantile(PC1,probs=0.4,na.rm=TRUE)[[1]]&
                            PC2<quantile(PC1,probs=0.5,na.rm=TRUE)[[1]]&
                            PC2>quantile(PC1,probs=0.4,na.rm=TRUE)[[1]])~"core",
                          PC2>quantile(PC2,probs=0.95,na.rm=TRUE)[[1]]~"hothumid")) |> 
   ggplot(aes(PC1,PC2,color=margin))+geom_point()
  # group_by(margin) |> summarise(n=n())

fecundity.am_clim |> 
  filter(BA!=0) |> 
  group_by(species) |> 
  mutate(margin=case_when(PC1<quantile(PC1,probs=0.05,na.rm=TRUE)[[1]]~"coldhumid",
                          PC1>quantile(PC1,probs=0.95,na.rm=TRUE)[[1]]~"hotdry",
                          (PC1<quantile(PC1,probs=0.5,na.rm=TRUE)[[1]]&
                            PC1>quantile(PC1,probs=0.4,na.rm=TRUE)[[1]]&
                            PC2<quantile(PC1,probs=0.5,na.rm=TRUE)[[1]]&
                            PC2>quantile(PC1,probs=0.4,na.rm=TRUE)[[1]])~"core",
                          PC2>quantile(PC2,probs=0.95,na.rm=TRUE)[[1]]~"hothumid")) |> 
  ungroup() |> 
  filter(!is.na(margin)) |> 
  filter(ISP!=0) |>
  ggplot()+
  # geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
  geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_x_log10()+
  theme_minimal()
```


## Weighted boxplot

### Europe
Weighting obersvation do not drastically changes distribution.
```{r}
# graph densité fécondité corrigée a chaque marge 
fecundity.eu_clim |> 
  filter(!is.na(margin)) |> 
  filter(ISP!=0) |>
  ggplot()+
  # geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
  geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_x_log10()+
  theme_minimal()

# graph densité fécondité non corrigée a chaque marge 
fecundity.eu_clim |> 
  filter(!is.na(margin)) |> 
  filter(ISP!=0) |>
  ggplot()+
  geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
  # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_y_log10()+
  theme_minimal()

fecundity.eu_clim |> 
  filter(!is.na(margin)) |> 
  filter(ISP!=0) |>
  ggplot()+
  geom_boxplot(aes(margin,cv_plot,color=margin),outlier.colour = NA)+
  # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_y_log10()+
  theme_minimal()



```
#### t-test

```{r compmed}
sp.dataset=as.data.table(fecundity.eu_clim |> filter(BA!=0))
for (sp in unique(fecundity.eu_clim$species)){
  print(sp)
  print(t.test(sp.dataset[species==sp&margin=="up",ISP],sp.dataset[species==sp&margin=="opt",ISP])
  )
  print(t.test(sp.dataset[species==sp&margin=="low",ISP],sp.dataset[species==sp&margin=="opt",ISP])
  )
  print(
    fecundity.eu_clim |>
      filter(species==sp) |> 
      filter(!is.na(margin)) |> 
      filter(ISP!=0) |>
      ggplot()+
      # geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
      geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
      geom_vline(xintercept = mean(sp.dataset[species==sp&margin=="low",ISP]),color="red")+
      geom_vline(xintercept = mean(sp.dataset[species==sp&margin=="up",ISP]),color="blue")+
      geom_vline(xintercept = mean(sp.dataset[species==sp&margin=="opt",ISP]),color="green")+
      scale_x_log10()+
      theme_minimal()+
      ggtitle(sp)
)
}

```

#### KS test :

```{r}
for (sp in unique(fecundity.eu_clim$species)){
  print(sp)
  sp.density=fecundity.eu_clim |> 
      filter(species==sp) |> 
      filter(!is.na(margin)) |> 
      filter(ISP!=0) |> 
    as.data.table()
  print(
     sp.density|>
      ggplot()+
      # geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
      geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
      facet_wrap(~species,scales="free")+
      scale_x_log10()+
      theme_minimal())
  optlow=ks.test(sp.density[margin=="low",ISP],sp.density[margin=="opt",ISP])
  lowup=ks.test(sp.density[margin=="low",ISP],sp.density[margin=="up",ISP])
  optup=ks.test(sp.density[margin=="up",ISP],sp.density[margin=="opt",ISP])
  print(
    paste0(
      c("optlow D : ","optlow pval : "),
      c(D=optlow$statistic,pval=optlow$p.value)
    )
    
  )
  print(
    paste0(
      c("lowup D : ","lowup pval : "),
      c(D=lowup$statistic,pval=lowup$p.value)
    )
    
  )
    print(
    paste0(
      c("optup D : ","optup pval : "),
      c(D=optup$statistic,pval=optup$p.value)
    )
    
  )
}
```



### Northern America 
```{r}
# graph densité fécondité corrigée a chaque marge 
fecundity.am_clim |> 
  filter(!is.na(margin)) |> 
  filter(ISP!=0) |>
  ggplot()+
  # geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
  geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_x_log10()+
  theme_minimal()

# graph densité fécondité non corrigée a chaque marge 
fecundity.am_clim |> 
  filter(!is.na(margin)) |> 
  filter(ISP!=0) |>
  ggplot()+
  geom_boxplot(aes(margin,ISP,color=margin),outlier.colour = NA)+
  # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_y_log10()+
  theme_minimal()

```


## ISP/margins interspecific

```{r eval=FALSE, include=FALSE}
min((fec_trans |> 
  group_by(species) |> 
  summarise(n=n()) |> 
  arrange(n))$n)->min.n

fec_trans |> 
  group_by(species) |> 
  sample_n(min.n) |> 
  ggplot()+
  geom_boxplot(aes(margin,ISP,color=margin),outlier.colour = NA)+
  scale_y_log10()+
  theme_minimal()
```


## Test using a continous distance - Mahanolinis distance

```{r}
# sp="abiesAlba"
library(robustbase)
for(sp in unique(fecundity.eu_clim$species)){
  fec.sp=fecundity.eu_clim |> 
    filter(species==sp) |> 
    filter(!is.na(BA)) |> 
    mutate(across(c("mat","tmin","map","sgdd","pet","wai"),
                  scale))

  # geographic centroid and distance
  points_sp<-st_union(st_as_sf(fec.sp[,c("lon","lat")],coords=c("lon","lat")))
  centroid_sp<-st_centroid(st_convex_hull(points_sp))
  # centroid_sp2<-st_centroid(points_sp)
  fec.sp=cbind(fec.sp,
               dist_geo=st_distance(st_as_sf(fec.sp[,c("lon","lat")],
                                             coords=c("lon","lat")),
                                    centroid_sp))
  
  print(
    fec.sp |> 
      ggplot(aes(log(ISP),dist_geo))+
      geom_point(alpha=0.4,stroke=NA)+
      geom_smooth(method="lm")+
      ggtitle(label = paste0("geo_",sp))
  )
  
  
  # estimate climate centroid and distance
  fec.sp<-fec.sp[,c("lon","lat","margin","dist_geo","BA","ISP","mat","wai","tmin","sgdd")] |> 
    filter(!is.na(mat)&!is.na(wai)&!is.na(tmin)&!is.na(sgdd))
  sp.elp=covMcd(fec.sp[,c("mat","wai","tmin","sgdd")],alpha=0.7)
  sp.center=c(as.matrix(sp.elp$center))
  
  fec.sp=cbind(fec.sp,
               dist_maha=mahalanobis(fec.sp[,c("mat","wai","tmin","sgdd")],
                                     sp.center,
                                     cov(fec.sp[,c("mat","wai","tmin","sgdd")] |> drop_na())))
  
  
  
  print(
    fec.sp |> 
      ggplot(aes(log(ISP),dist_maha))+
      geom_point(alpha=0.4,stroke=NA)+
      geom_smooth(method="lm")+
      ggtitle(label = paste0("clim_",sp))
  )
    
  print(
    fec.sp |>
      ggplot(aes(margin,dist_maha))+
      geom_boxplot()
  )

}
# fec.sp |> 
#   ggplot(aes(dist_geo,dist_maha))+geom_point()+geom_smooth()
# fec.sp |> 
#   ggplot(aes(margin,dist_maha))+geom_boxplot()
# fec.sp |> 
#   ggplot(aes(lat,log(BA)))+geom_point()+geom_smooth(method="lm")

```


# Fecundity variation in geographical space

First delineate geographical margins :

##  delineate on latitude criteria
```{r geomargin}
fecundity.eu_clim |> 
  filter(BA!=0) |> 
  group_by(species) |> 
  mutate(lat95=quantile(lat,probs=0.95,na.rm=TRUE)[[1]],
            lat525=quantile(lat,probs=0.525,na.rm=TRUE)[[1]],
            lat475=quantile(lat,probs=0.475,na.rm=TRUE)[[1]],
            lat05=quantile(lat,probs=0.05,na.rm=TRUE)[[1]],
         margin=case_when(lat<lat05~"low",
                          lat>lat475&lat<lat525~"opt",
                          lat>lat95~"up",
                          TRUE~NA)) |> 
  filter(!is.na(margin)) |> 
  ggplot() +
  geom_sf(data=worldmap,fill=NA) +
  geom_point(aes(x=lon,y=lat,color=species,alpha=0.4))+
  xlim(-10,33)+ylim(37,70)+
  theme_minimal()+
  theme(axis.text = element_blank(),
        axis.title=element_blank())+
  facet_wrap(~margin)


```
## delineate using distance to core population


```{r geomargin}
sp.dataset=as.data.table(fecundity.eu_clim |> filter(BA!=0))
sp.dataset<-sp.dataset[species==sp,]
sp.dataset |> 
  ggplot() +
  geom_point(aes(x=lon,y=lat,color=margin)) +
geom_sf(data=worldmap,fill=NA)+
  xlim(-10,33)+ylim(37,70)+
  theme_minimal()+
  theme(axis.text = element_blank(),
        axis.title=element_blank())  

# determine centroid
nmin=sp.dataset[BA != 0,.(n = .N),by = species][n == sort(n)[2],n]
for (sp in unique(sp.dataset$species)){  #c("sorbusAucupari","fagusSylvatic","abiesAlba","piceaAbies")
  print(sp)
  
  # compute centroid of distribution
  sp.geodataset <- st_as_sf(sp.dataset[species==sp,], coords = c("lon", "lat"), crs = 4326)
  sp.centroid <- st_centroid(st_union(sp.geodataset$geometry),ratio=1)
  # plot(sp.geodataset$geometry)
  # plot(sp.centroid,add=TRUE,col="red")
  # n=max(round(dim(sp.dataset[species==sp,])[1]/1000),9)
 
  # first select points far from centroid -> i.e 15% the furthest 
  df.kmeans=cbind(sp.dataset[species==sp,],
      dist=as.numeric(st_distance(sp.geodataset,sp.centroid))) |>
    sample_n(nmin,replace=TRUE)
    # filter(dist>quantile(dist,probs=0.85)[[1]])
    # arrange(desc(dist)) |>
    # slice(1:(max(500,n()/10)))
  
  # print distribution and overlay points selected for margin
  print(
    ggplot()+
      geom_point(data=sp.dataset[species==sp,],aes(x=lon,y=lat))+
      geom_point(data=df.kmeans,aes(x=lon,y=lat),color="red")+
      geom_sf(data=worldmap,fill=NA)+
      xlim(-10,33)+ylim(37,70) # europe
      # xlim(-125,-75)+ylim(24,70) # northamerica
    )
  
  # dbscan
  dbscan::kNNdistplot(df.kmeans[,c("lon","lat")], k =  7)
  eps=quantile(dbscan::kNNdist(df.kmeans[,c("lon","lat")], k =  7),probs=0.85)[[1]]
  print(eps)
  fpc::dbscan(df.kmeans[,c("lon","lat")],eps=eps,MinPts =7)->df.dbscan

  # print dbscan clusters
  print(
    cbind(df.kmeans,
          cluster=df.dbscan$cluster) |>
      filter(cluster!=0) |> 
      ggplot()+
      geom_sf(data=worldmap,fill=NA,alpha=0.4)+
      geom_point(aes(x=lon,y=lat,colour=as.factor(cluster)))+
      xlim(-10,33)+ylim(37,70) # europe
      # xlim(-125,-75)+ylim(24,70) # northamerica
  )
  
  
  # boxplots of fecundity in clusters with enough individuals
  print(
    cbind(df.kmeans,
          cluster=as.character(df.dbscan$cluster))|> 
      filter(cluster !=0) |> 
      group_by(cluster) |> 
      mutate(n.cluster=n(),
             mean.lat=mean(lat),
             mean.dist=mean(dist)) |> 
      ungroup() |>
      filter(n.cluster>40) |> 
      mutate(order.min=dense_rank(mean.dist)) |> 
      filter(order.min==1 | order.min > max(order.min)-3) |> 
      # filter(cluster=="core"|
      #          mean.lat==max(mean.lat)|
      #          mean.lat==min(mean.lat)) |> 
      mutate(cluster=forcats::fct_reorder(as.factor(cluster),mean.dist)) |> 
      ggplot(aes(cluster,ISP,fill=mean.lat))+
      geom_boxplot()+
      scale_y_log10()+
      ggtitle(label=sp)

  )
  }
  # dbscan::kNNdistplot(df.kmeans[,c("lon","lat")], k =  7)
  # 
  # # boxplots of fecundity in clusters with enough individuals
  # print(
  #   bind_rows(
  #     # core population
  #     cbind(sp.dataset[species==sp,],
  #           dist=as.numeric(st_distance(sp.geodataset,sp.centroid))) |> 
  #       arrange(dist) |>
  #       slice(1:(max(300,n()/15))) |> 
  #       mutate(cluster="core"),
  #     # clusters
  #     cbind(df.kmeans,
  #       cluster=as.character(df.dbscan$cluster))
  #   ) |> 
  #     filter(cluster !=0) |> 
  #     group_by(cluster) |> 
  #     mutate(n.cluster=n(),
  #            mean.lat=mean(lat),
  #            mean.dist=mean(dist)) |> 
  #     ungroup() |>
  #     filter(n.cluster>40) |> 
  #     mutate(order.min=dense_rank(mean.dist)) |> 
  #     filter(order.min==1 | order.min > max(order.min)-3) |> 
  #     # filter(cluster=="core"|
  #     #          mean.lat==max(mean.lat)|
  #     #          mean.lat==min(mean.lat)) |> 
  #     mutate(cluster=forcats::fct_reorder(as.factor(cluster),mean.dist)) |> 
  #     ggplot(aes(cluster,ISP,fill=mean.lat))+
  #     geom_boxplot()+
  #     scale_y_log10()
  # 
  # )

#   # code with k-means algo
#   # kmeans
#   kmeans(df.kmeans[,c("lon","lat")],4)->sum.kmeans
#   ## map clusters
#   print(cbind(df.kmeans,
#         cluster=sum.kmeans$cluster) |> 
#     ggplot(aes(x=lon,y=lat,colour=as.factor(cluster)))+
#     geom_point())
#   ## draw boxplots
#   print(cbind(df.kmeans,
#         cluster=sum.kmeans$cluster) |> 
#     group_by(cluster) |> 
#     mutate(m.dist=mean(dist)) |> 
#     ungroup() |> 
#     mutate(order.min=dense_rank(m.dist)) |> 
#     filter(order.min==1 | order.min > max(order.min)-3) |> 
#     mutate(cluster=forcats::fct_reorder(as.factor(cluster),m.dist)) |> 
#     ggplot(aes(as.factor(cluster),ISP,fill=m.dist))+
#     geom_boxplot()+
#     scale_y_log10())




```

## regression ISP/distance
```{r}
sp.dataset=as.data.table(fecundity.eu_clim |> filter(BA!=0))


# determine centroid
sp.dist=sp.dataset |> 
  st_as_sf(coords = c("lon", "lat"), crs = 4326) |> 
  group_by(species) |> 
  mutate(centroid=st_centroid(st_union(geometry))) |> 
  mutate(lat=st_coordinates(geometry)[,2],
         x_centroid=st_coordinates(centroid)[,1],
         y_centroid=st_coordinates(centroid)[,2]) |> 
  ungroup() |> 
  mutate(dist=as.numeric(st_distance(geometry,centroid,by_element = TRUE)))

sp.dist |> 
  group_by(species) |> 
  mutate(ISP=scale(ISP),
         dist=scale(dist)) |> 
  mutate(dist=cut(dist,
                  breaks = 10)) |> 
  ggplot(aes(dist,ISP))+
  geom_boxplot()+
  scale_y_log10()+
  facet_wrap(~species,scales="free")


# lat/dist plots
sp.dist |> 
  group_by(species) |> 
  mutate(scale=ISP) |>  
  mutate(dist=cut(dist,breaks=10),
         lat=cut(lat,breaks=10)) |> ungroup() |>
  group_by(species,dist,lat) |> 
  summarise(mean.fec=mean(ISP)) |> 
  ggplot(aes(x=dist,y=lat))+
  geom_tile(aes(fill=log(mean.fec)))+
  scale_fill_distiller(palette="YlGnBu",direction=1)+
  facet_wrap(~species,scales="free")



# regression 
fecdist.lm=lm(ISP~species+dist+lat+dist:species,data=sp.dist)
summary(fecdist.lm)
anova(fecdist.lm)


fecdist.rq <- rq(ISP~species+dist+lat+dist:species,data=sp.dist, tau = 0.95)
summary(fecdist.rq)
```

# Fecundity variability in negative safety margins

```{r sfm}
psi_min=rast(fread("../../Era5-land/output/psihorday_real.csv")[,c("x","y","psi")],crs="epsg:4326")
frost.index.winter=min(rast("../../Era5-land/data/CHELSA/CHELSA_EUR11_tasmin_month_min_19802005.nc"),na.rm=FALSE)
species.traits=readRDS("../../Era5-land/target_safetymargin/objects//df.traits") |> 
  mutate(sp8=paste0(substr(tolower(genus),1,8),substr(str_to_title(species),1,8))) 
mod.output=readRDS("../../Era5-land/target_analysis/objects/df.mod.select") |> 
  separate(species.binomial, into=c("genus","sp")) |> 
  mutate(species=paste0(substr(tolower(genus),1,8),substr(str_to_title(sp),1,8)),
         t_hsm=na_if(t_hsm,0),
         t_fsm=na_if(t_fsm,0)) 
  
fec.eu_sfm=cbind(fecundity.eu_clim,
                 psi=extract(psi_min,data.frame(x=fecundity.eu_clim$lon,
                                      y=fecundity.eu_clim$lat))[[2]],
                 frost=extract(frost.index.winter,data.frame(x=fecundity.eu_clim$lon,
                                      y=fecundity.eu_clim$lat))[[2]]) |> 
  left_join(species.traits[,c("sp8","px.mu","lt50.mean")],by=c("species"="sp8")) |> 
  left_join(mod.output[,c("t_fsm","t_hsm","species","mod")],by="species") |> 
  mutate(hsm=psi-t_hsm*1000-px.mu*1000,
         fsm=frost-t_fsm-lt50.mean,
         margin.sm=case_when(mod%in%c("2sm","hsm")&hsm<0~"drought",
                             mod%in%c("2sm","fsm")&fsm<0~"frost",
                             mod%in%c("2sm")&hsm<0&fsm<0~"both",
                             mod%in%c("2sm")&hsm>0&fsm>0~"core",
                             mod%in%c("hsm")&hsm>0~"core",
                             mod%in%c("fsm")&fsm>0~"core"))

# graph densité fécondité corrigée a chaque marge 
fec.eu_sfm |> 
  filter(!is.na(margin.sm)) |> 
  filter(ISP!=0) |>
  ggplot()+
  # geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
  geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin.sm))+
  facet_wrap(~species,scales="free")+
  scale_x_log10()+
  theme_minimal()

 fec.eu_sfm |> 
  filter(!is.na(margin.sm)) |> 
  filter(ISP!=0) |>
  group_by(species) |> 
  mutate(hsm.core=hsm>quantile(hsm,probs=0.8,na.rm=TRUE),
         fsm.core=fsm>quantile(fsm,probs=0.8,na.rm=TRUE)) |> 
  filter(!(margin.sm=="core"&hsm.core==FALSE&fsm.core==FALSE)) |> 
  ggplot()+
  # geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
  geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin.sm))+
  facet_wrap(~species,scales="free")+
  scale_x_log10()+
  theme_minimal()

# graph densité fécondité non corrigée a chaque marge 
fec.eu_sfm |> 
  filter(!is.na(margin.sm)) |> 
  filter(ISP!=0) |>
  ggplot()+
  geom_boxplot(aes(margin.sm,ISP,color=margin.sm),outlier.colour = NA)+
  # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_y_log10()+
  theme_minimal()


fec.eu_sfm |> 
  filter(!is.na(margin.sm)) |> 
  filter(ISP!=0) |> 
  group_by(species,margin.sm) |> summarise(n=n())
```

# Temporal variability of fecundity

```{r}
files=list.files("data/europe/")[grepl("fecGmMu-",list.files("data/europe/"))]

df.temporal= fecundity.eu_clim |> 
  select(plot,species,BA,fecGmMu,fecGmSd,lon,lat,CV,mat,tmin,map,sgdd,margin)
for (f in files){
  load(paste0("data/europe/",f))
  year=substr(f,9,12)
  mu=summary |> 
    as.data.frame() |> 
    rownames_to_column(var="plot") |> 
    select(plot,matches(unique(fecundity.eu_clim$species))) |> 
    pivot_longer(cols=-plot,
                 names_to = "species",
                 values_to = paste0("fecGmMu_",year))
  rm(summary)
  load(paste0("data/europe/fecGmSd-",year,".rdata"))
  sd=summary |> 
    as.data.frame() |> 
    rownames_to_column(var="plot") |> 
    select(plot,matches(unique(fecundity.eu_clim$species))) |> 
    pivot_longer(cols=-plot,
                 names_to = "species",
                 values_to = paste0("fecGmSd_",year))
  df.temporal <- df.temporal |> 
    left_join(cbind(mu,sd[3]),by=c("plot","species"))
  rm(summary,mu,sd,year)
}

df.temporal2 <- df.temporal|> 
  filter(!is.na(margin)) |> 
  pivot_longer(cols=matches("fecGmMu_"),
               names_to=c("var","year"),
               names_sep = "_",
               values_to="fecYear") |> 
  pivot_longer(cols=matches("fecGmSd_"),
               names_to=c("var2","year2"),
               names_sep = "_",
               values_to="fecSdYear") |> 
  filter(year==year2) |> select(-year2)

df.temporal2 |> 
  mutate(fecYear=na_if(fecYear,0),
         fecSdYear=na_if(fecSdYear,0),
         feccvyear=fecYear/fecSdYear) |> 
  filter(!is.na(fecYear)) |> filter(!is.na(fecSdYear)) |> 
  group_by(margin,plot,species) |> 
  summarise(n_plot=n(),
         fecGmMu_plot=weighted.mean(fecYear,w=1/feccvyear,na.rm=TRUE), # perform weighted mean of the tree on the plot
         se_plot=sqrt(sum(fecSdYear^2)/n_plot),
         cv_plot=se_plot/fecGmMu_plot) |> 
  ungroup() |> 
  ggplot()+
  geom_boxplot(aes(margin,cv_plot,color=margin),outlier.colour = NA)+
  # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_y_log10()+
  theme_minimal()

df.temporal2 |> 
  mutate(fecYear=na_if(fecYear,0),
         fecSdYear=na_if(fecSdYear,0),
         feccvyear=fecYear/fecSdYear) |> 
  filter(!is.na(fecYear)) |> filter(!is.na(fecSdYear)) |> 
  group_by(margin,plot,species) |> 
  summarise(n_plot=n(),
         fecGmMu_plot=weighted.mean(fecYear,w=1/feccvyear,na.rm=TRUE), # perform weighted mean of the tree on the plot
         se_plot=sqrt(sum(fecSdYear^2)/n_plot),
         cv_plot=se_plot/fecGmMu_plot) |> 
  ungroup() |> 
  ggplot()+
  geom_boxplot(aes(margin,fecGmMu_plot,weight=cv_plot,color=margin),outlier.colour = NA)+
  # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_y_log10()+
  theme_minimal()

# both

# df.temporal2 |> 
#   mutate(fecYear=na_if(fecYear,0),
#          fecSdYear=na_if(fecSdYear,0),
#          feccvyear=fecYear/fecSdYear) |> 
#   filter(!is.na(fecYear)) |> filter(!is.na(fecSdYear)) |> 
#   group_by(margin,plot,species) |> 
#   summarise(n_plot=n(),
#          fecGmMu_plot=weighted.mean(fecYear,w=1/feccvyear,na.rm=TRUE), # perform weighted mean of the tree on the plot
#          se_plot=sqrt(sum(fecSdYear^2)/n_plot),
#          cv_plot=se_plot/fecGmMu_plot) |> 
#   ungroup() |> 
#   pivot_longer(cols=c("fecGmMu_plot","cv_plot"),
#              names_to="var",
#              values_to = "val") |> 
#   group_by(species,var) |> mutate(val=scale(val)) |> 
#   ggplot()+
#   geom_boxplot(aes(margin,val,color=var),outlier.colour = NA)+
#   # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
#   facet_wrap(~species,scales="free")+
#   scale_y_log10()+
#   theme_minimal()
 
```

# Difference using ks.test

```{r spcomp}
sp="abiesAlba"

fecundity.eu_clim |> 
  filter(!is.na(margin)) |> 
  filter(ISP!=0) |>
  ggplot()+
  geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
  # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_y_log10()+
  theme_minimal()

sp.margin.dist<- data.frame(
  species=unique(fecundity.eu_clim$species),
  low.dist=NA,
  low.dir=NA,
  up.dist=NA,
  up.dir=NA
)
for (sp in unique(fecundity.eu_clim$species)){
  print(sp)
  sp.density=fecundity.eu_clim |> 
      filter(species==sp) |> 
      filter(!is.na(margin)) |> 
      filter(ISP!=0) |> 
    as.data.table()
  print(
     sp.density|>
      ggplot()+
      # geom_boxplot(aes(margin,ISP,weight=cv_plot,color=margin),outlier.colour = NA)+
      geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
      facet_wrap(~species,scales="free")+
      scale_x_log10()+
      theme_minimal())
  optlow=ks.test(sp.density[margin=="low",ISP],sp.density[margin=="opt",ISP])
  lowup=ks.test(sp.density[margin=="low",ISP],sp.density[margin=="up",ISP])
  optup=ks.test(sp.density[margin=="up",ISP],sp.density[margin=="opt",ISP])
  print(
    paste0(
      c("optlow D : ","optlow pval : "),
      c(D=optlow$statistic,pval=optlow$p.value)
    )
    
  )
  print(
    paste0(
      c("lowup D : ","lowup pval : "),
      c(D=lowup$statistic,pval=lowup$p.value)
    )
    
  )
    print(
    paste0(
      c("optup D : ","optup pval : "),
      c(D=optup$statistic,pval=optup$p.value)
    )
    
  )
  sp.margin.dist[sp.margin.dist$species==sp,c("low.dist","low.dir","up.dist","up.dir")]=
    c(
      optlow$statistic[[1]],
      ifelse(mean(sp.density[margin=="low",ISP])-mean(sp.density[margin=="opt",ISP])>0,1,-1),
      optup$statistic[[1]],
      ifelse(mean(sp.density[margin=="up",ISP])-mean(sp.density[margin=="opt",ISP])>0,1,-1)
    )
}
sp.margin.dist |>
  left_join(species_selection$df.gbif)  |> 
  separate(clim,into=c("clim","quant")) |> 
  # left_join(df.range) |> 
  filter(quant=="opt") |> select(-quant) |>
  # mutate(range=range/clim_niche) |> 
  # pivot_wider(names_from = "var",
  #             values_from = "range",
  #             name
  #             ) |> 
  # pivot_longer(cols=c("mat","map","tmin","range"),
  #              names_to="clim",
  #              values_to = "clim_niche")
  group_by(clim) |> mutate(clim_niche=scale(clim_niche)) |> 
  ggplot(aes(color=clim_niche))+
  geom_segment(aes(x=0,y=0,xend=low.dist*low.dir,yend=up.dist*up.dir),arrow = arrow(length = unit(0.3,"cm")))+
  geom_text(aes(label=species, x=low.dist*low.dir,y=up.dist*up.dir))+
  coord_equal()+
    scale_color_gradientn(colours = viridis(15))+
  facet_wrap(~clim)
  
sp.margin.dist |>
  left_join(species_selection$df.gbif)  |> 
  separate(clim,into=c("var","quant")) |> 
  left_join(df.range) |> 
  filter(quant=="opt") |> select(-quant) |>
  mutate(range=range/clim_niche) |> select(-clim_niche) |> 
  group_by(var) |> mutate(range=scale(range)) |> 
  ggplot(aes(color=range))+
  geom_segment(aes(x=0,y=0,xend=low.dist*low.dir,yend=up.dist*up.dir),arrow = arrow(length = unit(0.3,"cm")))+
  geom_text(aes(label=species, x=low.dist*low.dir,y=up.dist*up.dir))+
  coord_equal()+
    scale_color_gradientn(colours = viridis(15))+
  facet_wrap(~var)
```
# Difference using tshd - post-hoc

## Mahanobilis-dist

First we use a continuous climatic distance to determine for which species a trend is identifiable. The species for which the linear model with climatic distance is significant are then investigated by margins, to disentangle specific climatic drivers.

```{r}
sp="abiesAlba"
dist.test=data.frame(species=c(unique(fecundity.eu_clim$species),
                               unique(fecundity.am_clim$species)),
                       geo.pval=NA,
                       clim.pval=NA,
                       zone=c(rep("europe",length(unique(fecundity.eu_clim$species))),
                              rep("america",length(unique(fecundity.am_clim$species))))
                     )
for(sp in dist.test$species){
  print(sp)
  # select the accurate occurence data
  if(dist.test[dist.test$species==sp,"zone"]=="america"){
    fec.sp=fecundity.am_clim|>
      filter(species==sp) |>
      filter(!is.na(BA)) |>
      mutate(across(c("mat","tmin","map","sgdd","pet","wai"),
                    scale))
  } else {
    fec.sp=fecundity.eu_clim|>
      filter(species==sp) |>
      filter(!is.na(BA)) |>
      mutate(across(c("mat","tmin","map","sgdd","pet","wai"),
                    scale))
  }

  # geographic centroid and distance
  points_sp<-st_union(st_as_sf(fec.sp[,c("lon","lat")],coords=c("lon","lat")))
  centroid_sp<-st_centroid(st_convex_hull(points_sp))
  # centroid_sp2<-st_centroid(points_sp)
  fec.sp=cbind(fec.sp,
               dist_geo=st_distance(st_as_sf(fec.sp[,c("lon","lat")],
                                             coords=c("lon","lat")),
                                    centroid_sp))
  
  print(
    fec.sp |> 
      ggplot(aes(log(ISP),dist_geo))+
      geom_point(alpha=0.4,stroke=NA)+
      geom_smooth(method="lm")+
      ggtitle(label = paste0("geo_",sp))
  )
  
  dist.test[dist.test$species==sp,"geo.pval"]=
    as.data.table(summary(lm(log(ISP)~dist_geo,data=fec.sp ))$coefficients)[2,"Pr(>|t|)"][[1]]
  
  # estimate climate centroid and distance
  fec.sp<-fec.sp[,c("lon","lat","margin","dist_geo","BA","ISP","mat","tmin","map","sgdd","pet","wai")] |> 
    filter(!is.na(mat)&!is.na(wai)&!is.na(tmin)&!is.na(sgdd))
  sp.elp=covMcd(fec.sp[,c("mat","tmin","map","sgdd","pet","wai")],alpha=0.7)
  sp.center=c(as.matrix(sp.elp$center))
  
  fec.sp=cbind(fec.sp,
               dist_maha=mahalanobis(fec.sp[,c("mat","tmin","map","sgdd","pet","wai")],
                                     sp.center,
                                     cov(fec.sp[,c("mat","tmin","map","sgdd","pet","wai")] |>
                                           drop_na())
                                     )
               )
  
  print(
    fec.sp |> 
      ggplot(aes(log(ISP),dist_maha))+
      geom_point(alpha=0.4,stroke=NA)+
      geom_smooth(method="lm")+
      ggtitle(label = paste0("clim_",sp))
  )
    
  # print(
  #   fec.sp |>
  #     ggplot(aes(margin,dist_maha))+
  #     geom_boxplot()
  # )
  
  print(summary(lm(log(ISP)~dist_maha,data=fec.sp )))
  dist.test[dist.test$species==sp,"clim.pval"]=
    as.data.table(summary(lm(log(ISP)~dist_maha,data=fec.sp ))$coefficients)[2,"Pr(>|t|)"][[1]]
}

# fec.sp |> 
#   ggplot(aes(dist_geo,dist_maha))+geom_point()+geom_smooth()
# fec.sp |> 
#   ggplot(aes(margin,dist_maha))+geom_boxplot()
# fec.sp |> 
#   ggplot(aes(lat,log(BA)))+geom_point()+geom_smooth(method="lm")

```



## Compute margins diff
The idea is the for n zone delimitated in the distribution of each species , there are (n-1)^3 possible variations of the fecundity in its niche (higher, lower or equal than the core distribution).
We can make different types of zone in the distribution of the species :

* two extremes of the PCA axis
* extremes of two major acp
* defined number of classes on a climatic distance gradient

We propose to test margins for species for which continuous climatic distance was significant.

### Europe

```{r}
sp.dataset=fecundity.eu_clim |>
  filter(BA!=0) |> 
  group_by(species) |> 
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=1/cv_plot, prob=0.05)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=1/cv_plot, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=1/cv_plot, prob=0.475)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=1/cv_plot, prob=0.95)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=1/cv_plot, prob=0.05)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=1/cv_plot, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=1/cv_plot, prob=0.475)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=1/cv_plot, prob=0.95)[[1]]~"humid")) |> 
  pivot_longer(cols=c("margin.sgdd","margin.wai"),
               names_to="margin.type",
               values_to="margin.val") |> 
  filter(!is.na(margin.val)) |> 
  ungroup() |> 
  mutate(margin.val=factor(margin.val,levels=c("midtemp","cold","hot","midhum","arid","humid"))) |> 
  as.data.table()

# boxplot for each margin types
sp.dataset |> 
  left_join(dist.test) |> 
  mutate(signif.clim=clim.pval<0.05) |> 
  ggplot()+
  geom_boxplot(aes(margin.val,ISP,weight=cv_plot,color=signif.clim,fill=margin.type),outlier.colour = NA)+
  # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_y_log10()+
  scale_colour_manual(values=c("grey","black"))

# density for margin.sgdd
sp.dataset |>
  group_by(species) |>
  mutate(ISP=scale(log(ISP))) |>
  ungroup() |>
  filter(margin.type=="margin.sgdd") |>
  ggplot(aes(ISP,color=margin.val))+
  geom_density()+
  facet_wrap(~species,scales="free_x")

# check for common points in margin delineation
sp.dataset |> 
  pivot_wider(names_from = margin.type,
              values_from = margin.val) |> 
  count(margin.sgdd,margin.wai) |> 
  ggplot(aes(margin.sgdd,margin.wai,fill=log(n)))+
  geom_tile()

# sp.dataset |> 
#   pivot_wider(names_from = margin.type,
#               values_from = margin.val) |> 
#   filter(!is.na(margin.sgdd)) |>
#   group_by(species,margin.sgdd) |> 
#   summarise(mean.sgdd=mean(sgdd)) -> sgdd.zone.eu
```


```{r}
# sp="abiesAlba"       
margin.test=data.frame(species=unique(fecundity.eu_clim$species),
                       sgdd.dif=FALSE,
                       sgdd.up=NA,
                       sgdd.low=NA,
                       wai.dif=FALSE,
                       wai.up=NA,
                       wai.low=NA,
                       zone="europe")
for (sp in unique(fecundity.eu_clim$species)){
  print(sp)
  df.sp=sp.dataset|> 
    filter(species==sp) |> 
    mutate(ISP=scale(log(ISP))) |>
    as.data.table()
  mod=aov(lm(ISP~margin.val,data=df.sp[margin.type=="margin.sgdd"],weights=1/cv_plot))
  if(summary(mod)[[1]]$`Pr(>F)`[1]<0.001){
    margin.test[margin.test$species==sp,"sgdd.dif"]=TRUE
    thsd=TukeyHSD(mod,"margin.val")
    if(thsd$margin.val["hot-midtemp","p adj"]<0.05){
      margin.test[margin.test$species==sp,"sgdd.up"]=thsd$margin.val["hot-midtemp","diff"]
    }
    if(thsd$margin.val["cold-midtemp","p adj"]<0.05){
      margin.test[margin.test$species==sp,"sgdd.low"]=thsd$margin.val["cold-midtemp","diff"]
    }
  }
  mod=aov(lm(ISP~margin.val,data=df.sp[margin.type=="margin.wai"],weights=1/cv_plot))
  if(summary(mod)[[1]]$`Pr(>F)`[1]<0.001){
    margin.test[margin.test$species==sp,"wai.dif"]=TRUE
    thsd=TukeyHSD(mod,"margin.val")
    if(thsd$margin.val["arid-midhum","p adj"]<0.05){
      margin.test[margin.test$species==sp,"wai.low"]=thsd$margin.val["arid-midhum","diff"]
    }
    if(thsd$margin.val["humid-midhum","p adj"]<0.05){
      margin.test[margin.test$species==sp,"wai.up"]=thsd$margin.val["humid-midhum","diff"]
    }
  }
}
# 1 h>m>c
# 2 h>m=c
# 3 h=m>c
# 4 m>c & m>h
# 5 m<c & m<h
# 6 m=c=h
# 7 h<m=c
# 8 h=m<c
# 9 h<m<c

margin.test |> 
  mutate(fec.sgdd=case_when(sgdd.up>0&sgdd.low<0~1,
                           sgdd.up>0&is.na(sgdd.low)~2,
                           is.na(sgdd.up)&sgdd.low<0~3,
                           sgdd.up<0&sgdd.low<0~4,
                           sgdd.up>0&sgdd.low>0~5,
                           is.na(sgdd.up)&is.na(sgdd.low)~6,
                           sgdd.up<0&is.na(sgdd.low)~7,
                           is.na(sgdd.up)&sgdd.low>0~8,
                           sgdd.up<0&sgdd.low>0~9)) |>
  mutate(fec.wai=case_when(wai.up>0&wai.low<0~1,
                           wai.up>0&is.na(wai.low)~2,
                           is.na(wai.up)&wai.low<0~3,
                           wai.up<0&wai.low<0~4,
                           wai.up>0&wai.low>0~5,
                           is.na(wai.up)&is.na(wai.low)~6,
                           wai.up<0&is.na(wai.low)~7,
                           is.na(wai.up)&wai.low>0~8,
                           wai.up<0&wai.low>0~9)) |>
  ggplot(aes(as.factor(fec.wai)))+geom_bar()


# as.data.frame(table(margin.test$fec.wai))$Freq
# chisq.test(as.data.frame(table(margin.test$fec.wai))$Freq)
# sgdd.zone.eu |> 
#   left_join(margin.test) |> 
#   select(species,margin.sgdd,mean.sgdd,sgdd.dif,sgdd.up,sgdd.low,zone)->test.lm
# 
# summary(lm(sgdd.up~mean.sgdd,data=test.lm |> filter(margin.sgdd=="hot")))
# 
# test.lm |> 
#   filter(margin.sgdd=="hot") |> 
#   ggplot(aes(mean.sgdd,sgdd.up))+
#   geom_point()+
#   geom_smooth()
```


### America

```{r}
sp.dataset=fecundity.am_clim |>
  filter(BA!=0) |> 
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> 
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=1/cv_plot, prob=0.05)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=1/cv_plot, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=1/cv_plot, prob=0.475)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=1/cv_plot, prob=0.95)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=1/cv_plot, prob=0.05)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=1/cv_plot, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=1/cv_plot, prob=0.475)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=1/cv_plot, prob=0.95)[[1]]~"humid")) |> 
  pivot_longer(cols=c("margin.sgdd","margin.wai"),
               names_to="margin.type",
               values_to="margin.val") |> 
  filter(!is.na(margin.val)) |> 
  ungroup() |> 
  mutate(margin.val=factor(margin.val,levels=c("midtemp","cold","hot","midhum","arid","humid"))) |> 
  as.data.table()

sp.dataset |> 
  left_join(dist.test) |> 
  mutate(signif.clim=clim.pval<0.05) |> 
  ggplot()+
  geom_boxplot(aes(margin.val,ISP,weight=cv_plot,color=signif.clim,fill=margin.type),outlier.colour = NA)+
  # geom_density(aes(x=ISP,y=..density..,weight=cv_plot,color=margin))+
  facet_wrap(~species,scales="free")+
  scale_y_log10()+
  scale_colour_manual(values=c("grey","black"))

sp.dataset |> 
  pivot_wider(names_from = margin.type,
              values_from = margin.val) |> 
  count(margin.sgdd,margin.wai) |> 
  ggplot(aes(margin.sgdd,margin.wai,fill=log(n)))+
  geom_tile()

# car::Anova(lm(ISP~species*margin.val,data=sp.dataset |> filter(margin.type=="margin.sgdd")))
```


```{r}
# save eu data somewhere
margin.test.eu=margin.test

# sp="abiesAlba"       
margin.test=rbind(margin.test,
                  data.frame(species=unique(fecundity.am_clim$species),
                       sgdd.dif=FALSE,
                       sgdd.up=NA,
                       sgdd.low=NA,
                       wai.dif=FALSE,
                       wai.up=NA,
                       wai.low=NA,
                       zone="america")) |> 
    left_join(dist.test) |>   mutate(signif.clim=clim.pval<0.05) 
for (sp in unique(fecundity.am_clim$species)){
  print(sp)
  df.sp=sp.dataset|> 
    filter(species==sp) |> 
    mutate(ISP=scale(log(ISP))) |>
    as.data.table()
  mod=aov(lm(ISP~margin.val,data=df.sp[margin.type=="margin.sgdd"],weights=1/cv_plot))
  if(summary(mod)[[1]]$`Pr(>F)`[1]<0.001){
    margin.test[margin.test$species==sp,"sgdd.dif"]=TRUE
    thsd=TukeyHSD(mod,"margin.val")
    if(thsd$margin.val["hot-midtemp","p adj"]<0.05){
      margin.test[margin.test$species==sp,"sgdd.up"]=thsd$margin.val["hot-midtemp","diff"]
    }
    if(thsd$margin.val["cold-midtemp","p adj"]<0.05){
      margin.test[margin.test$species==sp,"sgdd.low"]=thsd$margin.val["cold-midtemp","diff"]
    }
  }
  mod=aov(lm(ISP~margin.val,data=df.sp[margin.type=="margin.wai"],weights=1/cv_plot))
  if(summary(mod)[[1]]$`Pr(>F)`[1]<0.001){
    margin.test[margin.test$species==sp,"wai.dif"]=TRUE
    thsd=TukeyHSD(mod,"margin.val")
    if(thsd$margin.val["arid-midhum","p adj"]<0.05){
      margin.test[margin.test$species==sp,"wai.low"]=thsd$margin.val["arid-midhum","diff"]
    }
    if(thsd$margin.val["humid-midhum","p adj"]<0.05){
      margin.test[margin.test$species==sp,"wai.up"]=thsd$margin.val["humid-midhum","diff"]
    }
  }
}
# 1 h>m>c
# 2 h>m=c
# 3 h=m>c
# 4 m>c & m>h
# 5 m<c & m<h
# 6 m=c=h
# 7 h<m=c
# 8 h=m<c
# 9 h<m<c
margin.test |> 
  mutate(fec.sgdd=case_when(sgdd.up>0&sgdd.low<0~1,
                           sgdd.up>0&is.na(sgdd.low)~2,
                           is.na(sgdd.up)&sgdd.low<0~3,
                           sgdd.up<0&sgdd.low<0~4,
                           sgdd.up>0&sgdd.low>0~5,
                           is.na(sgdd.up)&is.na(sgdd.low)~6,
                           sgdd.up<0&is.na(sgdd.low)~7,
                           is.na(sgdd.up)&sgdd.low>0~8,
                           sgdd.up<0&sgdd.low>0~9)) |>
  mutate(fec.wai=case_when(wai.up>0&wai.low<0~1,
                           wai.up>0&is.na(wai.low)~2,
                           is.na(wai.up)&wai.low<0~3,
                           wai.up<0&wai.low<0~4,
                           wai.up>0&wai.low>0~5,
                           is.na(wai.up)&is.na(wai.low)~6,
                           wai.up<0&is.na(wai.low)~7,
                           is.na(wai.up)&wai.low>0~8,
                           wai.up<0&wai.low>0~9)) |>
  ggplot(aes(as.factor(fec.sgdd),fill=zone))+geom_bar(position="dodge")
rm(margin.test.eu,mod,thsd,sp,df.sp,sp.dataset)
```

## analysis all species together

```{r}
# all together, color = continent
margin.test |>
  mutate(across(c("sgdd.up","sgdd.low"),
                ~if_else(is.na(.x),0,.x))) |> 
  ggplot(aes(color=zone))+
  geom_segment(aes(x=0,y=0,xend=sgdd.low,yend=sgdd.up),arrow = arrow(length = unit(0.3,"cm")))+
  geom_text(aes(label=species, x=sgdd.low,y=sgdd.up))+
  coord_equal()


# color by climate, sgdd
margin.test |>
  left_join(species_selection$df.gbif)  |> 
  separate(clim,into=c("clim","quant")) |> 
  filter(quant=="opt") |> select(-quant) |>
  mutate(across(c("sgdd.up","sgdd.low"),
                ~if_else(is.na(.x),0,.x))) |> 
  group_by(clim) |> mutate(clim_niche=scale(clim_niche)) |> 
  ggplot(aes(color=clim_niche))+
  geom_segment(aes(x=0,y=0,xend=sgdd.low,yend=sgdd.up),arrow = arrow(length = unit(0.3,"cm")))+
  geom_text(aes(label=species, x=sgdd.low,y=sgdd.up))+
  coord_equal()+
    scale_color_gradientn(colours = viridis(15))+
  facet_wrap(~clim)

# color by climate, wai
margin.test |>
  left_join(species_selection$df.gbif)  |> 
  separate(clim,into=c("clim","quant")) |> 
  filter(quant=="opt") |> select(-quant) |>
  mutate(across(c("wai.up","wai.low"),
                ~if_else(is.na(.x),0,.x))) |> 
  group_by(clim) |> mutate(clim_niche=scale(clim_niche)) |> 
  ggplot(aes(color=clim_niche))+
  geom_segment(aes(x=0,y=0,xend=wai.low,yend=wai.up),arrow = arrow(length = unit(0.3,"cm")))+
  geom_text(aes(label=species, x=wai.low,y=wai.up))+
  coord_equal()+
    scale_color_gradientn(colours = viridis(15))+
  facet_wrap(~clim)

# color by range width, sgdd
cowplot::plot_grid(
  plotlist = lapply(X=c("map","mat","tmin"),
                    function(x){
                      p=margin.test |>
                        mutate(across(c("sgdd.up","sgdd.low"),
                                      ~if_else(is.na(.x),0,.x))) |>
                        left_join(species_selection$df.gbif)  |>
                        separate(clim,into=c("var","quant")) |>
                        left_join(df.range) |>
                        filter(quant=="opt") |> select(-quant) |>
                        mutate(range=abs(range/clim_niche)) |> select(-clim_niche) |>
                        filter(var==x) |> 
                        ggplot(aes(color=range))+
                        geom_point(aes(x=sgdd.low,y=sgdd.up),size=2)+
                        # geom_segment(aes(x=0,y=0,xend=sgdd.low,yend=sgdd.up),arrow = arrow(length = unit(0.3,"cm")))+
                        # geom_text(aes(label=species, x=sgdd.low,y=sgdd.up))+
                        coord_equal()+
                        scale_color_viridis(option="C",trans="log")+
                        ggtitle(label = x)
                      return(p)
                      }
                    ),
  ncol=3
  )


margin.test|>
  mutate(across(c("sgdd.up","sgdd.low"),
                ~if_else(is.na(.x),0,.x))) |> 
  ggplot(aes(x=sgdd.low,y=sgdd.up))+
  # stat_density_2d(aes(fill = stat(level)),
  #                 geom = "polygon", 
  #                 n = 100 ,
  #                 bins = 10) + 
  stat_density_2d(aes(fill = ..level..), geom = "polygon")+
  geom_point(aes(color=zone),position=position_jitter(width = 0.1, height = 0.1))+
  scale_fill_viridis(option = "D")+
  coord_equal()

cluster=kmeans(margin.test|>
         mutate(across(c("sgdd.up","sgdd.low"),
                       ~if_else(is.na(.x),0,.x))) |> 
         select(sgdd.up,sgdd.low),
       3)$cluster

margin.test |> 
  mutate(across(c("sgdd.up","sgdd.low"),
              ~if_else(is.na(.x),0,.x))) |>
  left_join(species.phylo[,c("species","taxa")]) |> 
  left_join(dist.test) |> 
  cbind(cluster=as.factor(cluster)) |> 
  ggplot(aes(x=sgdd.low,y=sgdd.up,color=signif.clim))+ #cluster # taxa
  # stat_density_2d(aes(fill = stat(level)),
  #                 geom = "polygon", 
  #                 n = 100 ,
  #                 bins = 10) + 
  geom_point(position=position_jitter(width = 0.07, height = 0.07))+
  stat_ellipse()+
  coord_equal()

margin.test |> 
  pivot_longer(cols=c("sgdd.up","sgdd.low","wai.up","wai.low")) |> 
  mutate(across(value,
            ~if_else(is.na(.x),0,.x))) |> 
  group_by(name) |> 
  mutate(median=mean(value)) |> 
  left_join(species.phylo[,c("species","taxa")]) |> 
  ggplot(aes(value,color=zone))+
  geom_density()+
  geom_vline(aes(xintercept = median))+
  facet_wrap(~name)

# test des distribtuibs
margin.test |> 
  mutate(fec.sgdd=case_when(sgdd.up>0&sgdd.low<0~1,
                           sgdd.up>0&is.na(sgdd.low)~2,
                           is.na(sgdd.up)&sgdd.low<0~3,
                           sgdd.up<0&sgdd.low<0~4,
                           sgdd.up>0&sgdd.low>0~5,
                           is.na(sgdd.up)&is.na(sgdd.low)~6,
                           sgdd.up<0&is.na(sgdd.low)~7,
                           is.na(sgdd.up)&sgdd.low>0~8,
                           sgdd.up<0&sgdd.low>0~9)) |>
  mutate(fec.wai=case_when(wai.up>0&wai.low<0~1,
                           wai.up>0&is.na(wai.low)~2,
                           is.na(wai.up)&wai.low<0~3,
                           wai.up<0&wai.low<0~4,
                           wai.up>0&wai.low>0~5,
                           is.na(wai.up)&is.na(wai.low)~6,
                           wai.up<0&is.na(wai.low)~7,
                           is.na(wai.up)&wai.low>0~8,
                           wai.up<0&wai.low>0~9)) ->margin.test


as.data.frame(table(margin.test$fec.wai))$Freq
chisq.test(as.data.frame(table(margin.test$fec.sgdd))$Freq)
chisq.test(as.data.frame(table(margin.test$fec.wai))$Freq)

```


Conclusion : On observe une répartition dans les 9 classes de sgdd et wai différentes de ce qui aurait été observé par hasard.  2 grandes tendances se détachent. D'une part pour un grand pool d'espèce, la fécondité ne varie pas dans la distribution. D'autre part, pour la grande majorité des espcèces où une variation est visible, on observe que la fécondité tend a diminuer vers la marge froide et augmenter vers la marge chaude.
Pas de différence falgrante entre gymnospermes/angiospermes/


## Disentangling fecundity variation

Question subsidiaires:
- les variations sont-elles plus importantes sur l'une ou l'autre des dimensions climatiques?


- les variations vont-elles davantage dans un sens ? 
-> il smeble que la fecundité diminue dans la marge froide de manière systématique. par clair pour les autres marges.

- les varaitions s'expliquent-elles par des caractéristiques des distributions (climat moyen associé a la dimension climatique, largeur de la niche acp?)
-> uniquement la largeur du range permet d'expliquer un peu la variation de sgdd.up


- par des traits (ie. stratégies de croissance? shade tolerance)?

### clim
```{r}
# test if variation are significantly different from zero
t.test(margin.test$sgdd.low)
t.test(margin.test$sgdd.up)
t.test(margin.test$wai.low)
t.test(margin.test$wai.up)

# compute niche characteristcis
rbind(fecundity.am_clim,
      fecundity.eu_clim)|>
  filter(BA!=0) |> 
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> 
  # compute mean clim per species
  mutate(sgdd.range=weighted.quantile(sgdd,w=1/cv_plot, prob=0.95)[[1]]-weighted.quantile(sgdd,w=1/cv_plot, prob=0.05)[[1]],
         wai.range=weighted.quantile(wai,w=1/cv_plot, prob=0.95)[[1]]-weighted.quantile(wai,w=1/cv_plot, prob=0.05)[[1]],
         sgdd.mean=weighted.mean(sgdd,w=1/cv_plot,na.rm=TRUE)[[1]],
         wai.mean=weighted.mean(wai,w=1/cv_plot,na.rm=TRUE)[[1]]
         ) |> 
  # compute margins
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=1/cv_plot, prob=0.05)[[1]]~"cold",
                             sgdd<weighted.quantile(sgdd,w=1/cv_plot, prob=0.525)[[1]]&
                               sgdd>weighted.quantile(sgdd,w=1/cv_plot, prob=0.475)[[1]]~"midtemp",
                             sgdd>weighted.quantile(sgdd,w=1/cv_plot, prob=0.95)[[1]]~"hot"),
        margin.wai=case_when(wai<weighted.quantile(wai,w=1/cv_plot, prob=0.05)[[1]]~"arid",
                            wai<weighted.quantile(wai,w=1/cv_plot, prob=0.525)[[1]]&
                               wai>weighted.quantile(wai,w=1/cv_plot, prob=0.475)[[1]]~"midhum",
                             wai>weighted.quantile(wai,w=1/cv_plot, prob=0.95)[[1]]~"humid")) |> 
  pivot_longer(cols=c("margin.sgdd","margin.wai"),
               names_to="margin.type",
               values_to="margin.val") |> 
  filter(!is.na(margin.val)) |> 
  ungroup() |> group_by(species,margin.val) |> 
  # compute mean per species and margins
  mutate(margin.sgdd=weighted.mean(sgdd,w=1/cv_plot,na.rm=TRUE)[[1]],
         margin.wai=weighted.mean(wai,w=1/cv_plot,na.rm=TRUE)[[1]]) |> 
  select(species,sgdd.range,sgdd.mean,wai.range,wai.mean,margin.type,margin.val,margin.sgdd,margin.wai) |> 
  ungroup() |> 
  unique() |> 
  left_join(margin.test) |> 
  mutate(across(c("sgdd.up","sgdd.low","wai.up","wai.low"),
                       ~if_else(is.na(.x),0,.x))) |> 
  left_join(species.phylo[,c("species","taxa")])-> test.lm
sp.dataset |> 
  pivot_wider(names_from = margin.type,
              values_from = margin.val) |> 
  filter(!is.na(margin.sgdd)) |>
  group_by(species,margin.sgdd) |> 
  summarise(mean.sgdd=mean(sgdd)) -> sgdd.zone.am

sgdd.zone.am |> 
  left_join(margin.test) |> 
  select(species,margin.sgdd,mean.sgdd,sgdd.dif,sgdd.up,sgdd.low,zone)->test.lm
library(car)
anova(lm(sgdd.up~sgdd.mean,data=test.lm |> select(taxa,sgdd.up,sgdd.mean) |> unique()))
anova(lm(sgdd.up~sgdd.range*taxa,data=test.lm |> select(taxa,sgdd.up,sgdd.range) |> unique()))
anova(lm(sgdd.low~sgdd.mean,data=test.lm |> select(taxa,sgdd.low,sgdd.mean) |> unique()))
anova(lm(sgdd.low~sgdd.range,data=test.lm |> select(taxa,sgdd.low,sgdd.range) |> unique()))
anova(lm(sgdd.up~margin.sgdd,data=test.lm |> filter(margin.val=="hot") |> select(taxa,sgdd.up,margin.sgdd) |> unique()))
anova(lm(sgdd.low~margin.sgdd,data=test.lm |> filter(margin.val=="cold") |> select(taxa,sgdd.low,margin.sgdd) |> unique()))

anova(lm(wai.up~wai.mean,data=test.lm |> select(wai.up,wai.mean) |> unique()))
anova(lm(wai.up~wai.range,data=test.lm |> select(wai.up,wai.range) |> unique()))
anova(lm(wai.low~wai.mean,data=test.lm |> select(wai.low,wai.mean) |> unique()))
anova(lm(wai.low~wai.range,data=test.lm |> select(wai.low,wai.range) |> unique()))
anova(lm(wai.up~margin.wai,data=test.lm |> filter(margin.val=="hot") |> select(wai.up,margin.wai) |> unique()))
anova(lm(wai.low~margin.wai,data=test.lm |> filter(margin.val=="cold") |> select(wai.low,margin.wai) |> unique()))


test.lm |>
  select(sgdd.up,sgdd.range) |> unique() |> 
  # filter(sgdd.up!=0) |> 
  ggplot(aes(sgdd.up,sgdd.range))+
  geom_point()+
  geom_smooth(method="lm")
```
### traits

```{r}
try.traits<-read.csv2("data/TRY/Species_mean_traits.csv") |> 
  filter(Species.name.standardized.against.TPL %in% unique(species_selection$df.gbif$species_l)) |>
  separate(Species.name.standardized.against.TPL,into=c("genus","sp"),sep=" ",remove=FALSE) |> 
  mutate(species=paste0(substr(tolower(genus),1,8),substr(str_to_title(sp),1,8))) |> 
  select(-genus) |> 
  rename_all(tolower) |> 
  rename(leaf.area=leaf.area..mm2.,
         leaf.area.n=leaf.area..n.o..,
         nmass=nmass..mg.g.,
         nmass.n=nmass..n.o..,
         lma=lma..g.m2.,
         lma.n=lma..n.o..,
         plant.height=plant.height..m.,
         plant.height.n=plant.height..n.o..,
         diaspore.mass=diaspore.mass..mg.,
         diaspore.mass.n=diaspore.mass..n.o..,
         ssd=ssd.observed..mg.mm3.,
         ssd.n=ssd..n.o..,
         ldmc=ldmc..g.g.,
         ldmc.n=ldmc..n.o..,
         ssd.imputed=ssd.imputed..mg.mm3.,
         ssd.combined=ssd.combined..mg.mm3.,
         n.trait=number.of.traits.with.values) |> 
  select(species,family,phylogenetic.group.general,growth.form,leaf.type,leaf.area,nmass,lma,plant.height,ssd)


margin.test |>
  # mutate(across(c("sgdd.up","sgdd.low","wai.up","wai.low"),
  #                      ~if_else(is.na(.x),0,.x))) |> 
  left_join(try.traits) |>
  pivot_longer(cols=c("leaf.area","nmass","lma","plant.height","ssd"),
               names_to = "traits",
               values_to = "traits.val") |> 
  pivot_longer(col=c("sgdd.up","sgdd.low","wai.up","wai.low"),
               names_to = "margin.dist",
               values_to = "margin.dist.val") |> 
  ggplot(aes(margin.dist.val,traits.val,color=phylogenetic.group.general))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(margin.dist~traits,scales="free")



margin.test |>
  # mutate(across(c("sgdd.up","sgdd.low","wai.up","wai.low"),
  #                      ~if_else(is.na(.x),0,.x))) |> 
  left_join(try.traits) |>
  pivot_longer(cols=c("phylogenetic.group.general","growth.form","leaf.type"),
               names_to = "traits",
               values_to = "traits.val") |> 
  pivot_longer(col=c("sgdd.up","sgdd.low","wai.up","wai.low"),
               names_to = "margin.dist",
               values_to = "margin.dist.val") |> 
  ggplot(aes(margin.dist.val,traits.val))+
  geom_boxplot()+
  geom_smooth(method="lm")+
  facet_wrap(margin.dist~traits,scales="free")

for (margin in c("sgdd.up","sgdd.low","wai.up","wai.low")){
  print(margin)
  for (trait in c("leaf.area","nmass","lma","plant.height","ssd")){
    print(trait)
    margin.test |>
      left_join(try.traits) |>
      pivot_longer(cols=c("leaf.area","nmass","lma","plant.height","ssd"),
                   names_to = "traits",
                   values_to = "traits.val") |> 
      pivot_longer(col=c("sgdd.up","sgdd.low","wai.up","wai.low"),
               names_to = "margin.dist",
               values_to = "margin.dist.val") |> 
      filter(traits==trait & margin.dist==margin) -> df.lm
    print(anova(lm(margin.dist.val~phylogenetic.group.general*traits.val,data=df.lm)))
  }
}
```

# Linear mixed model

```{r}
sp.dataset=rbind(fecundity.eu_clim |> mutate(zone="europe"),
                 fecundity.am_clim|> mutate(zone="america")) |>
  filter(BA!=0) |> #rm absences
  group_by(species) |> 
  mutate(cv_plot=if_else(is.na(cv_plot),mean(cv_plot,na.rm=TRUE),cv_plot)) |> # compute cv for missing values
  mutate(margin.sgdd=case_when(sgdd<weighted.quantile(sgdd,w=1/cv_plot, prob=0.05)[[1]]~"cold",
                               sgdd<weighted.quantile(sgdd,w=1/cv_plot, prob=0.525)[[1]]&
                                 sgdd>weighted.quantile(sgdd,w=1/cv_plot, prob=0.475)[[1]]~"midtemp",
                               sgdd>weighted.quantile(sgdd,w=1/cv_plot, prob=0.95)[[1]]~"hot"),
         margin.wai=case_when(wai<weighted.quantile(wai,w=1/cv_plot, prob=0.05)[[1]]~"arid",
                              wai<weighted.quantile(wai,w=1/cv_plot, prob=0.525)[[1]]&
                                 wai>weighted.quantile(wai,w=1/cv_plot, prob=0.475)[[1]]~"midhum",
                               wai>weighted.quantile(wai,w=1/cv_plot, prob=0.95)[[1]]~"humid"),
         cor.wai.sgdd=cor(wai,sgdd,use="complete.obs")) |> 
  pivot_longer(cols=c("margin.sgdd","margin.wai"),
               names_to="margin.type",
               values_to="margin.val") |> 
  filter(!is.na(margin.val)) |> 
  ungroup() |> 
  mutate(margin.val=factor(margin.val,levels=c("midtemp","cold","hot","midhum","arid","humid")),
         ISP=scale(ISP)) |> 
  as.data.table() 

# fit mixed model
library(lme4)
sp.mod=sp.dataset |> filter(margin.type=="margin.sgdd")
mod.fec.margin=lm(ISP~species+ species:margin.val,data=sp.mod)
summary=as.data.frame(summary(mod.fec.margin)$coefficients)
summary |> 
  tibble::rownames_to_column(var="species") |> 
  filter(grepl(":",species)) |> 
  separate(species,into=c("species","margin"),sep=":") |> 
  mutate(species=str_sub(species,8,-1)) |> 
  arrange(species) |> 
  group_by(species) |>
  select(species,margin,Estimate,`Std. Error`) |> 
  rename(mean=Estimate,
         sd=`Std. Error`) |> 
  pivot_wider(names_from = margin,
              values_from = c("mean","sd")) |> 
  ggplot(aes(mean_margin.valcold,mean_margin.valhot,col=species))+
  geom_point()+
  geom_errorbarh(aes(xmin=mean_margin.valcold-sd_margin.valcold,
                     xmax=mean_margin.valcold+sd_margin.valcold))+
  geom_errorbar(aes(ymin=mean_margin.valhot-sd_margin.valhot,
                     ymax=mean_margin.valhot+sd_margin.valhot))+
  coord_equal()+
  theme(legend.position = "none")

sp.mod=sp.dataset |> filter(margin.type=="margin.wai")
mod.fec.margin=lm(ISP~species+ species:margin.val,data=sp.mod)
summary=as.data.frame(summary(mod.fec.margin)$coefficients)
summary |> 
  tibble::rownames_to_column(var="species") |> 
  filter(grepl(":",species)) |> 
  separate(species,into=c("species","margin"),sep=":") |> 
  mutate(species=str_sub(species,8,-1)) |> 
  arrange(species) |> 
  group_by(species) |>
  select(species,margin,Estimate,`Std. Error`) |> 
  rename(mean=Estimate,
         sd=`Std. Error`) |> 
  pivot_wider(names_from = margin,
              values_from = c("mean","sd")) |> 
  ggplot(aes(mean_margin.valarid,mean_margin.valhumid,col=species))+
  geom_point()+
  geom_errorbarh(aes(xmin=mean_margin.valarid-sd_margin.valarid,
                     xmax=mean_margin.valarid+sd_margin.valarid))+
  geom_errorbar(aes(ymin=mean_margin.valhumid-sd_margin.valhumid,
                     ymax=mean_margin.valhumid+sd_margin.valhumid))+
  coord_equal()+
  theme(legend.position = "none")
```




# Improvement :
- weight by uncertainty
- sensitivity to quantiles delineation
- plot margins


## Compute statistics of presence per specie
```{r}
fecundity.eu_clim |> 
  filter(species %in% sp.select.eu) |> 
  filter(BA!=0) |> 
  group_by(species) |> 
  summarise(n=n()) |> arrange(n)
```
## Bootstrap like
Idée : pour chaque espèce, sampling aléatoire d'un nombre n d'individus (ou d'un pourcentage du dataset), petit. Extraction des valeurs de ISP associés au quant975, 025 et 50 de PC1

```{r eval=FALSE, include=FALSE}
df.raw<-data.frame(species=NA,
                   BA=NA,
                   fecGmMu=NA,
                   fecGmSd=NA,
                   name=NA)

for (i in 1:500){
  print(i)
  try<-fecundity |> 
    select(plot,species,BA,fecGmMu,fecGmSd,lon,lat,PC1) |> 
    filter(BA!=0) |> 
    group_by(species) |> 
    sample_frac(0.1) |>
    mutate(quant95=abs(PC1-quantile(PC1,probs=0.95,na.rm=TRUE)[[1]]),
           quant5=abs(PC1-quantile(PC1,probs=0.5,na.rm=TRUE)[[1]]),
           quant05=abs(PC1-quantile(PC1,probs=0.05,na.rm=TRUE)[[1]])) |>
    pivot_longer(cols=c("quant95","quant5","quant05")) |> 
    ungroup() |> group_by(species,name) |> slice(which.min(value)) |> 
    select(species,BA,fecGmMu,fecGmSd,name)
  df.raw=rbind(df.raw,try)
}

df.raw |> 
  filter(!is.na(species)) |> 
  mutate(fecGmCv=100*fecGmSd/fecGmMu,
         ISP=fecGmMu/BA) |> 
  ggplot()+
  geom_density(aes(x=ISP,y=..density..,weight=fecGmCv,color=name))+
  facet_wrap(~species,scales="free")+
  scale_x_log10()+
  theme_minimal()

  
```

## sensitivity to quantiles
```{r eval=FALSE, include=FALSE}
prob.low=seq(0.01,0.47,0.01)
prob.high=seq(0.99,0.53,-0.01)
sensibility<-data.frame(species=unique(fecundity$species),
                        low.mid=NA,
                        low.high=NA,
                        high.mid=NA,
                        low.mid.sd=NA,
                        low.high.sd=NA,
                        high.mid.sd=NA) |> crossing(i=1:47)
for (i in 1:47){
  print(i)
  clim_i=BA_select |> 
    filter(!species%in%c("sorbusAucupari","sorbusAucuparia","cedrusAtlantic")) |> 
    filter(BA!=0) |> 
    group_by(species) |> 
    summarise(quant.high=quantile(PC1,probs=prob.high[i],na.rm=TRUE)[[1]],
              quant525=quantile(PC1,probs=0.525,na.rm=TRUE)[[1]],
              quant475=quantile(PC1,probs=0.475,na.rm=TRUE)[[1]],
              quant.low=quantile(PC1,probs=prob.low[i],na.rm=TRUE)[[1]])
  fecundity_i<-fecundity |> 
    select(plot,species,fecGmMu,fecGmSd,PC1,BA) |> 
    left_join(clim_i)|> 
    mutate(fecGmCv=100*fecGmSd/fecGmMu,
           ISP=fecGmMu/BA,
           margin=case_when(PC1<quant.low~"low",
                          PC1>quant475&PC1<quant525~"opt",
                          PC1>quant.high~"up",
                          TRUE~NA)) |> 
    filter(!is.na(margin)) |>
    filter(ISP!=0 | BA !=0) |>
    filter(!is.nan(fecGmCv))
  for (sp in unique(clim_i$species)){
    fecundity_i |> filter(species==sp)->test
    sensibility[sensibility$species==sp&sensibility$i==i,c("low.mid","low.high","high.mid")]=
      list(
        t.test(test[test$margin=="low","ISP"],test[test$margin=="opt","ISP"])$p.value,
        t.test(test[test$margin=="low","ISP"],test[test$margin=="up","ISP"])$p.value,
        t.test(test[test$margin=="up","ISP"],test[test$margin=="opt","ISP"])$p.value
      )
  }
  }
sensibility |> 
  pivot_longer(cols=c("low.mid","low.high","high.mid")) |> 
  ggplot(aes(i,value,color=name))+
    geom_line()+
    facet_wrap(~species)
```


# Annexe 


Check data for steph
```{r eval=FALSE, include=FALSE}
plotData |> 
  filter(lat>48&lat<50) |> 
  filter(lon<18&lon>12) -> czplot

cztree<- as.data.frame(BA)|> 
  rownames_to_column(var="plot") |> 
  filter(plot %in% czplot$plot) |> 
  pivot_longer(cols=-plot,
               names_to = "species",
               values_to = "BA") |> 
  filter(BA>0)

cztree |> 
  group_by(plot,species) |> summarise(n=n())
cztree |> 
  # filter(plot%in% mono$plot) |>  
  group_by(species) |> 
  summarise(n=n()) |> arrange(n)
cztree |> select(plot,species) |> distinct() |> group_by(plot) |> summarise(n=n()) |> filter(n<2)->mono
```